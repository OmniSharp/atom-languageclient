"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
/**
 *
 */
var _ = require('lodash');
var rxjs_1 = require('rxjs');
var View_1 = require('./View');
atom.themes.requireStylesheet(require.resolve('../../../styles/select-list.less'));
var SelectListView = (function (_super) {
    __extends(SelectListView, _super);
    function SelectListView(commands) {
        var _this = this;
        _super.call(this, document.createElement('div'));
        this._items = [];
        this._weakMap = new WeakMap();
        this._maxItems = Infinity;
        this._inputThrottle = 100;
        this._commands = commands;
        this._buildHtml();
        this._filterEditor = this._filterEditorView.getModel();
        this._disposable.add(rxjs_1.Observable.fromEvent(this._filterEditorView, 'blur')
            .subscribe(function () {
            if (!document.hasFocus() && !_this._cancelling) {
                _this.cancel();
            }
        }), commands.add(this.root, {
            'core:move-up': function (event) {
                _this.selectPreviousItem();
                event.stopPropagation();
            },
            'core:move-down': function (event) {
                _this.selectNextItem();
                event.stopPropagation();
            },
            'core:move-to-top': function (event) {
                _this.selectFirstItem();
                _this.scrollToTop(_this._list);
                event.stopPropagation();
            },
            'core:move-to-bottom': function (event) {
                _this.selectLastItem();
                _this.scrollToBottom(_this._list);
                event.stopPropagation();
            },
            'core:confirm': function (event) {
                _this._confirmSelection();
                event.stopPropagation();
            },
            'core:cancel': function (event) {
                _this.cancel();
                event.stopPropagation();
            }
        }), rxjs_1.Observable.fromEvent(this._list, 'mousedown')
            .subscribe(function (e) {
            if (e.target.tagName === 'li') {
                _this._selectItem(e.target);
                e.preventDefault();
                return false;
            }
            return;
        }), rxjs_1.Observable.fromEvent(this._list, 'mouseup')
            .subscribe(function (e) {
            if (e.target.tagName === 'li') {
                if (e.target.classList.contains('selected')) {
                    _this._confirmSelection();
                }
                e.preventDefault();
                return false;
            }
            return;
        }), rxjs_1.Observable.fromEvent(this._list, 'mousedown')
            .subscribe(function (_a) {
            var target = _a.target;
            if (target === _this._list) {
                return false;
            }
            return;
        }));
    }
    SelectListView.prototype.setItems = function (items) {
        this._items = items != null ? items : [];
        this.populateList();
        return this.setLoading();
    };
    Object.defineProperty(SelectListView.prototype, "selected", {
        get: function () {
            return this._weakMap.get(this._getSelectedItem());
        },
        enumerable: true,
        configurable: true
    });
    SelectListView.prototype.getFilterQuery = function () {
        return this._filterEditor.getText();
    };
    SelectListView.prototype.setMaxItems = function (maxItems) {
        this._maxItems = maxItems;
    };
    SelectListView.prototype.populateList = function () {
        this.populateItems(_.map(this._items, function (item) { return ({ item: item }); }));
    };
    SelectListView.prototype.populateItems = function (items) {
        if (items == null) {
            return;
        }
        /* tslint:disable-next-line:no-inner-html */
        this._list.innerHTML = '';
        if (items.length) {
            this.setError(undefined);
            for (var _i = 0, _a = _.take(items, _.min([items.length, this._maxItems])); _i < _a.length; _i++) {
                var item = _a[_i];
                var view = this.viewForItem(item);
                this._weakMap.set(view, item.item);
                this._list.appendChild(view);
            }
            return this._selectItem(this._list.firstElementChild);
        }
        else {
            return this.setError(this.getEmptyMessage(this._items.length, items.length));
        }
    };
    SelectListView.prototype.setError = function (message) {
        if (message == null) {
            message = '';
        }
        if (message.length === 0) {
            this._error.innerText = '';
            this.hide(this._error);
        }
        else {
            this.setLoading();
            this._error.innerText = message;
            this.show(this._error);
        }
    };
    SelectListView.prototype.setLoading = function (message) {
        if (message == null) {
            message = '';
        }
        if (message.length === 0) {
            this._loading.innerText = '';
            this._loadingBadge.innerText = '';
            return this.hide(this._loadingArea);
        }
        else {
            this.setError();
            this._loading.innerText = message;
            return this.show(this._loadingArea);
        }
    };
    SelectListView.prototype.getEmptyMessage = function (itemCount, filteredItemCount) {
        return 'No matches found';
    };
    /*
    Section: View Actions
     */
    SelectListView.prototype.cancel = function () {
        this.empty(this._list);
        this._cancelling = true;
        var filterEditorViewFocused = this.hasFocus(this._filterEditorView);
        this.cancelled();
        this._filterEditor.setText('');
        if (filterEditorViewFocused) {
            this._restoreFocus();
        }
        this._cancelling = false;
        clearTimeout(this._scheduleTimeout);
        this.dispose();
    };
    SelectListView.prototype.focusFilterEditor = function () {
        return this._filterEditorView.focus();
    };
    SelectListView.prototype.storeFocusedElement = function () {
        /* tslint:disable-next-line:no-any */
        return this._previouslyFocusedElement = document.activeElement;
    };
    SelectListView.prototype.selectFirstItem = function () {
        return this._selectItem(this._list.firstElementChild);
    };
    SelectListView.prototype.selectLastItem = function () {
        return this._selectItem(this._list.lastElementChild);
    };
    SelectListView.prototype.selectPreviousItem = function () {
        var view = this._getSelectedItem().previousElementSibling;
        if (!view) {
            view = this._list.lastElementChild;
        }
        return this._selectItem(view);
    };
    SelectListView.prototype.selectNextItem = function () {
        var view = this._getSelectedItem().nextElementSibling;
        if (!view) {
            view = this._list.firstElementChild;
        }
        return this._selectItem(view);
    };
    SelectListView.prototype._selectItem = function (view) {
        var selected = this._list.querySelector('.selected');
        if (selected) {
            selected.classList.remove('selected');
        }
        view.classList.add('selected');
        return this._scrollToItem(view);
    };
    SelectListView.prototype._scrollToItem = function (view) {
        var scrollTop = this._list.scrollTop;
        var desiredTop = view.getBoundingClientRect().top + scrollTop;
        var desiredBottom = desiredTop + view.clientHeight;
        if (desiredTop < scrollTop) {
            this._list.scrollTop = desiredTop;
        }
        else if (desiredBottom > this.scrollBottom(this._list)) {
            this.scrollBottom(this._list, desiredBottom);
        }
    };
    SelectListView.prototype._restoreFocus = function () {
        if (this._previouslyFocusedElement) {
            this._previouslyFocusedElement.focus();
        }
    };
    SelectListView.prototype._getSelectedItem = function () {
        return this._list.querySelector('li.selected');
    };
    SelectListView.prototype._confirmSelection = function () {
        var item = this.selected;
        if (item != null) {
            this.confirmed(item);
            this.dispose();
        }
        else {
            this.cancel();
        }
    };
    SelectListView.prototype.schedulePopulateList = function () {
        var _this = this;
        clearTimeout(this._scheduleTimeout);
        var populateCallback = function () {
            if (document.body.contains(_this.root)) {
                return _this.populateList();
            }
        };
        this._scheduleTimeout = setTimeout(populateCallback, this._inputThrottle);
    };
    SelectListView.prototype._buildHtml = function () {
        this.root.classList.add('select-list');
        /* tslint:disable-next-line:no-any */
        var editor = this._filterEditorView = document.createElement('atom-text-editor');
        /* tslint:disable-next-line:no-any */
        editor.setAttribute('mini', true);
        var errorMessage = this._error = document.createElement('div');
        errorMessage.classList.add('error-message');
        var loading = this._loadingArea = document.createElement('div');
        loading.classList.add('loading');
        var loadingMessage = this._loading = document.createElement('span');
        loadingMessage.classList.add('loading-message');
        var loadingBadge = this._loadingBadge = document.createElement('span');
        loadingBadge.classList.add('badge');
        var listGroup = this._list = document.createElement('ol');
        listGroup.classList.add('list-group');
        this.root.appendChild(editor);
        this.root.appendChild(errorMessage);
        this.root.appendChild(loading);
        loading.appendChild(loadingMessage);
        loading.appendChild(loadingBadge);
        this.root.appendChild(listGroup);
    };
    return SelectListView;
}(View_1.View));
exports.SelectListView = SelectListView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiU2VsZWN0TGlzdFZpZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvYXRvbS92aWV3cy9TZWxlY3RMaXN0Vmlldy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7R0FFRztBQUNILElBQVksQ0FBQyxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQzVCLHFCQUEyQixNQUFNLENBQUMsQ0FBQTtBQUVsQyxxQkFBcUIsUUFBUSxDQUFDLENBQUE7QUFFOUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLGtDQUFrQyxDQUFDLENBQUMsQ0FBQztBQUVuRjtJQUFnRCxrQ0FBb0I7SUFpQmhFLHdCQUFtQixRQUFzQjtRQWpCN0MsaUJBc1NDO1FBcFJPLGtCQUFNLFFBQVEsQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztRQWpCL0IsV0FBTSxHQUFRLEVBQUUsQ0FBQztRQUNuQixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQWtCLENBQUM7UUFDekMsY0FBUyxHQUFXLFFBQVEsQ0FBQztRQVc3QixtQkFBYyxHQUFXLEdBQUcsQ0FBQztRQUtqQyxJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQztRQUMxQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFdkQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQ2hCLGlCQUFVLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxNQUFNLENBQUM7YUFDL0MsU0FBUyxDQUFDO1lBQ1AsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFJLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQztnQkFDNUMsS0FBSSxDQUFDLE1BQU0sRUFBRSxDQUFD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QyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQy9CLE9BQU8sQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDcEMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBQ0wscUJBQUM7QUFBRCxDQUFDLEFBdFNELENBQWdELFdBQUksR0FzU25EO0FBdFNxQixzQkFBYyxpQkFzU25DLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICpcclxuICovXHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBBdG9tQ29tbWFuZHMgfSBmcm9tICcuLi9BdG9tQ29tbWFuZHMnO1xyXG5pbXBvcnQgeyBWaWV3IH0gZnJvbSAnLi9WaWV3JztcclxuXHJcbmF0b20udGhlbWVzLnJlcXVpcmVTdHlsZXNoZWV0KHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vLi4vc3R5bGVzL3NlbGVjdC1saXN0Lmxlc3MnKSk7XHJcblxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgU2VsZWN0TGlzdFZpZXc8VD4gZXh0ZW5kcyBWaWV3PEhUTUxEaXZFbGVtZW50PiB7XHJcbiAgICBwcm90ZWN0ZWQgX2l0ZW1zOiBUW10gPSBbXTtcclxuICAgIHByaXZhdGUgX3dlYWtNYXAgPSBuZXcgV2Vha01hcDxIVE1MRWxlbWVudCwgVD4oKTtcclxuICAgIHByaXZhdGUgX21heEl0ZW1zOiBudW1iZXIgPSBJbmZpbml0eTtcclxuICAgIHByb3RlY3RlZCBfZmlsdGVyRWRpdG9yVmlldzogQXRvbS5UZXh0RWRpdG9yUHJlc2VudGVyO1xyXG4gICAgcHJvdGVjdGVkIF9maWx0ZXJFZGl0b3I6IEF0b20uVGV4dEVkaXRvcjtcclxuICAgIHByaXZhdGUgX2Vycm9yOiBIVE1MRGl2RWxlbWVudDtcclxuICAgIHByaXZhdGUgX2xvYWRpbmdBcmVhOiBIVE1MRGl2RWxlbWVudDtcclxuICAgIHByaXZhdGUgX2xvYWRpbmc6IEhUTUxTcGFuRWxlbWVudDtcclxuICAgIHByaXZhdGUgX2xvYWRpbmdCYWRnZTogSFRNTFNwYW5FbGVtZW50O1xyXG4gICAgcHJpdmF0ZSBfbGlzdDogSFRNTE9MaXN0RWxlbWVudDtcclxuICAgIHByaXZhdGUgX3ByZXZpb3VzbHlGb2N1c2VkRWxlbWVudDogSFRNTEVsZW1lbnQ7XHJcbiAgICBwcml2YXRlIF9jYW5jZWxsaW5nOiBib29sZWFuO1xyXG4gICAgcHJpdmF0ZSBfc2NoZWR1bGVUaW1lb3V0OiBOb2RlSlMuVGltZXI7XHJcbiAgICBwcml2YXRlIF9pbnB1dFRocm90dGxlOiBudW1iZXIgPSAxMDA7XHJcbiAgICBwcm90ZWN0ZWQgX2NvbW1hbmRzOiBBdG9tQ29tbWFuZHM7XHJcblxyXG4gICAgcHVibGljIGNvbnN0cnVjdG9yKGNvbW1hbmRzOiBBdG9tQ29tbWFuZHMpIHtcclxuICAgICAgICBzdXBlcihkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKSk7XHJcbiAgICAgICAgdGhpcy5fY29tbWFuZHMgPSBjb21tYW5kcztcclxuICAgICAgICB0aGlzLl9idWlsZEh0bWwoKTtcclxuICAgICAgICB0aGlzLl9maWx0ZXJFZGl0b3IgPSB0aGlzLl9maWx0ZXJFZGl0b3JWaWV3LmdldE1vZGVsKCk7XHJcblxyXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxyXG4gICAgICAgICAgICBPYnNlcnZhYmxlLmZyb21FdmVudCh0aGlzLl9maWx0ZXJFZGl0b3JWaWV3LCAnYmx1cicpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWRvY3VtZW50Lmhhc0ZvY3VzKCkgJiYgIXRoaXMuX2NhbmNlbGxpbmcpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jYW5jZWwoKTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgY29tbWFuZHMuYWRkKHRoaXMucm9vdCwge1xyXG4gICAgICAgICAgICAgICAgJ2NvcmU6bW92ZS11cCc6IChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0UHJldmlvdXNJdGVtKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgJ2NvcmU6bW92ZS1kb3duJzogKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3ROZXh0SXRlbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICdjb3JlOm1vdmUtdG8tdG9wJzogKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RGaXJzdEl0ZW0oKTtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNjcm9sbFRvVG9wKHRoaXMuX2xpc3QpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICdjb3JlOm1vdmUtdG8tYm90dG9tJzogKGV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RMYXN0SXRlbSgpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2Nyb2xsVG9Cb3R0b20odGhpcy5fbGlzdCk7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgJ2NvcmU6Y29uZmlybSc6IChldmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbmZpcm1TZWxlY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAnY29yZTpjYW5jZWwnOiAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmNhbmNlbCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgT2JzZXJ2YWJsZS5mcm9tRXZlbnQodGhpcy5fbGlzdCwgJ21vdXNlZG93bicpXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChlOiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCg8SFRNTEVsZW1lbnQ+ZS50YXJnZXQpLnRhZ05hbWUgPT09ICdsaScpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0SXRlbSg8RWxlbWVudD5lLnRhcmdldCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgT2JzZXJ2YWJsZS5mcm9tRXZlbnQodGhpcy5fbGlzdCwgJ21vdXNldXAnKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoZTogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICgoPEhUTUxFbGVtZW50PmUudGFyZ2V0KS50YWdOYW1lID09PSAnbGknKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgoPEhUTUxFbGVtZW50PmUudGFyZ2V0KS5jbGFzc0xpc3QuY29udGFpbnMoJ3NlbGVjdGVkJykpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbmZpcm1TZWxlY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIE9ic2VydmFibGUuZnJvbUV2ZW50KHRoaXMuX2xpc3QsICdtb3VzZWRvd24nKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoe3RhcmdldH06IE1vdXNlRXZlbnQpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAodGFyZ2V0ID09PSB0aGlzLl9saXN0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBhYnN0cmFjdCB2aWV3Rm9ySXRlbShpdGVtOiBmdXNlLlJlc3VsdDxUPik6IEhUTUxMSUVsZW1lbnQ7XHJcbiAgICBwdWJsaWMgYWJzdHJhY3QgY29uZmlybWVkKGl0ZW06IFQpOiB2b2lkO1xyXG4gICAgcHVibGljIGFic3RyYWN0IGNhbmNlbGxlZCgpOiB2b2lkO1xyXG5cclxuICAgIHB1YmxpYyBzZXRJdGVtcyhpdGVtczogVFtdKSB7XHJcbiAgICAgICAgdGhpcy5faXRlbXMgPSBpdGVtcyAhPSBudWxsID8gaXRlbXMgOiBbXTtcclxuICAgICAgICB0aGlzLnBvcHVsYXRlTGlzdCgpO1xyXG4gICAgICAgIHJldHVybiB0aGlzLnNldExvYWRpbmcoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0IHNlbGVjdGVkKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl93ZWFrTWFwLmdldCh0aGlzLl9nZXRTZWxlY3RlZEl0ZW0oKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGdldEZpbHRlclF1ZXJ5KCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9maWx0ZXJFZGl0b3IuZ2V0VGV4dCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRNYXhJdGVtcyhtYXhJdGVtczogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5fbWF4SXRlbXMgPSBtYXhJdGVtcztcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcG9wdWxhdGVMaXN0KCkge1xyXG4gICAgICAgIHRoaXMucG9wdWxhdGVJdGVtcyhfLm1hcCh0aGlzLl9pdGVtcywgaXRlbSA9PiAoeyBpdGVtIH0pKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIHBvcHVsYXRlSXRlbXMoaXRlbXM6IGZ1c2UuUmVzdWx0PFQ+W10pIHtcclxuICAgICAgICBpZiAoaXRlbXMgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1pbm5lci1odG1sICovXHJcbiAgICAgICAgdGhpcy5fbGlzdC5pbm5lckhUTUwgPSAnJztcclxuICAgICAgICBpZiAoaXRlbXMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2V0RXJyb3IodW5kZWZpbmVkKTtcclxuXHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBfLnRha2UoaXRlbXMsIF8ubWluKFtpdGVtcy5sZW5ndGgsIHRoaXMuX21heEl0ZW1zXSkpKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB2aWV3ID0gdGhpcy52aWV3Rm9ySXRlbShpdGVtKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3dlYWtNYXAuc2V0KHZpZXcsIGl0ZW0uaXRlbSk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLl9saXN0LmFwcGVuZENoaWxkKHZpZXcpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0SXRlbSh0aGlzLl9saXN0LmZpcnN0RWxlbWVudENoaWxkKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zZXRFcnJvcih0aGlzLmdldEVtcHR5TWVzc2FnZSh0aGlzLl9pdGVtcy5sZW5ndGgsIGl0ZW1zLmxlbmd0aCkpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2V0RXJyb3IobWVzc2FnZT86IHN0cmluZykge1xyXG4gICAgICAgIGlmIChtZXNzYWdlID09IG51bGwpIHtcclxuICAgICAgICAgICAgbWVzc2FnZSA9ICcnO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAobWVzc2FnZS5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy5fZXJyb3IuaW5uZXJUZXh0ID0gJyc7XHJcbiAgICAgICAgICAgIHRoaXMuaGlkZSh0aGlzLl9lcnJvcik7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRMb2FkaW5nKCk7XHJcbiAgICAgICAgICAgIHRoaXMuX2Vycm9yLmlubmVyVGV4dCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAgIHRoaXMuc2hvdyh0aGlzLl9lcnJvcik7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZXRMb2FkaW5nKG1lc3NhZ2U/OiBzdHJpbmcpIHtcclxuICAgICAgICBpZiAobWVzc2FnZSA9PSBudWxsKSB7XHJcbiAgICAgICAgICAgIG1lc3NhZ2UgPSAnJztcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1lc3NhZ2UubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvYWRpbmcuaW5uZXJUZXh0ID0gJyc7XHJcbiAgICAgICAgICAgIHRoaXMuX2xvYWRpbmdCYWRnZS5pbm5lclRleHQgPSAnJztcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaGlkZSh0aGlzLl9sb2FkaW5nQXJlYSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5zZXRFcnJvcigpO1xyXG4gICAgICAgICAgICB0aGlzLl9sb2FkaW5nLmlubmVyVGV4dCA9IG1lc3NhZ2U7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNob3codGhpcy5fbG9hZGluZ0FyZWEpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZ2V0RW1wdHlNZXNzYWdlKGl0ZW1Db3VudDogbnVtYmVyLCBmaWx0ZXJlZEl0ZW1Db3VudDogbnVtYmVyKSB7XHJcbiAgICAgICAgcmV0dXJuICdObyBtYXRjaGVzIGZvdW5kJztcclxuICAgIH1cclxuXHJcbiAgICAvKlxyXG4gICAgU2VjdGlvbjogVmlldyBBY3Rpb25zXHJcbiAgICAgKi9cclxuXHJcbiAgICBwdWJsaWMgY2FuY2VsKCkge1xyXG4gICAgICAgIHRoaXMuZW1wdHkodGhpcy5fbGlzdCk7XHJcbiAgICAgICAgdGhpcy5fY2FuY2VsbGluZyA9IHRydWU7XHJcblxyXG4gICAgICAgIGNvbnN0IGZpbHRlckVkaXRvclZpZXdGb2N1c2VkID0gdGhpcy5oYXNGb2N1cyh0aGlzLl9maWx0ZXJFZGl0b3JWaWV3KTtcclxuICAgICAgICB0aGlzLmNhbmNlbGxlZCgpO1xyXG4gICAgICAgIHRoaXMuX2ZpbHRlckVkaXRvci5zZXRUZXh0KCcnKTtcclxuICAgICAgICBpZiAoZmlsdGVyRWRpdG9yVmlld0ZvY3VzZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5fcmVzdG9yZUZvY3VzKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuX2NhbmNlbGxpbmcgPSBmYWxzZTtcclxuICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fc2NoZWR1bGVUaW1lb3V0KTtcclxuICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZm9jdXNGaWx0ZXJFZGl0b3IoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZpbHRlckVkaXRvclZpZXcuZm9jdXMoKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc3RvcmVGb2N1c2VkRWxlbWVudCgpIHtcclxuICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55ICovXHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3ByZXZpb3VzbHlGb2N1c2VkRWxlbWVudCA9IDxhbnk+ZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2VsZWN0Rmlyc3RJdGVtKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zZWxlY3RJdGVtKDxIVE1MTElFbGVtZW50PnRoaXMuX2xpc3QuZmlyc3RFbGVtZW50Q2hpbGQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZWxlY3RMYXN0SXRlbSgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0SXRlbSg8SFRNTExJRWxlbWVudD50aGlzLl9saXN0Lmxhc3RFbGVtZW50Q2hpbGQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzZWxlY3RQcmV2aW91c0l0ZW0oKSB7XHJcbiAgICAgICAgbGV0IHZpZXc6IEhUTUxMSUVsZW1lbnQgPSA8SFRNTExJRWxlbWVudD50aGlzLl9nZXRTZWxlY3RlZEl0ZW0oKS5wcmV2aW91c0VsZW1lbnRTaWJsaW5nO1xyXG4gICAgICAgIGlmICghdmlldykge1xyXG4gICAgICAgICAgICB2aWV3ID0gPEhUTUxMSUVsZW1lbnQ+dGhpcy5fbGlzdC5sYXN0RWxlbWVudENoaWxkO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0SXRlbSh2aWV3KTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2VsZWN0TmV4dEl0ZW0oKSB7XHJcbiAgICAgICAgbGV0IHZpZXc6IEhUTUxMSUVsZW1lbnQgPSA8SFRNTExJRWxlbWVudD50aGlzLl9nZXRTZWxlY3RlZEl0ZW0oKS5uZXh0RWxlbWVudFNpYmxpbmc7XHJcbiAgICAgICAgaWYgKCF2aWV3KSB7XHJcbiAgICAgICAgICAgIHZpZXcgPSA8SFRNTExJRWxlbWVudD50aGlzLl9saXN0LmZpcnN0RWxlbWVudENoaWxkO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0SXRlbSh2aWV3KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9zZWxlY3RJdGVtKHZpZXc6IEVsZW1lbnQpIHtcclxuICAgICAgICBjb25zdCBzZWxlY3RlZCA9IHRoaXMuX2xpc3QucXVlcnlTZWxlY3RvcignLnNlbGVjdGVkJyk7XHJcbiAgICAgICAgaWYgKHNlbGVjdGVkKSB7XHJcbiAgICAgICAgICAgIHNlbGVjdGVkLmNsYXNzTGlzdC5yZW1vdmUoJ3NlbGVjdGVkJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHZpZXcuY2xhc3NMaXN0LmFkZCgnc2VsZWN0ZWQnKTtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2Nyb2xsVG9JdGVtKHZpZXcpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3Njcm9sbFRvSXRlbSh2aWV3OiBFbGVtZW50KSB7XHJcbiAgICAgICAgY29uc3Qgc2Nyb2xsVG9wID0gdGhpcy5fbGlzdC5zY3JvbGxUb3A7XHJcbiAgICAgICAgY29uc3QgZGVzaXJlZFRvcCA9IHZpZXcuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkudG9wICsgc2Nyb2xsVG9wO1xyXG4gICAgICAgIGNvbnN0IGRlc2lyZWRCb3R0b20gPSBkZXNpcmVkVG9wICsgdmlldy5jbGllbnRIZWlnaHQ7XHJcbiAgICAgICAgaWYgKGRlc2lyZWRUb3AgPCBzY3JvbGxUb3ApIHtcclxuICAgICAgICAgICAgdGhpcy5fbGlzdC5zY3JvbGxUb3AgPSBkZXNpcmVkVG9wO1xyXG4gICAgICAgIH0gZWxzZSBpZiAoZGVzaXJlZEJvdHRvbSA+IHRoaXMuc2Nyb2xsQm90dG9tKHRoaXMuX2xpc3QpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuc2Nyb2xsQm90dG9tKHRoaXMuX2xpc3QsIGRlc2lyZWRCb3R0b20pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9yZXN0b3JlRm9jdXMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3ByZXZpb3VzbHlGb2N1c2VkRWxlbWVudCkge1xyXG4gICAgICAgICAgICB0aGlzLl9wcmV2aW91c2x5Rm9jdXNlZEVsZW1lbnQuZm9jdXMoKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfZ2V0U2VsZWN0ZWRJdGVtKCk6IEhUTUxMSUVsZW1lbnQge1xyXG4gICAgICAgIHJldHVybiA8SFRNTExJRWxlbWVudD50aGlzLl9saXN0LnF1ZXJ5U2VsZWN0b3IoJ2xpLnNlbGVjdGVkJyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY29uZmlybVNlbGVjdGlvbigpIHtcclxuICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5zZWxlY3RlZDtcclxuICAgICAgICBpZiAoaXRlbSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29uZmlybWVkKGl0ZW0pO1xyXG4gICAgICAgICAgICB0aGlzLmRpc3Bvc2UoKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLmNhbmNlbCgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgc2NoZWR1bGVQb3B1bGF0ZUxpc3QoKSB7XHJcbiAgICAgICAgY2xlYXJUaW1lb3V0KHRoaXMuX3NjaGVkdWxlVGltZW91dCk7XHJcbiAgICAgICAgY29uc3QgcG9wdWxhdGVDYWxsYmFjayA9ICgpID0+IHtcclxuICAgICAgICAgICAgaWYgKGRvY3VtZW50LmJvZHkuY29udGFpbnModGhpcy5yb290KSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMucG9wdWxhdGVMaXN0KCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMuX3NjaGVkdWxlVGltZW91dCA9IHNldFRpbWVvdXQocG9wdWxhdGVDYWxsYmFjaywgdGhpcy5faW5wdXRUaHJvdHRsZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfYnVpbGRIdG1sKCkge1xyXG4gICAgICAgIHRoaXMucm9vdC5jbGFzc0xpc3QuYWRkKCdzZWxlY3QtbGlzdCcpO1xyXG4gICAgICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1hbnkgKi9cclxuICAgICAgICBjb25zdCBlZGl0b3I6IEF0b20uVGV4dEVkaXRvclByZXNlbnRlciA9IHRoaXMuX2ZpbHRlckVkaXRvclZpZXcgPSA8YW55PmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F0b20tdGV4dC1lZGl0b3InKTtcclxuICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55ICovXHJcbiAgICAgICAgZWRpdG9yLnNldEF0dHJpYnV0ZSgnbWluaScsIDxhbnk+dHJ1ZSk7XHJcbiAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gdGhpcy5fZXJyb3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICBlcnJvck1lc3NhZ2UuY2xhc3NMaXN0LmFkZCgnZXJyb3ItbWVzc2FnZScpO1xyXG4gICAgICAgIGNvbnN0IGxvYWRpbmcgPSB0aGlzLl9sb2FkaW5nQXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xyXG4gICAgICAgIGxvYWRpbmcuY2xhc3NMaXN0LmFkZCgnbG9hZGluZycpO1xyXG4gICAgICAgIGNvbnN0IGxvYWRpbmdNZXNzYWdlID0gdGhpcy5fbG9hZGluZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICBsb2FkaW5nTWVzc2FnZS5jbGFzc0xpc3QuYWRkKCdsb2FkaW5nLW1lc3NhZ2UnKTtcclxuICAgICAgICBjb25zdCBsb2FkaW5nQmFkZ2UgPSB0aGlzLl9sb2FkaW5nQmFkZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XHJcbiAgICAgICAgbG9hZGluZ0JhZGdlLmNsYXNzTGlzdC5hZGQoJ2JhZGdlJyk7XHJcbiAgICAgICAgY29uc3QgbGlzdEdyb3VwID0gdGhpcy5fbGlzdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29sJyk7XHJcbiAgICAgICAgbGlzdEdyb3VwLmNsYXNzTGlzdC5hZGQoJ2xpc3QtZ3JvdXAnKTtcclxuXHJcbiAgICAgICAgdGhpcy5yb290LmFwcGVuZENoaWxkKGVkaXRvcik7XHJcbiAgICAgICAgdGhpcy5yb290LmFwcGVuZENoaWxkKGVycm9yTWVzc2FnZSk7XHJcbiAgICAgICAgdGhpcy5yb290LmFwcGVuZENoaWxkKGxvYWRpbmcpO1xyXG4gICAgICAgIGxvYWRpbmcuYXBwZW5kQ2hpbGQobG9hZGluZ01lc3NhZ2UpO1xyXG4gICAgICAgIGxvYWRpbmcuYXBwZW5kQ2hpbGQobG9hZGluZ0JhZGdlKTtcclxuICAgICAgICB0aGlzLnJvb3QuYXBwZW5kQ2hpbGQobGlzdEdyb3VwKTtcclxuICAgIH1cclxufVxyXG4iXX0=