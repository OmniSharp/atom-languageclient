"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
/**
 *
 */
var _ = require('lodash');
var FilterSelectListView_1 = require('./FilterSelectListView');
var ReferenceView = (function (_super) {
    __extends(ReferenceView, _super);
    function ReferenceView(commands, navigation, results) {
        var _this = this;
        _super.call(this, commands);
        this._navigation = navigation;
        this.setFilterItems(results, this._filterEditorView.getModel().getText());
        this._filterEditorView.getModel().buffer.onDidChange(function () {
            _this.populateList(_this._filterEditorView.getModel().getText());
        });
        this.storeFocusedElement();
        this._panel = atom.workspace.addModalPanel({ item: this.root });
        this.focusFilterEditor();
        this._disposable.add(function () { return _this._panel.destroy(); });
    }
    Object.defineProperty(ReferenceView.prototype, "filterKeys", {
        get: function () {
            return [
                { name: 'filterText', weight: 0.3 },
                { name: 'filePath', weight: 0.2 },
                { name: 'name', weight: 0.5 }
            ];
        },
        enumerable: true,
        configurable: true
    });
    ReferenceView.prototype.cancelled = function () {
        this._panel.destroy();
    };
    ReferenceView.prototype.confirmed = function (item) {
        this._navigation.navigateTo(item);
    };
    ReferenceView.prototype.viewForItem = function (result) {
        var item = result.item, matches = result.matches;
        var lines = item.lines, range = item.range;
        var li = document.createElement('li');
        var filename = atom.project.relativizePath(item.filePath)[1];
        filename += ": " + item.range.start.column + "@" + item.range.start.row;
        var filenameContent = filename;
        var pathMatches = _.find(matches, { key: 'filePath' });
        if (pathMatches) {
            filenameContent = this._getMatchString(filenameContent, pathMatches);
        }
        /* tslint:disable-next-line:no-inner-html */
        li.innerHTML = "\n            " + this._getSymbolString(lines, range) + "\n            <span class=\"filename\">" + filenameContent + "</span>\n            ";
        return li;
    };
    ReferenceView.prototype._getSymbolString = function (lines, range) {
        var first = _.first(lines);
        var last = _.last(lines);
        if (first === last) {
            var text = first;
            var end_1 = range.end.column;
            var start_1 = range.start.column;
            var endStr_1 = text.substr(end_1 + 1);
            var replace = "<span class=\"character-match\">" + text.substr(start_1, end_1 - start_1 + 1) + "</span>";
            var startStr_1 = text.substr(0, start_1);
            return "" + startStr_1 + replace + endStr_1 + "<br/>";
        }
        var middle = _.map(lines.slice(1, -1), function (line) { return ("<span class=\"character-match\">" + line + "</span><br/>"); });
        var start = range.start.column;
        var startStr = first.substr(0, start);
        startStr = startStr + "<span class=\"character-match\">" + first.substr(start) + "</span><br/>";
        var end = range.end.column;
        var endStr = last.substr(end + 1);
        endStr = "<span class=\"character-match\">" + last.substr(0, start) + "</span>" + endStr + "<br/>";
        return [startStr].concat(middle, [endStr]).join('');
    };
    ReferenceView.prototype._getMatchString = function (text, match) {
        _.each(_.reverse(match.indices), function (_a) {
            var start = _a[0], end = _a[1];
            var endStr = text.substr(end + 1);
            var replace = "<span class=\"character-match\">" + text.substr(start, end - start + 1) + "</span>";
            var startStr = text.substr(0, start);
            text = "" + startStr + replace + endStr;
        });
        return text;
    };
    return ReferenceView;
}(FilterSelectListView_1.FilterSelectListView));
exports.ReferenceView = ReferenceView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUmVmZXJlbmNlVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hdG9tL3ZpZXdzL1JlZmVyZW5jZVZpZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUE7O0dBRUc7QUFDSCxJQUFZLENBQUMsV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUk1QixxQ0FBcUMsd0JBQXdCLENBQUMsQ0FBQTtBQUU5RDtJQUFtQyxpQ0FBeUM7SUFHeEUsdUJBQVksUUFBc0IsRUFBRSxVQUEwQixFQUFFLE9BQThCO1FBSGxHLGlCQXlGQztRQXJGTyxrQkFBTSxRQUFRLENBQUMsQ0FBQztRQUNoQixJQUFJLENBQUMsV0FBVyxHQUFHLFVBQVUsQ0FBQztRQUM5QixJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUMxRSxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQztZQUNqRCxLQUFJLENBQUMsWUFBWSxDQUFDLEtBQUksQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQ25FLENBQUMsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNoRSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUV6QixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxjQUFNLE9BQUEsS0FBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDO0lBQ3RELENBQUM7SUFFRCxzQkFBVyxx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LENBQUM7WUFDdkMsSUFBSSxHQUFHLEtBQUcsUUFBUSxHQUFHLE9BQU8sR0FBRyxNQUFRLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDTCxvQkFBQztBQUFELENBQUMsQUF6RkQsQ0FBbUMsMkNBQW9CLEdBeUZ0RDtBQXpGWSxxQkFBYSxnQkF5RnpCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICpcclxuICovXHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgUmVmZXJlbmNlIH0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzJztcclxuaW1wb3J0IHsgQXRvbUNvbW1hbmRzIH0gZnJvbSAnLi4vQXRvbUNvbW1hbmRzJztcclxuaW1wb3J0IHsgQXRvbU5hdmlnYXRpb24gfSBmcm9tICcuLi9BdG9tTmF2aWdhdGlvbic7XHJcbmltcG9ydCB7IEZpbHRlclNlbGVjdExpc3RWaWV3IH0gZnJvbSAnLi9GaWx0ZXJTZWxlY3RMaXN0Vmlldyc7XHJcblxyXG5leHBvcnQgY2xhc3MgUmVmZXJlbmNlVmlldyBleHRlbmRzIEZpbHRlclNlbGVjdExpc3RWaWV3PFJlZmVyZW5jZS5JUmVzcG9uc2U+IHtcclxuICAgIHByaXZhdGUgX25hdmlnYXRpb246IEF0b21OYXZpZ2F0aW9uO1xyXG4gICAgcHJpdmF0ZSBfcGFuZWw6IEF0b20uUGFuZWw7XHJcbiAgICBjb25zdHJ1Y3Rvcihjb21tYW5kczogQXRvbUNvbW1hbmRzLCBuYXZpZ2F0aW9uOiBBdG9tTmF2aWdhdGlvbiwgcmVzdWx0czogUmVmZXJlbmNlLklSZXNwb25zZVtdKSB7XHJcbiAgICAgICAgc3VwZXIoY29tbWFuZHMpO1xyXG4gICAgICAgIHRoaXMuX25hdmlnYXRpb24gPSBuYXZpZ2F0aW9uO1xyXG4gICAgICAgIHRoaXMuc2V0RmlsdGVySXRlbXMocmVzdWx0cywgdGhpcy5fZmlsdGVyRWRpdG9yVmlldy5nZXRNb2RlbCgpLmdldFRleHQoKSk7XHJcbiAgICAgICAgdGhpcy5fZmlsdGVyRWRpdG9yVmlldy5nZXRNb2RlbCgpLmJ1ZmZlci5vbkRpZENoYW5nZSgoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucG9wdWxhdGVMaXN0KHRoaXMuX2ZpbHRlckVkaXRvclZpZXcuZ2V0TW9kZWwoKS5nZXRUZXh0KCkpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLnN0b3JlRm9jdXNlZEVsZW1lbnQoKTtcclxuICAgICAgICB0aGlzLl9wYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZE1vZGFsUGFuZWwoeyBpdGVtOiB0aGlzLnJvb3QgfSk7XHJcbiAgICAgICAgdGhpcy5mb2N1c0ZpbHRlckVkaXRvcigpO1xyXG5cclxuICAgICAgICB0aGlzLl9kaXNwb3NhYmxlLmFkZCgoKSA9PiB0aGlzLl9wYW5lbC5kZXN0cm95KCkpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBnZXQgZmlsdGVyS2V5cygpIHtcclxuICAgICAgICByZXR1cm4gW1xyXG4gICAgICAgICAgICB7IG5hbWU6ICdmaWx0ZXJUZXh0Jywgd2VpZ2h0OiAwLjMgfSxcclxuICAgICAgICAgICAgeyBuYW1lOiAnZmlsZVBhdGgnLCB3ZWlnaHQ6IDAuMiB9LFxyXG4gICAgICAgICAgICB7IG5hbWU6ICduYW1lJywgd2VpZ2h0OiAwLjUgfVxyXG4gICAgICAgIF07XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNhbmNlbGxlZCgpIHtcclxuICAgICAgICB0aGlzLl9wYW5lbC5kZXN0cm95KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNvbmZpcm1lZChpdGVtOiBSZWZlcmVuY2UuSVJlc3BvbnNlKSB7XHJcbiAgICAgICAgdGhpcy5fbmF2aWdhdGlvbi5uYXZpZ2F0ZVRvKGl0ZW0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyB2aWV3Rm9ySXRlbShyZXN1bHQ6IGZ1c2UuUmVzdWx0PFJlZmVyZW5jZS5JUmVzcG9uc2U+KSB7XHJcbiAgICAgICAgY29uc3Qge2l0ZW0sIG1hdGNoZXN9ID0gcmVzdWx0O1xyXG4gICAgICAgIGNvbnN0IHtsaW5lcywgcmFuZ2V9ID0gaXRlbTtcclxuICAgICAgICBjb25zdCBsaSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2xpJyk7XHJcbiAgICAgICAgbGV0IGZpbGVuYW1lID0gYXRvbS5wcm9qZWN0LnJlbGF0aXZpemVQYXRoKGl0ZW0uZmlsZVBhdGgpWzFdO1xyXG4gICAgICAgIGZpbGVuYW1lICs9IGA6ICR7aXRlbS5yYW5nZS5zdGFydC5jb2x1bW59QCR7aXRlbS5yYW5nZS5zdGFydC5yb3d9YDtcclxuXHJcbiAgICAgICAgbGV0IGZpbGVuYW1lQ29udGVudCA9IGZpbGVuYW1lO1xyXG5cclxuICAgICAgICBjb25zdCBwYXRoTWF0Y2hlcyA9IF8uZmluZChtYXRjaGVzISwgeyBrZXk6ICdmaWxlUGF0aCcgfSk7XHJcbiAgICAgICAgaWYgKHBhdGhNYXRjaGVzKSB7XHJcbiAgICAgICAgICAgIGZpbGVuYW1lQ29udGVudCA9IHRoaXMuX2dldE1hdGNoU3RyaW5nKGZpbGVuYW1lQ29udGVudCwgcGF0aE1hdGNoZXMpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWlubmVyLWh0bWwgKi9cclxuICAgICAgICBsaS5pbm5lckhUTUwgPSBgXHJcbiAgICAgICAgICAgICR7dGhpcy5fZ2V0U3ltYm9sU3RyaW5nKGxpbmVzLCByYW5nZSl9XHJcbiAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwiZmlsZW5hbWVcIj4ke2ZpbGVuYW1lQ29udGVudH08L3NwYW4+XHJcbiAgICAgICAgICAgIGA7XHJcblxyXG4gICAgICAgIHJldHVybiBsaTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9nZXRTeW1ib2xTdHJpbmcobGluZXM6IHN0cmluZ1tdLCByYW5nZTogVGV4dEJ1ZmZlci5SYW5nZSkge1xyXG4gICAgICAgIGNvbnN0IGZpcnN0ID0gXy5maXJzdChsaW5lcyk7XHJcbiAgICAgICAgY29uc3QgbGFzdCA9IF8ubGFzdChsaW5lcyk7XHJcbiAgICAgICAgaWYgKGZpcnN0ID09PSBsYXN0KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRleHQgPSBmaXJzdDtcclxuICAgICAgICAgICAgY29uc3QgZW5kID0gcmFuZ2UuZW5kLmNvbHVtbjtcclxuICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSByYW5nZS5zdGFydC5jb2x1bW47XHJcbiAgICAgICAgICAgIGNvbnN0IGVuZFN0ciA9IHRleHQuc3Vic3RyKGVuZCArIDEpO1xyXG4gICAgICAgICAgICBjb25zdCByZXBsYWNlID0gYDxzcGFuIGNsYXNzPVwiY2hhcmFjdGVyLW1hdGNoXCI+JHt0ZXh0LnN1YnN0cihzdGFydCwgZW5kIC0gc3RhcnQgKyAxKX08L3NwYW4+YDtcclxuICAgICAgICAgICAgY29uc3Qgc3RhcnRTdHIgPSB0ZXh0LnN1YnN0cigwLCBzdGFydCk7XHJcbiAgICAgICAgICAgIHJldHVybiBgJHtzdGFydFN0cn0ke3JlcGxhY2V9JHtlbmRTdHJ9PGJyLz5gO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbWlkZGxlID0gXy5tYXAobGluZXMuc2xpY2UoMSwgLTEpLCBsaW5lID0+IGA8c3BhbiBjbGFzcz1cImNoYXJhY3Rlci1tYXRjaFwiPiR7bGluZX08L3NwYW4+PGJyLz5gKTtcclxuICAgICAgICBjb25zdCBzdGFydCA9IHJhbmdlLnN0YXJ0LmNvbHVtbjtcclxuICAgICAgICBsZXQgc3RhcnRTdHIgPSBmaXJzdC5zdWJzdHIoMCwgc3RhcnQpO1xyXG4gICAgICAgIHN0YXJ0U3RyID0gYCR7c3RhcnRTdHJ9PHNwYW4gY2xhc3M9XCJjaGFyYWN0ZXItbWF0Y2hcIj4ke2ZpcnN0LnN1YnN0cihzdGFydCl9PC9zcGFuPjxici8+YDtcclxuICAgICAgICBjb25zdCBlbmQgPSByYW5nZS5lbmQuY29sdW1uO1xyXG4gICAgICAgIGxldCBlbmRTdHIgPSBsYXN0LnN1YnN0cihlbmQgKyAxKTtcclxuICAgICAgICBlbmRTdHIgPSBgPHNwYW4gY2xhc3M9XCJjaGFyYWN0ZXItbWF0Y2hcIj4ke2xhc3Quc3Vic3RyKDAsIHN0YXJ0KX08L3NwYW4+JHtlbmRTdHJ9PGJyLz5gO1xyXG4gICAgICAgIHJldHVybiBbc3RhcnRTdHIsIC4uLm1pZGRsZSwgZW5kU3RyXS5qb2luKCcnKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9nZXRNYXRjaFN0cmluZyh0ZXh0OiBzdHJpbmcsIG1hdGNoOiBmdXNlLk1hdGNoKSB7XHJcbiAgICAgICAgXy5lYWNoKF8ucmV2ZXJzZShtYXRjaC5pbmRpY2VzKSwgKFtzdGFydCwgZW5kXSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBlbmRTdHIgPSB0ZXh0LnN1YnN0cihlbmQgKyAxKTtcclxuICAgICAgICAgICAgY29uc3QgcmVwbGFjZSA9IGA8c3BhbiBjbGFzcz1cImNoYXJhY3Rlci1tYXRjaFwiPiR7dGV4dC5zdWJzdHIoc3RhcnQsIGVuZCAtIHN0YXJ0ICsgMSl9PC9zcGFuPmA7XHJcbiAgICAgICAgICAgIGNvbnN0IHN0YXJ0U3RyID0gdGV4dC5zdWJzdHIoMCwgc3RhcnQpO1xyXG4gICAgICAgICAgICB0ZXh0ID0gYCR7c3RhcnRTdHJ9JHtyZXBsYWNlfSR7ZW5kU3RyfWA7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcmV0dXJuIHRleHQ7XHJcbiAgICB9XHJcbn1cclxuIl19