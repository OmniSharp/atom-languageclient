"use strict";
/**
 *  @license   MIT
 *  @copyright OmniSharp Team
 *  @summary   Adds support for https://github.com/Microsoft/language-server-protocol (and more!) to https://atom.io
 */
/* tslint:disable:no-any */
var _ = require('lodash');
var atom_languageservices_1 = require('atom-languageservices');
/* tslint:disable */
var protocol_1 = require('atom-languageservices/protocol');
/* tslint:enable */
/* tslint:disable:no-any */
var child_process_1 = require('child_process');
var vscode_jsonrpc_1 = require('vscode-jsonrpc');
var electron_1 = require('./utils/electron');
var ConsoleLogger_1 = require('./ConsoleLogger');
var isDefined = _.negate(_.isUndefined);
/* tslint:disable-next-line:variable-name */
exports.IConnection = Symbol.for('IConnection');
function isStdioConnection(options) {
    return options.input && options.output;
}
function getEnvironment(env) {
    if (!env) {
        return process.env;
    }
    var result = Object.create(null);
    Object.keys(process.env).forEach(function (key) { return result[key] = process.env[key]; });
    Object.keys(env).forEach(function (key) { return result[key] = env[key]; });
}
var Connection = (function () {
    function Connection(options) {
        var input;
        var output;
        var closeHandler = options.closeHandler, errorHandler = options.errorHandler, process = options.process;
        if (process) {
            this._process = process;
        }
        if (isStdioConnection(options)) {
            input = options.input;
            output = options.output;
        }
        else {
            input = options.reader;
            output = options.writer;
        }
        var logger = new ConsoleLogger_1.ConsoleLogger();
        var connection = vscode_jsonrpc_1.createClientMessageConnection(input, output, logger);
        this._connection = connection;
        connection.onError(function (data) { errorHandler(data[0], data[1], data[2]); });
        connection.onClose(closeHandler);
    }
    Connection.create = function (server, opts, debug) {
        if (debug === void 0) { debug = false; }
        // We got a function.
        if (_.isFunction(server)) {
            return server().then(function (result) {
                var info = result;
                if (info.writer && info.reader) {
                    return new Connection(_.assign({}, opts, { input: info.reader, output: info.writer }));
                }
                else {
                    var cp = result;
                    return new Connection(_.assign({}, opts, { input: cp.stdout, output: cp.stdin, process: cp }));
                }
            });
        }
        var json;
        var runDebug = server;
        if (isDefined(runDebug.run) || isDefined(runDebug.debug)) {
            // We are under debugging. So use debug as well.
            if (typeof v8debug === 'object' || debug) {
                json = runDebug.debug;
            }
            else {
                json = runDebug.run;
            }
        }
        else {
            json = server;
        }
        if (isDefined(json.module)) {
            var node_1 = json;
            if (node_1.runtime) {
                var args_1 = [];
                var options = node_1.options || Object.create(null);
                if (options.execArgv) {
                    options.execArgv.forEach(function (element) { return args_1.push(element); });
                }
                args_1.push(node_1.module);
                if (node_1.args) {
                    node_1.args.forEach(function (element) { return args_1.push(element); });
                }
                var execOptions = Object.create(null);
                execOptions.cwd = options.cwd || atom.project.getPaths()[0];
                execOptions.env = getEnvironment(options.env);
                if (node_1.transport === atom_languageservices_1.TransportKind.ipc) {
                    execOptions.stdio = [null, null, null, 'ipc'];
                }
                var process_1 = child_process_1.spawn(node_1.runtime, args_1, execOptions);
                if (!process_1 || !process_1.pid) {
                    return Promise.reject("Launching server using runtime " + node_1.runtime + " failed.");
                }
                // A spawned process doesn't have ipc transport even if we spawn node. For now always use stdio communication.
                if (node_1.transport === atom_languageservices_1.TransportKind.ipc) {
                    process_1.stdout.on('data', function (data) { return opts.output(data.toString()); });
                    process_1.stderr.on('data', function (data) { return opts.output(data.toString()); });
                    var reader = new vscode_jsonrpc_1.IPCMessageReader(process_1);
                    var writer = new vscode_jsonrpc_1.IPCMessageWriter(process_1);
                    return Promise.resolve(new Connection(_.assign({}, opts, { reader: reader, writer: writer, process: process_1 })));
                }
                else {
                    return Promise.resolve(new Connection(_.assign({}, opts, { input: process_1.stdout, output: process_1.stdin })));
                }
            }
            else {
                return new Promise(function (resolve, reject) {
                    var options = node_1.options || Object.create(null);
                    options.execArgv = options.execArgv || [];
                    options.cwd = options.cwd || atom.project.getPaths()[0];
                    electron_1.fork(node_1.module, node_1.args || [], options, function (error, cp) {
                        if (error) {
                            reject(error);
                        }
                        else {
                            if (node_1.transport === atom_languageservices_1.TransportKind.ipc) {
                                cp.stdout.on('data', function (data) {
                                    opts.output(data.toString());
                                });
                                var reader = new vscode_jsonrpc_1.IPCMessageReader(cp);
                                var writer = new vscode_jsonrpc_1.IPCMessageWriter(cp);
                                resolve(new Connection(_.assign({}, opts, { reader: reader, writer: writer, process: cp })));
                            }
                            else {
                                resolve(new Connection(_.assign({}, opts, { input: cp.stdout, output: cp.stdin })));
                            }
                        }
                    });
                });
            }
        }
        else if (isDefined(json.command)) {
            var command = json;
            var options = command.options || {};
            options.cwd = options.cwd || atom.project.getPaths()[0];
            var process_2 = child_process_1.spawn(command.command, command.args, command.options);
            return Promise.resolve(new Connection(_.assign({}, opts, { input: process_2.stdout, output: process_2.stdin, process: process_2 })));
        }
        return Promise.reject(new Error("Unsupported server configuartion " + JSON.stringify(server, null, 4)));
    };
    Object.defineProperty(Connection.prototype, "settings", {
        get: function () { return this._settings; },
        enumerable: true,
        configurable: true
    });
    Connection.prototype.connection = function () {
        return this._connection;
    };
    Connection.prototype.listen = function () {
        this._connection.listen();
    };
    Connection.prototype.sendRequest = function (type, params, token) {
        return this._connection.sendRequest(type, params, token);
    };
    Connection.prototype.sendNotification = function (type, params) {
        this._connection.sendNotification(type, params);
    };
    Connection.prototype.onNotification = function (type, handler) {
        this._connection.onNotification(type, handler);
    };
    Connection.prototype.onRequest = function (type, handler) {
        this._connection.onRequest(type, handler);
    };
    Connection.prototype.trace = function (value, tracer) {
        this._connection.trace(value, tracer);
    };
    Connection.prototype.initialize = function (params) {
        var _this = this;
        return this._connection.sendRequest(protocol_1.InitializeRequest.type, params)
            .then(function (x) { return _this._settings = x; });
    };
    Connection.prototype.shutdown = function () {
        return this._connection.sendRequest(protocol_1.ShutdownRequest.type, undefined);
    };
    Connection.prototype.exit = function () {
        this._connection.sendNotification(protocol_1.ExitNotification.type);
    };
    Connection.prototype.onLogMessage = function (handler) {
        this._connection.onNotification(protocol_1.LogMessageNotification.type, handler);
    };
    Connection.prototype.onShowMessage = function (handler) {
        this._connection.onNotification(protocol_1.ShowMessageNotification.type, handler);
    };
    Connection.prototype.onTelemetry = function (handler) {
        this._connection.onNotification(protocol_1.TelemetryEventNotification.type, handler);
    };
    Connection.prototype.dispose = function () {
        this._connection.dispose();
    };
    return Connection;
}());
exports.Connection = Connection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wcm90b2NvbC9Db25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHO0FBQ0gsMkJBQTJCO0FBQzNCLElBQVksQ0FBQyxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQzVCLHNDQUF1SSx1QkFBdUIsQ0FBQyxDQUFBO0FBQy9KLG9CQUFvQjtBQUNwQix5QkFXTyxnQ0FBZ0MsQ0FBQyxDQUFBO0FBT3hDLG1CQUFtQjtBQUNuQiwyQkFBMkI7QUFDM0IsOEJBQW9DLGVBQWUsQ0FBQyxDQUFBO0FBRXBELCtCQU1PLGdCQUFnQixDQUFDLENBQUE7QUFFeEIseUJBQXFCLGtCQUFrQixDQUFDLENBQUE7QUFDeEMsOEJBQThCLGlCQUFpQixDQUFDLENBQUE7QUFFaEQsSUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7QUFFMUMsNENBQTRDO0FBQy9CLG1CQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQThEckQsMkJBQTJCLE9BQVk7SUFDbkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUMzQyxDQUFDO0FBRUQsd0JBQXdCLEdBQVE7SUFDNUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1AsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDdkIsQ0FBQztJQUNELElBQU0sTUFBTSxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxH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LFdBQVcsQ0FBQyxXQUFXLENBQUMsMEJBQWUsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDekUsQ0FBQztJQUVNLHlCQUFJLEdBQVg7UUFDSSxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLDJCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFTSxpQ0FBWSxHQUFuQixVQUFvQixPQUE4QztRQUM5RCxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxpQ0FBc0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVNLGtDQUFhLEdBQXBCLFVBQXFCLE9BQStDO1FBQ2hFLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLGtDQUF1QixDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRU0sZ0NBQVcsR0FBbEIsVUFBbUIsT0FBaUM7UUFDaEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMscUNBQTBCLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFTSw0QkFBTyxHQUFkO1FBQ0ksSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBQ0wsaUJBQUM7QUFBRCxDQUFDLEFBaExELElBZ0xDO0FBaExZLGtCQUFVLGFBZ0x0QixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqICBAbGljZW5zZSAgIE1JVFxyXG4gKiAgQGNvcHlyaWdodCBPbW5pU2hhcnAgVGVhbVxyXG4gKiAgQHN1bW1hcnkgICBBZGRzIHN1cHBvcnQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvbGFuZ3VhZ2Utc2VydmVyLXByb3RvY29sIChhbmQgbW9yZSEpIHRvIGh0dHBzOi8vYXRvbS5pb1xyXG4gKi9cclxuLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovXHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgSUV4ZWN1dGFibGUsIElFeGVjdXRhYmxlT3B0aW9ucywgSUZvcmtPcHRpb25zLCBJTGFuZ3VhZ2VQcm90b2NvbFNlcnZlck9wdGlvbnMsIElOb2RlTW9kdWxlLCBJU3RyZWFtSW5mbywgVHJhbnNwb3J0S2luZCB9IGZyb20gJ2F0b20tbGFuZ3VhZ2VzZXJ2aWNlcyc7XHJcbi8qIHRzbGludDpkaXNhYmxlICovXHJcbmltcG9ydCB7XHJcbiAgICBEaWRDaGFuZ2VDb25maWd1cmF0aW9uTm90aWZpY2F0aW9uLFxyXG4gICAgRGlkQ2hhbmdlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLFxyXG4gICAgRGlkQ2hhbmdlV2F0Y2hlZEZpbGVzTm90aWZpY2F0aW9uLCBEaWRDbG9zZVRleHREb2N1bWVudE5vdGlmaWNhdGlvbixcclxuICAgIERpZE9wZW5UZXh0RG9jdW1lbnROb3RpZmljYXRpb24sXHJcbiAgICBEaWRTYXZlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLCBFeGl0Tm90aWZpY2F0aW9uLFxyXG4gICAgSW5pdGlhbGl6ZVJlcXVlc3QsXHJcbiAgICBMb2dNZXNzYWdlTm90aWZpY2F0aW9uLFxyXG4gICAgUHVibGlzaERpYWdub3N0aWNzTm90aWZpY2F0aW9uLFxyXG4gICAgU2hvd01lc3NhZ2VOb3RpZmljYXRpb24sXHJcbiAgICBTaHV0ZG93blJlcXVlc3QsIFRlbGVtZXRyeUV2ZW50Tm90aWZpY2F0aW9uXHJcbn0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzL3Byb3RvY29sJztcclxuaW1wb3J0IHtcclxuICAgIERpZENoYW5nZUNvbmZpZ3VyYXRpb25QYXJhbXMsIERpZENoYW5nZVRleHREb2N1bWVudFBhcmFtcywgRGlkQ2hhbmdlV2F0Y2hlZEZpbGVzUGFyYW1zLFxyXG4gICAgRGlkQ2xvc2VUZXh0RG9jdW1lbnRQYXJhbXMsIERpZE9wZW5UZXh0RG9jdW1lbnRQYXJhbXMsIERpZFNhdmVUZXh0RG9jdW1lbnRQYXJhbXNcclxuICAgICwgSW5pdGlhbGl6ZVBhcmFtcywgSW5pdGlhbGl6ZVJlc3VsdCwgTG9nTWVzc2FnZVBhcmFtc1xyXG4gICAgLCBQdWJsaXNoRGlhZ25vc3RpY3NQYXJhbXMsIFNob3dNZXNzYWdlUGFyYW1zXHJcbn0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzL3R5cGVzJztcclxuLyogdHNsaW50OmVuYWJsZSAqL1xyXG4vKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cclxuaW1wb3J0IHsgQ2hpbGRQcm9jZXNzLCBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIENhbmNlbGxhdGlvblRva2VuLCBDbGllbnRNZXNzYWdlQ29ubmVjdGlvbiwgSVBDTWVzc2FnZVJlYWRlciwgSVBDTWVzc2FnZVdyaXRlcixcclxuICAgIE1lc3NhZ2UsIE1lc3NhZ2VSZWFkZXIsIE1lc3NhZ2VXcml0ZXIsIE5vdGlmaWNhdGlvbkhhbmRsZXIsXHJcbiAgICBOb3RpZmljYXRpb25UeXBlLCBSZXF1ZXN0SGFuZGxlciwgUmVxdWVzdFR5cGUsXHJcbiAgICBUcmFjZSwgVHJhY2VyLFxyXG4gICAgY3JlYXRlQ2xpZW50TWVzc2FnZUNvbm5lY3Rpb25cclxufSBmcm9tICd2c2NvZGUtanNvbnJwYyc7XHJcblxyXG5pbXBvcnQgeyBmb3JrIH0gZnJvbSAnLi91dGlscy9lbGVjdHJvbic7XHJcbmltcG9ydCB7IENvbnNvbGVMb2dnZXIgfSBmcm9tICcuL0NvbnNvbGVMb2dnZXInO1xyXG5cclxuY29uc3QgaXNEZWZpbmVkID0gXy5uZWdhdGUoXy5pc1VuZGVmaW5lZCk7XHJcblxyXG4vKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZSAqL1xyXG5leHBvcnQgY29uc3QgSUNvbm5lY3Rpb24gPSBTeW1ib2wuZm9yKCdJQ29ubmVjdGlvbicpO1xyXG5leHBvcnQgaW50ZXJmYWNlIElDb25uZWN0aW9uIHtcclxuXHJcbiAgICBsaXN0ZW4oKTogdm9pZDtcclxuXHJcbiAgICBzZW5kUmVxdWVzdDxQLCBSLCBFPih0eXBlOiBSZXF1ZXN0VHlwZTxQLCBSLCBFPiwgcGFyYW1zOiBQLCB0b2tlbjogQ2FuY2VsbGF0aW9uVG9rZW4pOiBQcm9taXNlPFI+O1xyXG4gICAgc2VuZE5vdGlmaWNhdGlvbjxQPih0eXBlOiBOb3RpZmljYXRpb25UeXBlPFA+LCBwYXJhbXM6IFApOiB2b2lkO1xyXG4gICAgb25Ob3RpZmljYXRpb248UD4odHlwZTogTm90aWZpY2F0aW9uVHlwZTxQPiwgaGFuZGxlcjogTm90aWZpY2F0aW9uSGFuZGxlcjxQPik6IHZvaWQ7XHJcbiAgICBvblJlcXVlc3Q8UCwgUiwgRT4odHlwZTogUmVxdWVzdFR5cGU8UCwgUiwgRT4sIGhhbmRsZXI6IFJlcXVlc3RIYW5kbGVyPFAsIFIsIEU+KTogdm9pZDtcclxuICAgIHRyYWNlKHZhbHVlOiBUcmFjZSwgdHJhY2VyOiBUcmFjZXIpOiB2b2lkO1xyXG5cclxuICAgIHNldHRpbmdzOiBJbml0aWFsaXplUmVzdWx0O1xyXG5cclxuICAgIGluaXRpYWxpemUocGFyYW1zOiBJbml0aWFsaXplUGFyYW1zKTogUHJvbWlzZTxJbml0aWFsaXplUmVzdWx0PjtcclxuICAgIHNodXRkb3duKCk6IFByb21pc2U8dm9pZD47XHJcbiAgICBleGl0KCk6IHZvaWQ7XHJcblxyXG4gICAgb25Mb2dNZXNzYWdlKGhhbmRsZTogTm90aWZpY2F0aW9uSGFuZGxlcjxMb2dNZXNzYWdlUGFyYW1zPik6IHZvaWQ7XHJcbiAgICBvblNob3dNZXNzYWdlKGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8U2hvd01lc3NhZ2VQYXJhbXM+KTogdm9pZDtcclxuICAgIG9uVGVsZW1ldHJ5KGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8YW55Pik6IHZvaWQ7XHJcblxyXG4gICAgLy8gZGlkQ2hhbmdlQ29uZmlndXJhdGlvbihwYXJhbXM6IERpZENoYW5nZUNvbmZpZ3VyYXRpb25QYXJhbXMpOiB2b2lkO1xyXG4gICAgLy8gZGlkQ2hhbmdlV2F0Y2hlZEZpbGVzKHBhcmFtczogRGlkQ2hhbmdlV2F0Y2hlZEZpbGVzUGFyYW1zKTogdm9pZDtcclxuXHJcbiAgICAvLyBkaWRPcGVuVGV4dERvY3VtZW50KHBhcmFtczogRGlkT3BlblRleHREb2N1bWVudFBhcmFtcyk6IHZvaWQ7XHJcbiAgICAvLyBkaWRDaGFuZ2VUZXh0RG9jdW1lbnQocGFyYW1zOiBEaWRDaGFuZ2VUZXh0RG9jdW1lbnRQYXJhbXMpOiB2b2lkO1xyXG4gICAgLy8gZGlkQ2xvc2VUZXh0RG9jdW1lbnQocGFyYW1zOiBEaWRDbG9zZVRleHREb2N1bWVudFBhcmFtcyk6IHZvaWQ7XHJcbiAgICAvLyBkaWRTYXZlVGV4dERvY3VtZW50KHBhcmFtczogRGlkU2F2ZVRleHREb2N1bWVudFBhcmFtcyk6IHZvaWQ7XHJcbiAgICAvLyBvbkRpYWdub3N0aWNzKGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8UHVibGlzaERpYWdub3N0aWNzUGFyYW1zPik6IHZvaWQ7XHJcblxyXG4gICAgZGlzcG9zZSgpOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElDb25uZWN0aW9uRXJyb3JIYW5kbGVyIHtcclxuICAgIChlcnJvcjogRXJyb3IsIG1lc3NhZ2U6IE1lc3NhZ2UsIGNvdW50OiBudW1iZXIpOiB2b2lkO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElDb25uZWN0aW9uQ2xvc2VIYW5kbGVyIHtcclxuICAgICgpOiB2b2lkO1xyXG59XHJcblxyXG5kZWNsYXJlIHZhciB2OGRlYnVnOiBhbnk7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIElDb25uZWN0aW9uT3B0aW9uc0Jhc2Uge1xyXG4gICAgZXJyb3JIYW5kbGVyOiBJQ29ubmVjdGlvbkVycm9ySGFuZGxlcjtcclxuICAgIGNsb3NlSGFuZGxlcjogSUNvbm5lY3Rpb25DbG9zZUhhbmRsZXI7XHJcbn1cclxuZXhwb3J0IGludGVyZmFjZSBJQ29ubmVjdGlvbkNyZWF0ZU9wdGlvbnMgZXh0ZW5kcyBJQ29ubmVjdGlvbk9wdGlvbnNCYXNlIHtcclxuICAgIG91dHB1dCh2YWx1ZTogc3RyaW5nKTogdm9pZDtcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIElJcGNDb25uZWN0aW9uIGV4dGVuZHMgSUNvbm5lY3Rpb25PcHRpb25zQmFzZSB7XHJcbiAgICBwcm9jZXNzPzogQ2hpbGRQcm9jZXNzO1xyXG4gICAgd3JpdGVyOiBNZXNzYWdlV3JpdGVyO1xyXG4gICAgcmVhZGVyOiBNZXNzYWdlUmVhZGVyO1xyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgSVN0ZGlvQ29ubmVjdGlvbiBleHRlbmRzIElDb25uZWN0aW9uT3B0aW9uc0Jhc2Uge1xyXG4gICAgcHJvY2Vzcz86IENoaWxkUHJvY2VzcztcclxuICAgIGlucHV0OiBOb2RlSlMuUmVhZGFibGVTdHJlYW07XHJcbiAgICBvdXRwdXQ6IE5vZGVKUy5Xcml0YWJsZVN0cmVhbTtcclxufVxyXG5leHBvcnQgdHlwZSBDb25uZWN0aW9uT3B0aW9ucyA9IElJcGNDb25uZWN0aW9uIHwgSVN0ZGlvQ29ubmVjdGlvbjtcclxuXHJcbmZ1bmN0aW9uIGlzU3RkaW9Db25uZWN0aW9uKG9wdGlvbnM6IGFueSk6IG9wdGlvbnMgaXMgSVN0ZGlvQ29ubmVjdGlvbiB7XHJcbiAgICByZXR1cm4gb3B0aW9ucy5pbnB1dCAmJiBvcHRpb25zLm91dHB1dDtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RW52aXJvbm1lbnQoZW52OiBhbnkpOiBhbnkge1xyXG4gICAgaWYgKCFlbnYpIHtcclxuICAgICAgICByZXR1cm4gcHJvY2Vzcy5lbnY7XHJcbiAgICB9XHJcbiAgICBjb25zdCByZXN1bHQ6IGFueSA9IE9iamVjdC5jcmVhdGUobnVsbCk7XHJcbiAgICBPYmplY3Qua2V5cyhwcm9jZXNzLmVudikuZm9yRWFjaChrZXkgPT4gcmVzdWx0W2tleV0gPSBwcm9jZXNzLmVudltrZXldKTtcclxuICAgIE9iamVjdC5rZXlzKGVudikuZm9yRWFjaChrZXkgPT4gcmVzdWx0W2tleV0gPSBlbnZba2V5XSk7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDb25uZWN0aW9uIGltcGxlbWVudHMgSUNvbm5lY3Rpb24ge1xyXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGUoc2VydmVyOiBJTGFuZ3VhZ2VQcm90b2NvbFNlcnZlck9wdGlvbnMsIG9wdHM6IElDb25uZWN0aW9uQ3JlYXRlT3B0aW9ucywgZGVidWc6IGJvb2xlYW4gPSBmYWxzZSk6IFByb21pc2U8Q29ubmVjdGlvbj4ge1xyXG4gICAgICAgIC8vIFdlIGdvdCBhIGZ1bmN0aW9uLlxyXG4gICAgICAgIGlmIChfLmlzRnVuY3Rpb24oc2VydmVyKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gc2VydmVyKCkudGhlbigocmVzdWx0OiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGluZm8gPSA8SVN0cmVhbUluZm8+cmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgaWYgKGluZm8ud3JpdGVyICYmIGluZm8ucmVhZGVyKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IGlucHV0OiBpbmZvLnJlYWRlciwgb3V0cHV0OiBpbmZvLndyaXRlciB9KSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGNwID0gPENoaWxkUHJvY2Vzcz5yZXN1bHQ7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IGlucHV0OiBjcC5zdGRvdXQsIG91dHB1dDogY3Auc3RkaW4sIHByb2Nlc3M6IGNwIH0pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGxldCBqc29uOiB7IGNvbW1hbmQ/OiBzdHJpbmc7IG1vZHVsZT86IHN0cmluZyB9O1xyXG4gICAgICAgIGNvbnN0IHJ1bkRlYnVnID0gPHsgcnVuOiBhbnk7IGRlYnVnOiBhbnk7IH0+c2VydmVyO1xyXG4gICAgICAgIGlmIChpc0RlZmluZWQocnVuRGVidWcucnVuKSB8fCBpc0RlZmluZWQocnVuRGVidWcuZGVidWcpKSB7XHJcbiAgICAgICAgICAgIC8vIFdlIGFyZSB1bmRlciBkZWJ1Z2dpbmcuIFNvIHVzZSBkZWJ1ZyBhcyB3ZWxsLlxyXG4gICAgICAgICAgICBpZiAodHlwZW9mIHY4ZGVidWcgPT09ICdvYmplY3QnIHx8IGRlYnVnKSB7XHJcbiAgICAgICAgICAgICAgICBqc29uID0gcnVuRGVidWcuZGVidWc7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBqc29uID0gcnVuRGVidWcucnVuO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAganNvbiA9IHNlcnZlcjtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGlzRGVmaW5lZChqc29uLm1vZHVsZSkpIHtcclxuICAgICAgICAgICAgY29uc3Qgbm9kZTogSU5vZGVNb2R1bGUgPSA8SU5vZGVNb2R1bGU+anNvbjtcclxuICAgICAgICAgICAgaWYgKG5vZGUucnVudGltZSkge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgYXJnczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnM6IElGb3JrT3B0aW9ucyA9IG5vZGUub3B0aW9ucyB8fCBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuZXhlY0FyZ3YpIHtcclxuICAgICAgICAgICAgICAgICAgICBvcHRpb25zLmV4ZWNBcmd2LmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4gYXJncy5wdXNoKGVsZW1lbnQpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGFyZ3MucHVzaChub2RlLm1vZHVsZSk7XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZS5hcmdzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5hcmdzLmZvckVhY2goKGVsZW1lbnQ6IGFueSkgPT4gYXJncy5wdXNoKGVsZW1lbnQpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IGV4ZWNPcHRpb25zOiBJRXhlY3V0YWJsZU9wdGlvbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgZXhlY09wdGlvbnMuY3dkID0gb3B0aW9ucy5jd2QgfHwgYXRvbS5wcm9qZWN0LmdldFBhdGhzKClbMF07XHJcbiAgICAgICAgICAgICAgICBleGVjT3B0aW9ucy5lbnYgPSBnZXRFbnZpcm9ubWVudChvcHRpb25zLmVudik7XHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZS50cmFuc3BvcnQgPT09IFRyYW5zcG9ydEtpbmQuaXBjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXhlY09wdGlvbnMuc3RkaW8gPSBbbnVsbCwgbnVsbCwgbnVsbCwgPGFueT4naXBjJ107XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9jZXNzID0gc3Bhd24obm9kZS5ydW50aW1lLCBhcmdzLCBleGVjT3B0aW9ucyk7XHJcbiAgICAgICAgICAgICAgICBpZiAoIXByb2Nlc3MgfHwgIXByb2Nlc3MucGlkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0PENvbm5lY3Rpb24+KGBMYXVuY2hpbmcgc2VydmVyIHVzaW5nIHJ1bnRpbWUgJHtub2RlLnJ1bnRpbWV9IGZhaWxlZC5gKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIC8vIEEgc3Bhd25lZCBwcm9jZXNzIGRvZXNuJ3QgaGF2ZSBpcGMgdHJhbnNwb3J0IGV2ZW4gaWYgd2Ugc3Bhd24gbm9kZS4gRm9yIG5vdyBhbHdheXMgdXNlIHN0ZGlvIGNvbW11bmljYXRpb24uXHJcbiAgICAgICAgICAgICAgICBpZiAobm9kZS50cmFuc3BvcnQgPT09IFRyYW5zcG9ydEtpbmQuaXBjKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YTogYW55KSA9PiBvcHRzLm91dHB1dChkYXRhLnRvU3RyaW5nKCkpKTtcclxuICAgICAgICAgICAgICAgICAgICBwcm9jZXNzLnN0ZGVyci5vbignZGF0YScsIChkYXRhOiBhbnkpID0+IG9wdHMub3V0cHV0KGRhdGEudG9TdHJpbmcoKSkpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgSVBDTWVzc2FnZVJlYWRlcihwcm9jZXNzKTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB3cml0ZXIgPSBuZXcgSVBDTWVzc2FnZVdyaXRlcihwcm9jZXNzKTtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IHJlYWRlciwgd3JpdGVyLCBwcm9jZXNzIH0pKSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobmV3IENvbm5lY3Rpb24oXy5hc3NpZ24oe30sIG9wdHMsIHsgaW5wdXQ6IHByb2Nlc3Muc3Rkb3V0LCBvdXRwdXQ6IHByb2Nlc3Muc3RkaW4gfSkpKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxDb25uZWN0aW9uPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3B0aW9uczogSUZvcmtPcHRpb25zID0gbm9kZS5vcHRpb25zIHx8IE9iamVjdC5jcmVhdGUobnVsbCk7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5leGVjQXJndiA9IG9wdGlvbnMuZXhlY0FyZ3YgfHwgW107XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5jd2QgPSBvcHRpb25zLmN3ZCB8fCBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVswXTtcclxuICAgICAgICAgICAgICAgICAgICBmb3JrKG5vZGUubW9kdWxlLCBub2RlLmFyZ3MgfHwgW10sIG9wdGlvbnMsIChlcnJvciwgY3ApID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUudHJhbnNwb3J0ID09PSBUcmFuc3BvcnRLaW5kLmlwYykge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNwLnN0ZG91dC5vbignZGF0YScsIChkYXRhOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3B0cy5vdXRwdXQoZGF0YS50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWFkZXIgPSBuZXcgSVBDTWVzc2FnZVJlYWRlcihjcCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgd3JpdGVyID0gbmV3IElQQ01lc3NhZ2VXcml0ZXIoY3ApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IENvbm5lY3Rpb24oXy5hc3NpZ24oe30sIG9wdHMsIHsgcmVhZGVyLCB3cml0ZXIsIHByb2Nlc3M6IGNwIH0pKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUobmV3IENvbm5lY3Rpb24oXy5hc3NpZ24oe30sIG9wdHMsIHsgaW5wdXQ6IGNwLnN0ZG91dCwgb3V0cHV0OiBjcC5zdGRpbiB9KSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSBpZiAoaXNEZWZpbmVkKGpzb24uY29tbWFuZCkpIHtcclxuICAgICAgICAgICAgY29uc3QgY29tbWFuZDogSUV4ZWN1dGFibGUgPSA8SUV4ZWN1dGFibGU+anNvbjtcclxuICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGNvbW1hbmQub3B0aW9ucyB8fCB7fTtcclxuICAgICAgICAgICAgb3B0aW9ucy5jd2QgPSBvcHRpb25zLmN3ZCB8fCBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKVswXTtcclxuICAgICAgICAgICAgY29uc3QgcHJvY2VzcyA9IHNwYXduKGNvbW1hbmQuY29tbWFuZCwgY29tbWFuZC5hcmdzLCBjb21tYW5kLm9wdGlvbnMpO1xyXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IGlucHV0OiBwcm9jZXNzLnN0ZG91dCwgb3V0cHV0OiBwcm9jZXNzLnN0ZGluLCBwcm9jZXNzIH0pKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdDxDb25uZWN0aW9uPihuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHNlcnZlciBjb25maWd1YXJ0aW9uIGAgKyBKU09OLnN0cmluZ2lmeShzZXJ2ZXIsIG51bGwsIDQpKSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfY29ubmVjdGlvbjogQ2xpZW50TWVzc2FnZUNvbm5lY3Rpb247XHJcbiAgICBwcml2YXRlIF9wcm9jZXNzOiBDaGlsZFByb2Nlc3M7XHJcblxyXG4gICAgY29uc3RydWN0b3Iob3B0aW9uczogQ29ubmVjdGlvbk9wdGlvbnMpIHtcclxuICAgICAgICBsZXQgaW5wdXQ6IGFueTtcclxuICAgICAgICBsZXQgb3V0cHV0OiBhbnk7XHJcbiAgICAgICAgY29uc3Qge2Nsb3NlSGFuZGxlciwgZXJyb3JIYW5kbGVyLCBwcm9jZXNzfSA9IG9wdGlvbnM7XHJcbiAgICAgICAgaWYgKHByb2Nlc3MpIHtcclxuICAgICAgICAgICAgdGhpcy5fcHJvY2VzcyA9IHByb2Nlc3M7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpc1N0ZGlvQ29ubmVjdGlvbihvcHRpb25zKSkge1xyXG4gICAgICAgICAgICBpbnB1dCA9IG9wdGlvbnMuaW5wdXQ7XHJcbiAgICAgICAgICAgIG91dHB1dCA9IG9wdGlvbnMub3V0cHV0O1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlucHV0ID0gb3B0aW9ucy5yZWFkZXI7XHJcbiAgICAgICAgICAgIG91dHB1dCA9IG9wdGlvbnMud3JpdGVyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgbG9nZ2VyID0gbmV3IENvbnNvbGVMb2dnZXIoKTtcclxuICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gY3JlYXRlQ2xpZW50TWVzc2FnZUNvbm5lY3Rpb24oaW5wdXQsIG91dHB1dCwgbG9nZ2VyKTtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uID0gY29ubmVjdGlvbjtcclxuICAgICAgICBjb25uZWN0aW9uLm9uRXJyb3IoKGRhdGEpID0+IHsgZXJyb3JIYW5kbGVyKGRhdGFbMF0sIGRhdGFbMV0sIGRhdGFbMl0pOyB9KTtcclxuICAgICAgICBjb25uZWN0aW9uLm9uQ2xvc2UoY2xvc2VIYW5kbGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9zZXR0aW5nczogSW5pdGlhbGl6ZVJlc3VsdDtcclxuICAgIHB1YmxpYyBnZXQgc2V0dGluZ3MoKSB7IHJldHVybiB0aGlzLl9zZXR0aW5nczsgfVxyXG5cclxuICAgIHB1YmxpYyBjb25uZWN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBsaXN0ZW4oKSB7XHJcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5saXN0ZW4oKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2VuZFJlcXVlc3Q8UCwgUiwgRT4odHlwZTogUmVxdWVzdFR5cGU8UCwgUiwgRT4sIHBhcmFtczogUCwgdG9rZW46IENhbmNlbGxhdGlvblRva2VuKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZFJlcXVlc3QodHlwZSwgcGFyYW1zLCB0b2tlbik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNlbmROb3RpZmljYXRpb248UD4odHlwZTogTm90aWZpY2F0aW9uVHlwZTxQPiwgcGFyYW1zOiBQKSB7XHJcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5zZW5kTm90aWZpY2F0aW9uKHR5cGUsIHBhcmFtcyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG9uTm90aWZpY2F0aW9uPFA+KHR5cGU6IE5vdGlmaWNhdGlvblR5cGU8UD4sIGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8UD4pIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLm9uTm90aWZpY2F0aW9uKHR5cGUsIGhhbmRsZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBvblJlcXVlc3Q8UCwgUiwgRT4odHlwZTogUmVxdWVzdFR5cGU8UCwgUiwgRT4sIGhhbmRsZXI6IFJlcXVlc3RIYW5kbGVyPFAsIFIsIEU+KSB7XHJcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5vblJlcXVlc3QodHlwZSwgaGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHRyYWNlKHZhbHVlOiBUcmFjZSwgdHJhY2VyOiBUcmFjZXIpIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnRyYWNlKHZhbHVlLCB0cmFjZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpbml0aWFsaXplKHBhcmFtczogSW5pdGlhbGl6ZVBhcmFtcykge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRSZXF1ZXN0KEluaXRpYWxpemVSZXF1ZXN0LnR5cGUsIHBhcmFtcylcclxuICAgICAgICAgICAgLnRoZW4oeCA9PiB0aGlzLl9zZXR0aW5ncyA9IHgpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBzaHV0ZG93bigpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kUmVxdWVzdChTaHV0ZG93blJlcXVlc3QudHlwZSwgdW5kZWZpbmVkKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgZXhpdCgpIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmROb3RpZmljYXRpb24oRXhpdE5vdGlmaWNhdGlvbi50eXBlKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb25Mb2dNZXNzYWdlKGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8TG9nTWVzc2FnZVBhcmFtcz4pIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLm9uTm90aWZpY2F0aW9uKExvZ01lc3NhZ2VOb3RpZmljYXRpb24udHlwZSwgaGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG9uU2hvd01lc3NhZ2UoaGFuZGxlcjogTm90aWZpY2F0aW9uSGFuZGxlcjxTaG93TWVzc2FnZVBhcmFtcz4pIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLm9uTm90aWZpY2F0aW9uKFNob3dNZXNzYWdlTm90aWZpY2F0aW9uLnR5cGUsIGhhbmRsZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBvblRlbGVtZXRyeShoYW5kbGVyOiBOb3RpZmljYXRpb25IYW5kbGVyPGFueT4pIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLm9uTm90aWZpY2F0aW9uKFRlbGVtZXRyeUV2ZW50Tm90aWZpY2F0aW9uLnR5cGUsIGhhbmRsZXIpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBkaXNwb3NlKCkge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uZGlzcG9zZSgpO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==