"use strict";
/**
 *  @license   MIT
 *  @copyright OmniSharp Team
 *  @summary   Adds support for https://github.com/Microsoft/language-server-protocol (and more!) to https://atom.io
 */
/* tslint:disable:no-any */
var _ = require('lodash');
var atom_languageservices_1 = require('atom-languageservices');
/* tslint:disable */
var protocol_1 = require('atom-languageservices/protocol');
/* tslint:enable */
/* tslint:disable:no-any */
var child_process_1 = require('child_process');
var vscode_jsonrpc_1 = require('vscode-jsonrpc');
var electron_1 = require('./utils/electron');
var ConsoleLogger_1 = require('./ConsoleLogger');
var isDefined = _.negate(_.isUndefined);
/* tslint:disable-next-line:variable-name */
exports.IConnection = Symbol.for('IConnection');
function isStdioConnection(options) {
    return options.input && options.output;
}
function getEnvironment(env) {
    if (!env) {
        return process.env;
    }
    var result = Object.create(null);
    Object.keys(process.env).forEach(function (key) { return result[key] = process.env[key]; });
    Object.keys(env).forEach(function (key) { return result[key] = env[key]; });
}
var Connection = (function () {
    function Connection(options) {
        var input;
        var output;
        var closeHandler = options.closeHandler, errorHandler = options.errorHandler, process = options.process;
        if (process) {
            this._process = process;
        }
        if (isStdioConnection(options)) {
            input = options.input;
            output = options.output;
        }
        else {
            input = options.reader;
            output = options.writer;
        }
        var logger = new ConsoleLogger_1.ConsoleLogger();
        var connection = vscode_jsonrpc_1.createClientMessageConnection(input, output, logger);
        this._connection = connection;
        connection.onError(function (data) { errorHandler(data[0], data[1], data[2]); });
        connection.onClose(closeHandler);
    }
    Connection.create = function (server, opts, debug) {
        if (debug === void 0) { debug = false; }
        // We got a function.
        if (_.isFunction(server)) {
            return server().then(function (result) {
                var info = result;
                if (info.writer && info.reader) {
                    return new Connection(_.assign({}, opts, { input: info.reader, output: info.writer }));
                }
                else {
                    var cp = result;
                    return new Connection(_.assign({}, opts, { input: cp.stdout, output: cp.stdin, process: cp }));
                }
            });
        }
        var json;
        var runDebug = server;
        if (isDefined(runDebug.run) || isDefined(runDebug.debug)) {
            // We are under debugging. So use debug as well.
            if (typeof v8debug === 'object' || debug) {
                json = runDebug.debug;
            }
            else {
                json = runDebug.run;
            }
        }
        else {
            json = server;
        }
        if (isDefined(json.module)) {
            var node_1 = json;
            if (node_1.runtime) {
                var args_1 = [];
                var options = node_1.options || Object.create(null);
                if (options.execArgv) {
                    options.execArgv.forEach(function (element) { return args_1.push(element); });
                }
                args_1.push(node_1.module);
                if (node_1.args) {
                    node_1.args.forEach(function (element) { return args_1.push(element); });
                }
                var execOptions = Object.create(null);
                execOptions.cwd = options.cwd || atom.project.getPaths()[0];
                execOptions.env = getEnvironment(options.env);
                if (node_1.transport === atom_languageservices_1.TransportKind.ipc) {
                    execOptions.stdio = [null, null, null, 'ipc'];
                }
                var process_1 = child_process_1.spawn(node_1.runtime, args_1, execOptions);
                if (!process_1 || !process_1.pid) {
                    return Promise.reject("Launching server using runtime " + node_1.runtime + " failed.");
                }
                // A spawned process doesn't have ipc transport even if we spawn node. For now always use stdio communication.
                if (node_1.transport === atom_languageservices_1.TransportKind.ipc) {
                    process_1.stdout.on('data', function (data) { return opts.output(data.toString()); });
                    process_1.stderr.on('data', function (data) { return opts.output(data.toString()); });
                    var reader = new vscode_jsonrpc_1.IPCMessageReader(process_1);
                    var writer = new vscode_jsonrpc_1.IPCMessageWriter(process_1);
                    return Promise.resolve(new Connection(_.assign({}, opts, { reader: reader, writer: writer, process: process_1 })));
                }
                else {
                    return Promise.resolve(new Connection(_.assign({}, opts, { input: process_1.stdout, output: process_1.stdin })));
                }
            }
            else {
                return new Promise(function (resolve, reject) {
                    var options = node_1.options || Object.create(null);
                    options.execArgv = options.execArgv || [];
                    options.cwd = options.cwd || atom.project.getPaths()[0];
                    electron_1.fork(node_1.module, node_1.args || [], options, function (error, cp) {
                        if (error) {
                            reject(error);
                        }
                        else {
                            if (node_1.transport === atom_languageservices_1.TransportKind.ipc) {
                                cp.stdout.on('data', function (data) {
                                    opts.output(data.toString());
                                });
                                var reader = new vscode_jsonrpc_1.IPCMessageReader(cp);
                                var writer = new vscode_jsonrpc_1.IPCMessageWriter(cp);
                                resolve(new Connection(_.assign({}, opts, { reader: reader, writer: writer, process: cp })));
                            }
                            else {
                                resolve(new Connection(_.assign({}, opts, { input: cp.stdout, output: cp.stdin })));
                            }
                        }
                    });
                });
            }
        }
        else if (isDefined(json.command)) {
            var command = json;
            var options = command.options || {};
            options.cwd = options.cwd || atom.project.getPaths()[0];
            var process_2 = child_process_1.spawn(command.command, command.args, command.options);
            return Promise.resolve(new Connection(_.assign({}, opts, { input: process_2.stdout, output: process_2.stdin, process: process_2 })));
        }
        return Promise.reject(new Error("Unsupported server configuartion " + JSON.stringify(server, null, 4)));
    };
    Object.defineProperty(Connection.prototype, "settings", {
        get: function () { return this._settings; },
        enumerable: true,
        configurable: true
    });
    Connection.prototype.connection = function () {
        return this._connection;
    };
    Connection.prototype.listen = function () {
        this._connection.listen();
    };
    Connection.prototype.sendRequest = function (type, params, token) {
        return this._connection.sendRequest(type, params, token);
    };
    Connection.prototype.sendNotification = function (type, params) {
        this._connection.sendNotification(type, params);
    };
    Connection.prototype.onNotification = function (type, handler) {
        this._connection.onNotification(type, handler);
    };
    Connection.prototype.onRequest = function (type, handler) {
        this._connection.onRequest(type, handler);
    };
    Connection.prototype.trace = function (value, tracer) {
        this._connection.trace(value, tracer);
    };
    Connection.prototype.initialize = function (params) {
        var _this = this;
        return this._connection.sendRequest(protocol_1.InitializeRequest.type, params)
            .then(function (x) { return _this._settings = x; });
    };
    Connection.prototype.shutdown = function () {
        return this._connection.sendRequest(protocol_1.ShutdownRequest.type, undefined);
    };
    Connection.prototype.exit = function () {
        this._connection.sendNotification(protocol_1.ExitNotification.type);
    };
    Connection.prototype.onLogMessage = function (handler) {
        this._connection.onNotification(protocol_1.LogMessageNotification.type, handler);
    };
    Connection.prototype.onShowMessage = function (handler) {
        this._connection.onNotification(protocol_1.ShowMessageNotification.type, handler);
    };
    Connection.prototype.onTelemetry = function (handler) {
        this._connection.onNotification(protocol_1.TelemetryEventNotification.type, handler);
    };
    Connection.prototype.dispose = function () {
        this._connection.dispose();
    };
    return Connection;
}());
exports.Connection = Connection;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29ubmVjdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wcm90b2NvbC9Db25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHO0FBQ0gsMkJBQTJCO0FBQzNCLElBQVksQ0FBQyxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQzVCLHNDQUF1SSx1QkFBdUIsQ0FBQyxDQUFBO0FBQy9KLG9CQUFvQjtBQUNwQix5QkFXTyxnQ0FBZ0MsQ0FBQyxDQUFBO0FBT3hDLG1CQUFtQjtBQUNuQiwyQkFBMkI7QUFDM0IsOEJBQW9DLGVBQWUsQ0FBQyxDQUFBO0FBRXBELCtCQU1PLGdCQUFnQixDQUFDLENBQUE7QUFFeEIseUJBQXFCLGtCQUFrQixDQUFDLENBQUE7QUFDeEMsOEJBQThCLGlCQUFpQixDQUFDLENBQUE7QUFFaEQsSUFBTSxTQUFTLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUM7QUFFMUMsNENBQTRDO0FBQy9CLG1CQUFXLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQThEckQsMkJBQTJCLE9BQVk7SUFDbkMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLElBQUksT0FBTyxDQUFDLE1BQU0sQ0FBQztBQUMzQyxDQUFDO0FBRUQsd0JBQXdCLEdBQVE7SUFDNUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ1AsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7SUFDdkIsQ0FBQztJQUNELElBQU0sTUFBTSxHQUFRLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEMsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxH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LFdBQVcsQ0FBQyxXQUFXLENBQUMsMEJBQWUsQ0FBQyxJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDekUsQ0FBQztJQUVNLHlCQUFJLEdBQVg7UUFDSSxJQUFJLENBQUMsV0FBVyxDQUFDLGdCQUFnQixDQUFDLDJCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFTSxpQ0FBWSxHQUFuQixVQUFvQixPQUE4QztRQUM5RCxJQUFJLENBQUMsV0FBVyxDQUFDLGNBQWMsQ0FBQyxpQ0FBc0IsQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDMUUsQ0FBQztJQUVNLGtDQUFhLEdBQXBCLFVBQXFCLE9BQStDO1FBQ2hFLElBQUksQ0FBQyxXQUFXLENBQUMsY0FBYyxDQUFDLGtDQUF1QixDQUFDLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBRU0sZ0NBQVcsR0FBbEIsVUFBbUIsT0FBaUM7UUFDaEQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMscUNBQTBCLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFTSw0QkFBTyxHQUFkO1FBQ0ksSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBQ0wsaUJBQUM7QUFBRCxDQUFDLEFBaExELElBZ0xDO0FBaExZLGtCQUFVLGFBZ0x0QixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqICBAbGljZW5zZSAgIE1JVFxyXG4gKiAgQGNvcHlyaWdodCBPbW5pU2hhcnAgVGVhbVxyXG4gKiAgQHN1bW1hcnkgICBBZGRzIHN1cHBvcnQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvbGFuZ3VhZ2Utc2VydmVyLXByb3RvY29sIChhbmQgbW9yZSEpIHRvIGh0dHBzOi8vYXRvbS5pb1xyXG4gKi9cclxuLyogdHNsaW50OmRpc2FibGU6bm8tYW55ICovXHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgSUV4ZWN1dGFibGUsIElFeGVjdXRhYmxlT3B0aW9ucywgSUZvcmtPcHRpb25zLCBJTGFuZ3VhZ2VQcm90b2NvbFNlcnZlck9wdGlvbnMsIElOb2RlTW9kdWxlLCBJU3RyZWFtSW5mbywgVHJhbnNwb3J0S2luZCB9IGZyb20gJ2F0b20tbGFuZ3VhZ2VzZXJ2aWNlcyc7XHJcbi8qIHRzbGludDpkaXNhYmxlICovXHJcbmltcG9ydCB7XHJcbiAgICBEaWRDaGFuZ2VDb25maWd1cmF0aW9uTm90aWZpY2F0aW9uLFxyXG4gICAgRGlkQ2hhbmdlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLFxyXG4gICAgRGlkQ2hhbmdlV2F0Y2hlZEZpbGVzTm90aWZpY2F0aW9uLCBEaWRDbG9zZVRleHREb2N1bWVudE5vdGlmaWNhdGlvbixcclxuICAgIERpZE9wZW5UZXh0RG9jdW1lbnROb3RpZmljYXRpb24sXHJcbiAgICBEaWRTYXZlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLCBFeGl0Tm90aWZpY2F0aW9uLFxyXG4gICAgSW5pdGlhbGl6ZVJlcXVlc3QsXHJcbiAgICBMb2dNZXNzYWdlTm90aWZpY2F0aW9uLFxyXG4gICAgUHVibGlzaERpYWdub3N0aWNzTm90aWZpY2F0aW9uLFxyXG4gICAgU2hvd01lc3NhZ2VOb3RpZmljYXRpb24sXHJcbiAgICBTaHV0ZG93blJlcXVlc3QsIFRlbGVtZXRyeUV2ZW50Tm90aWZpY2F0aW9uXHJcbn0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzL3Byb3RvY29sJztcclxuaW1wb3J0IHtcclxuICAgIERpZENoYW5nZUNvbmZpZ3VyYXRpb25QYXJhbXMsIERpZENoYW5nZVRleHREb2N1bWVudFBhcmFtcywgRGlkQ2hhbmdlV2F0Y2hlZEZpbGVzUGFyYW1zLFxyXG4gICAgRGlkQ2xvc2VUZXh0RG9jdW1lbnRQYXJhbXMsIERpZE9wZW5UZXh0RG9jdW1lbnRQYXJhbXMsIERpZFNhdmVUZXh0RG9jdW1lbnRQYXJhbXNcclxuICAgICwgSW5pdGlhbGl6ZVBhcmFtcywgSW5pdGlhbGl6ZVJlc3VsdCwgTG9nTWVzc2FnZVBhcmFtc1xyXG4gICAgLCBQdWJsaXNoRGlhZ25vc3RpY3NQYXJhbXMsIFNob3dNZXNzYWdlUGFyYW1zXHJcbn0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzL3R5cGVzJztcclxuLyogdHNsaW50OmVuYWJsZSAqL1xyXG4vKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cclxuaW1wb3J0IHsgQ2hpbGRQcm9jZXNzLCBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xyXG5cclxuaW1wb3J0IHtcclxuICAgIENhbmNlbGxhdGlvblRva2VuLCBDbGllbnRNZXNzYWdlQ29ubmVjdGlvbiwgSVBDTWVzc2FnZVJlYWRlciwgSVBDTWVzc2FnZVdyaXRlcixcclxuICAgIE1lc3NhZ2UsIE1lc3NhZ2VSZWFkZXIsIE1lc3NhZ2VXcml0ZXIsIE5vdGlmaWNhdGlvbkhhbmRsZXIsXHJcbiAgICBOb3RpZmljYXRpb25UeXBlLCBSZXF1ZXN0SGFuZGxlciwgUmVxdWVzdFR5cGUsXHJcbiAgICBUcmFjZSwgVHJhY2VyLFxyXG4gICAgY3JlYXRlQ2xpZW50TWVzc2FnZUNvbm5lY3Rpb25cclxufSBmcm9tICd2c2NvZGUtanNvbnJwYyc7XHJcblxyXG5pbXBvcnQgeyBmb3JrIH0gZnJvbSAnLi91dGlscy9lbGVjdHJvbic7XHJcbmltcG9ydCB7IENvbnNvbGVMb2dnZXIgfSBmcm9tICcuL0NvbnNvbGVMb2dnZXInO1xyXG5cclxuY29uc3QgaXNEZWZpbmVkID0gXy5uZWdhdGUoXy5pc1VuZGVmaW5lZCk7XHJcblxyXG4vKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6dmFyaWFibGUtbmFtZSAqL1xyXG5leHBvcnQgY29uc3QgSUNvbm5lY3Rpb24gPSBTeW1ib2wuZm9yKCdJQ29ubmVjdGlvbicpO1xyXG5leHBvcnQgaW50ZXJmYWNlIElDb25uZWN0aW9uIHtcclxuXHJcbiAgICBsaXN0ZW4oKTogdm9pZDtcclxuXHJcbiAgICBzZW5kUmVxdWVzdDxQLCBSLCBFPih0eXBlOiBSZXF1ZXN0VHlwZTxQLCBSLCBFPiwgcGFyYW1zOiBQLCB0b2tlbj86IENhbmNlbGxhdGlvblRva2VuKTogUHJvbWlzZTxSPjtcclxuICAgIHNlbmROb3RpZmljYXRpb248UD4odHlwZTogTm90aWZpY2F0aW9uVHlwZTxQPiwgcGFyYW1zOiBQKTogdm9pZDtcclxuICAgIG9uTm90aWZpY2F0aW9uPFA+KHR5cGU6IE5vdGlmaWNhdGlvblR5cGU8UD4sIGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8UD4pOiB2b2lkO1xyXG4gICAgb25SZXF1ZXN0PFAsIFIsIEU+KHR5cGU6IFJlcXVlc3RUeXBlPFAsIFIsIEU+LCBoYW5kbGVyOiBSZXF1ZXN0SGFuZGxlcjxQLCBSLCBFPik6IHZvaWQ7XHJcbiAgICB0cmFjZSh2YWx1ZTogVHJhY2UsIHRyYWNlcjogVHJhY2VyKTogdm9pZDtcclxuXHJcbiAgICBzZXR0aW5nczogSW5pdGlhbGl6ZVJlc3VsdDtcclxuXHJcbiAgICBpbml0aWFsaXplKHBhcmFtczogSW5pdGlhbGl6ZVBhcmFtcyk6IFByb21pc2U8SW5pdGlhbGl6ZVJlc3VsdD47XHJcbiAgICBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+O1xyXG4gICAgZXhpdCgpOiB2b2lkO1xyXG5cclxuICAgIG9uTG9nTWVzc2FnZShoYW5kbGU6IE5vdGlmaWNhdGlvbkhhbmRsZXI8TG9nTWVzc2FnZVBhcmFtcz4pOiB2b2lkO1xyXG4gICAgb25TaG93TWVzc2FnZShoYW5kbGVyOiBOb3RpZmljYXRpb25IYW5kbGVyPFNob3dNZXNzYWdlUGFyYW1zPik6IHZvaWQ7XHJcbiAgICBvblRlbGVtZXRyeShoYW5kbGVyOiBOb3RpZmljYXRpb25IYW5kbGVyPGFueT4pOiB2b2lkO1xyXG5cclxuICAgIC8vIGRpZENoYW5nZUNvbmZpZ3VyYXRpb24ocGFyYW1zOiBEaWRDaGFuZ2VDb25maWd1cmF0aW9uUGFyYW1zKTogdm9pZDtcclxuICAgIC8vIGRpZENoYW5nZVdhdGNoZWRGaWxlcyhwYXJhbXM6IERpZENoYW5nZVdhdGNoZWRGaWxlc1BhcmFtcyk6IHZvaWQ7XHJcblxyXG4gICAgLy8gZGlkT3BlblRleHREb2N1bWVudChwYXJhbXM6IERpZE9wZW5UZXh0RG9jdW1lbnRQYXJhbXMpOiB2b2lkO1xyXG4gICAgLy8gZGlkQ2hhbmdlVGV4dERvY3VtZW50KHBhcmFtczogRGlkQ2hhbmdlVGV4dERvY3VtZW50UGFyYW1zKTogdm9pZDtcclxuICAgIC8vIGRpZENsb3NlVGV4dERvY3VtZW50KHBhcmFtczogRGlkQ2xvc2VUZXh0RG9jdW1lbnRQYXJhbXMpOiB2b2lkO1xyXG4gICAgLy8gZGlkU2F2ZVRleHREb2N1bWVudChwYXJhbXM6IERpZFNhdmVUZXh0RG9jdW1lbnRQYXJhbXMpOiB2b2lkO1xyXG4gICAgLy8gb25EaWFnbm9zdGljcyhoYW5kbGVyOiBOb3RpZmljYXRpb25IYW5kbGVyPFB1Ymxpc2hEaWFnbm9zdGljc1BhcmFtcz4pOiB2b2lkO1xyXG5cclxuICAgIGRpc3Bvc2UoKTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJQ29ubmVjdGlvbkVycm9ySGFuZGxlciB7XHJcbiAgICAoZXJyb3I6IEVycm9yLCBtZXNzYWdlOiBNZXNzYWdlLCBjb3VudDogbnVtYmVyKTogdm9pZDtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJQ29ubmVjdGlvbkNsb3NlSGFuZGxlciB7XHJcbiAgICAoKTogdm9pZDtcclxufVxyXG5cclxuZGVjbGFyZSB2YXIgdjhkZWJ1ZzogYW55O1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBJQ29ubmVjdGlvbk9wdGlvbnNCYXNlIHtcclxuICAgIGVycm9ySGFuZGxlcjogSUNvbm5lY3Rpb25FcnJvckhhbmRsZXI7XHJcbiAgICBjbG9zZUhhbmRsZXI6IElDb25uZWN0aW9uQ2xvc2VIYW5kbGVyO1xyXG59XHJcbmV4cG9ydCBpbnRlcmZhY2UgSUNvbm5lY3Rpb25DcmVhdGVPcHRpb25zIGV4dGVuZHMgSUNvbm5lY3Rpb25PcHRpb25zQmFzZSB7XHJcbiAgICBvdXRwdXQodmFsdWU6IHN0cmluZyk6IHZvaWQ7XHJcbn1cclxuZXhwb3J0IGludGVyZmFjZSBJSXBjQ29ubmVjdGlvbiBleHRlbmRzIElDb25uZWN0aW9uT3B0aW9uc0Jhc2Uge1xyXG4gICAgcHJvY2Vzcz86IENoaWxkUHJvY2VzcztcclxuICAgIHdyaXRlcjogTWVzc2FnZVdyaXRlcjtcclxuICAgIHJlYWRlcjogTWVzc2FnZVJlYWRlcjtcclxufVxyXG5leHBvcnQgaW50ZXJmYWNlIElTdGRpb0Nvbm5lY3Rpb24gZXh0ZW5kcyBJQ29ubmVjdGlvbk9wdGlvbnNCYXNlIHtcclxuICAgIHByb2Nlc3M/OiBDaGlsZFByb2Nlc3M7XHJcbiAgICBpbnB1dDogTm9kZUpTLlJlYWRhYmxlU3RyZWFtO1xyXG4gICAgb3V0cHV0OiBOb2RlSlMuV3JpdGFibGVTdHJlYW07XHJcbn1cclxuZXhwb3J0IHR5cGUgQ29ubmVjdGlvbk9wdGlvbnMgPSBJSXBjQ29ubmVjdGlvbiB8IElTdGRpb0Nvbm5lY3Rpb247XHJcblxyXG5mdW5jdGlvbiBpc1N0ZGlvQ29ubmVjdGlvbihvcHRpb25zOiBhbnkpOiBvcHRpb25zIGlzIElTdGRpb0Nvbm5lY3Rpb24ge1xyXG4gICAgcmV0dXJuIG9wdGlvbnMuaW5wdXQgJiYgb3B0aW9ucy5vdXRwdXQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldEVudmlyb25tZW50KGVudjogYW55KTogYW55IHtcclxuICAgIGlmICghZW52KSB7XHJcbiAgICAgICAgcmV0dXJuIHByb2Nlc3MuZW52O1xyXG4gICAgfVxyXG4gICAgY29uc3QgcmVzdWx0OiBhbnkgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG4gICAgT2JqZWN0LmtleXMocHJvY2Vzcy5lbnYpLmZvckVhY2goa2V5ID0+IHJlc3VsdFtrZXldID0gcHJvY2Vzcy5lbnZba2V5XSk7XHJcbiAgICBPYmplY3Qua2V5cyhlbnYpLmZvckVhY2goa2V5ID0+IHJlc3VsdFtrZXldID0gZW52W2tleV0pO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQ29ubmVjdGlvbiBpbXBsZW1lbnRzIElDb25uZWN0aW9uIHtcclxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlKHNlcnZlcjogSUxhbmd1YWdlUHJvdG9jb2xTZXJ2ZXJPcHRpb25zLCBvcHRzOiBJQ29ubmVjdGlvbkNyZWF0ZU9wdGlvbnMsIGRlYnVnOiBib29sZWFuID0gZmFsc2UpOiBQcm9taXNlPENvbm5lY3Rpb24+IHtcclxuICAgICAgICAvLyBXZSBnb3QgYSBmdW5jdGlvbi5cclxuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKHNlcnZlcikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHNlcnZlcigpLnRoZW4oKHJlc3VsdDogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBpbmZvID0gPElTdHJlYW1JbmZvPnJlc3VsdDtcclxuICAgICAgICAgICAgICAgIGlmIChpbmZvLndyaXRlciAmJiBpbmZvLnJlYWRlcikge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQ29ubmVjdGlvbihfLmFzc2lnbih7fSwgb3B0cywgeyBpbnB1dDogaW5mby5yZWFkZXIsIG91dHB1dDogaW5mby53cml0ZXIgfSkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBjcCA9IDxDaGlsZFByb2Nlc3M+cmVzdWx0O1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQ29ubmVjdGlvbihfLmFzc2lnbih7fSwgb3B0cywgeyBpbnB1dDogY3Auc3Rkb3V0LCBvdXRwdXQ6IGNwLnN0ZGluLCBwcm9jZXNzOiBjcCB9KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQganNvbjogeyBjb21tYW5kPzogc3RyaW5nOyBtb2R1bGU/OiBzdHJpbmcgfTtcclxuICAgICAgICBjb25zdCBydW5EZWJ1ZyA9IDx7IHJ1bjogYW55OyBkZWJ1ZzogYW55OyB9PnNlcnZlcjtcclxuICAgICAgICBpZiAoaXNEZWZpbmVkKHJ1bkRlYnVnLnJ1bikgfHwgaXNEZWZpbmVkKHJ1bkRlYnVnLmRlYnVnKSkge1xyXG4gICAgICAgICAgICAvLyBXZSBhcmUgdW5kZXIgZGVidWdnaW5nLiBTbyB1c2UgZGVidWcgYXMgd2VsbC5cclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2OGRlYnVnID09PSAnb2JqZWN0JyB8fCBkZWJ1Zykge1xyXG4gICAgICAgICAgICAgICAganNvbiA9IHJ1bkRlYnVnLmRlYnVnO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAganNvbiA9IHJ1bkRlYnVnLnJ1bjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGpzb24gPSBzZXJ2ZXI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChpc0RlZmluZWQoanNvbi5tb2R1bGUpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vZGU6IElOb2RlTW9kdWxlID0gPElOb2RlTW9kdWxlPmpzb247XHJcbiAgICAgICAgICAgIGlmIChub2RlLnJ1bnRpbWUpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGFyZ3M6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgICAgICAgICBjb25zdCBvcHRpb25zOiBJRm9ya09wdGlvbnMgPSBub2RlLm9wdGlvbnMgfHwgT2JqZWN0LmNyZWF0ZShudWxsKTtcclxuICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmV4ZWNBcmd2KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgb3B0aW9ucy5leGVjQXJndi5mb3JFYWNoKChlbGVtZW50OiBhbnkpID0+IGFyZ3MucHVzaChlbGVtZW50KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBhcmdzLnB1c2gobm9kZS5tb2R1bGUpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUuYXJncykge1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUuYXJncy5mb3JFYWNoKChlbGVtZW50OiBhbnkpID0+IGFyZ3MucHVzaChlbGVtZW50KSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBleGVjT3B0aW9uczogSUV4ZWN1dGFibGVPcHRpb25zID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcclxuICAgICAgICAgICAgICAgIGV4ZWNPcHRpb25zLmN3ZCA9IG9wdGlvbnMuY3dkIHx8IGF0b20ucHJvamVjdC5nZXRQYXRocygpWzBdO1xyXG4gICAgICAgICAgICAgICAgZXhlY09wdGlvbnMuZW52ID0gZ2V0RW52aXJvbm1lbnQob3B0aW9ucy5lbnYpO1xyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUudHJhbnNwb3J0ID09PSBUcmFuc3BvcnRLaW5kLmlwYykge1xyXG4gICAgICAgICAgICAgICAgICAgIGV4ZWNPcHRpb25zLnN0ZGlvID0gW251bGwsIG51bGwsIG51bGwsIDxhbnk+J2lwYyddO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgY29uc3QgcHJvY2VzcyA9IHNwYXduKG5vZGUucnVudGltZSwgYXJncywgZXhlY09wdGlvbnMpO1xyXG4gICAgICAgICAgICAgICAgaWYgKCFwcm9jZXNzIHx8ICFwcm9jZXNzLnBpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBQcm9taXNlLnJlamVjdDxDb25uZWN0aW9uPihgTGF1bmNoaW5nIHNlcnZlciB1c2luZyBydW50aW1lICR7bm9kZS5ydW50aW1lfSBmYWlsZWQuYCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAvLyBBIHNwYXduZWQgcHJvY2VzcyBkb2Vzbid0IGhhdmUgaXBjIHRyYW5zcG9ydCBldmVuIGlmIHdlIHNwYXduIG5vZGUuIEZvciBub3cgYWx3YXlzIHVzZSBzdGRpbyBjb21tdW5pY2F0aW9uLlxyXG4gICAgICAgICAgICAgICAgaWYgKG5vZGUudHJhbnNwb3J0ID09PSBUcmFuc3BvcnRLaW5kLmlwYykge1xyXG4gICAgICAgICAgICAgICAgICAgIHByb2Nlc3Muc3Rkb3V0Lm9uKCdkYXRhJywgKGRhdGE6IGFueSkgPT4gb3B0cy5vdXRwdXQoZGF0YS50b1N0cmluZygpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcHJvY2Vzcy5zdGRlcnIub24oJ2RhdGEnLCAoZGF0YTogYW55KSA9PiBvcHRzLm91dHB1dChkYXRhLnRvU3RyaW5nKCkpKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IElQQ01lc3NhZ2VSZWFkZXIocHJvY2Vzcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd3JpdGVyID0gbmV3IElQQ01lc3NhZ2VXcml0ZXIocHJvY2Vzcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQ29ubmVjdGlvbihfLmFzc2lnbih7fSwgb3B0cywgeyByZWFkZXIsIHdyaXRlciwgcHJvY2VzcyB9KSkpO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IGlucHV0OiBwcm9jZXNzLnN0ZG91dCwgb3V0cHV0OiBwcm9jZXNzLnN0ZGluIH0pKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8Q29ubmVjdGlvbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbnM6IElGb3JrT3B0aW9ucyA9IG5vZGUub3B0aW9ucyB8fCBPYmplY3QuY3JlYXRlKG51bGwpO1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuZXhlY0FyZ3YgPSBvcHRpb25zLmV4ZWNBcmd2IHx8IFtdO1xyXG4gICAgICAgICAgICAgICAgICAgIG9wdGlvbnMuY3dkID0gb3B0aW9ucy5jd2QgfHwgYXRvbS5wcm9qZWN0LmdldFBhdGhzKClbMF07XHJcbiAgICAgICAgICAgICAgICAgICAgZm9yayhub2RlLm1vZHVsZSwgbm9kZS5hcmdzIHx8IFtdLCBvcHRpb25zLCAoZXJyb3IsIGNwKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVqZWN0KGVycm9yKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnRyYW5zcG9ydCA9PT0gVHJhbnNwb3J0S2luZC5pcGMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjcC5zdGRvdXQub24oJ2RhdGEnLCAoZGF0YTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9wdHMub3V0cHV0KGRhdGEudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVhZGVyID0gbmV3IElQQ01lc3NhZ2VSZWFkZXIoY3ApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHdyaXRlciA9IG5ldyBJUENNZXNzYWdlV3JpdGVyKGNwKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IHJlYWRlciwgd3JpdGVyLCBwcm9jZXNzOiBjcCB9KSkpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKG5ldyBDb25uZWN0aW9uKF8uYXNzaWduKHt9LCBvcHRzLCB7IGlucHV0OiBjcC5zdGRvdXQsIG91dHB1dDogY3Auc3RkaW4gfSkpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9IGVsc2UgaWYgKGlzRGVmaW5lZChqc29uLmNvbW1hbmQpKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbW1hbmQ6IElFeGVjdXRhYmxlID0gPElFeGVjdXRhYmxlPmpzb247XHJcbiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjb21tYW5kLm9wdGlvbnMgfHwge307XHJcbiAgICAgICAgICAgIG9wdGlvbnMuY3dkID0gb3B0aW9ucy5jd2QgfHwgYXRvbS5wcm9qZWN0LmdldFBhdGhzKClbMF07XHJcbiAgICAgICAgICAgIGNvbnN0IHByb2Nlc3MgPSBzcGF3bihjb21tYW5kLmNvbW1hbmQsIGNvbW1hbmQuYXJncywgY29tbWFuZC5vcHRpb25zKTtcclxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShuZXcgQ29ubmVjdGlvbihfLmFzc2lnbih7fSwgb3B0cywgeyBpbnB1dDogcHJvY2Vzcy5zdGRvdXQsIG91dHB1dDogcHJvY2Vzcy5zdGRpbiwgcHJvY2VzcyB9KSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3Q8Q29ubmVjdGlvbj4obmV3IEVycm9yKGBVbnN1cHBvcnRlZCBzZXJ2ZXIgY29uZmlndWFydGlvbiBgICsgSlNPTi5zdHJpbmdpZnkoc2VydmVyLCBudWxsLCA0KSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX2Nvbm5lY3Rpb246IENsaWVudE1lc3NhZ2VDb25uZWN0aW9uO1xyXG4gICAgcHJpdmF0ZSBfcHJvY2VzczogQ2hpbGRQcm9jZXNzO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdGlvbnM6IENvbm5lY3Rpb25PcHRpb25zKSB7XHJcbiAgICAgICAgbGV0IGlucHV0OiBhbnk7XHJcbiAgICAgICAgbGV0IG91dHB1dDogYW55O1xyXG4gICAgICAgIGNvbnN0IHtjbG9zZUhhbmRsZXIsIGVycm9ySGFuZGxlciwgcHJvY2Vzc30gPSBvcHRpb25zO1xyXG4gICAgICAgIGlmIChwcm9jZXNzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3Byb2Nlc3MgPSBwcm9jZXNzO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoaXNTdGRpb0Nvbm5lY3Rpb24ob3B0aW9ucykpIHtcclxuICAgICAgICAgICAgaW5wdXQgPSBvcHRpb25zLmlucHV0O1xyXG4gICAgICAgICAgICBvdXRwdXQgPSBvcHRpb25zLm91dHB1dDtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBpbnB1dCA9IG9wdGlvbnMucmVhZGVyO1xyXG4gICAgICAgICAgICBvdXRwdXQgPSBvcHRpb25zLndyaXRlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGxvZ2dlciA9IG5ldyBDb25zb2xlTG9nZ2VyKCk7XHJcbiAgICAgICAgY29uc3QgY29ubmVjdGlvbiA9IGNyZWF0ZUNsaWVudE1lc3NhZ2VDb25uZWN0aW9uKGlucHV0LCBvdXRwdXQsIGxvZ2dlcik7XHJcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbiA9IGNvbm5lY3Rpb247XHJcbiAgICAgICAgY29ubmVjdGlvbi5vbkVycm9yKChkYXRhKSA9PiB7IGVycm9ySGFuZGxlcihkYXRhWzBdLCBkYXRhWzFdLCBkYXRhWzJdKTsgfSk7XHJcbiAgICAgICAgY29ubmVjdGlvbi5vbkNsb3NlKGNsb3NlSGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBfc2V0dGluZ3M6IEluaXRpYWxpemVSZXN1bHQ7XHJcbiAgICBwdWJsaWMgZ2V0IHNldHRpbmdzKCkgeyByZXR1cm4gdGhpcy5fc2V0dGluZ3M7IH1cclxuXHJcbiAgICBwdWJsaWMgY29ubmVjdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgbGlzdGVuKCkge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24ubGlzdGVuKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNlbmRSZXF1ZXN0PFAsIFIsIEU+KHR5cGU6IFJlcXVlc3RUeXBlPFAsIFIsIEU+LCBwYXJhbXM6IFAsIHRva2VuPzogQ2FuY2VsbGF0aW9uVG9rZW4pIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fY29ubmVjdGlvbi5zZW5kUmVxdWVzdCh0eXBlLCBwYXJhbXMsIHRva2VuKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2VuZE5vdGlmaWNhdGlvbjxQPih0eXBlOiBOb3RpZmljYXRpb25UeXBlPFA+LCBwYXJhbXM6IFApIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLnNlbmROb3RpZmljYXRpb24odHlwZSwgcGFyYW1zKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb25Ob3RpZmljYXRpb248UD4odHlwZTogTm90aWZpY2F0aW9uVHlwZTxQPiwgaGFuZGxlcjogTm90aWZpY2F0aW9uSGFuZGxlcjxQPikge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24ub25Ob3RpZmljYXRpb24odHlwZSwgaGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG9uUmVxdWVzdDxQLCBSLCBFPih0eXBlOiBSZXF1ZXN0VHlwZTxQLCBSLCBFPiwgaGFuZGxlcjogUmVxdWVzdEhhbmRsZXI8UCwgUiwgRT4pIHtcclxuICAgICAgICB0aGlzLl9jb25uZWN0aW9uLm9uUmVxdWVzdCh0eXBlLCBoYW5kbGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgdHJhY2UodmFsdWU6IFRyYWNlLCB0cmFjZXI6IFRyYWNlcikge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24udHJhY2UodmFsdWUsIHRyYWNlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGluaXRpYWxpemUocGFyYW1zOiBJbml0aWFsaXplUGFyYW1zKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZFJlcXVlc3QoSW5pdGlhbGl6ZVJlcXVlc3QudHlwZSwgcGFyYW1zKVxyXG4gICAgICAgICAgICAudGhlbih4ID0+IHRoaXMuX3NldHRpbmdzID0geCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHNodXRkb3duKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9jb25uZWN0aW9uLnNlbmRSZXF1ZXN0KFNodXRkb3duUmVxdWVzdC50eXBlLCB1bmRlZmluZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBleGl0KCkge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24uc2VuZE5vdGlmaWNhdGlvbihFeGl0Tm90aWZpY2F0aW9uLnR5cGUpO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBvbkxvZ01lc3NhZ2UoaGFuZGxlcjogTm90aWZpY2F0aW9uSGFuZGxlcjxMb2dNZXNzYWdlUGFyYW1zPikge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24ub25Ob3RpZmljYXRpb24oTG9nTWVzc2FnZU5vdGlmaWNhdGlvbi50eXBlLCBoYW5kbGVyKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgb25TaG93TWVzc2FnZShoYW5kbGVyOiBOb3RpZmljYXRpb25IYW5kbGVyPFNob3dNZXNzYWdlUGFyYW1zPikge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24ub25Ob3RpZmljYXRpb24oU2hvd01lc3NhZ2VOb3RpZmljYXRpb24udHlwZSwgaGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIG9uVGVsZW1ldHJ5KGhhbmRsZXI6IE5vdGlmaWNhdGlvbkhhbmRsZXI8YW55Pikge1xyXG4gICAgICAgIHRoaXMuX2Nvbm5lY3Rpb24ub25Ob3RpZmljYXRpb24oVGVsZW1ldHJ5RXZlbnROb3RpZmljYXRpb24udHlwZSwgaGFuZGxlcik7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGRpc3Bvc2UoKSB7XHJcbiAgICAgICAgdGhpcy5fY29ubmVjdGlvbi5kaXNwb3NlKCk7XHJcbiAgICB9XHJcbn1cclxuIl19