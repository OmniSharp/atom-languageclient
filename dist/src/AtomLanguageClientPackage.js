"use strict";
/**
 *  @license   MIT
 *  @copyright OmniSharp Team
 *  @summary   Adds support for https://github.com/Microsoft/language-server-protocol (and more!) to https://atom.io
 */
var _ = require('lodash');
var rxjs_1 = require('rxjs');
var atom_languageservices_1 = require('atom-languageservices');
var fs_1 = require('fs');
var path_1 = require('path');
var ts_disposables_1 = require('ts-disposables');
var index_1 = require('./atom/index');
var index_2 = require('./language/index');
var AtomLanguageClientSettings_1 = require('./AtomLanguageClientSettings');
var Container_1 = require('./di/Container');
var $readdir = rxjs_1.Observable.bindNodeCallback(fs_1.readdir);
var AtomLanguageClientPackage = (function () {
    function AtomLanguageClientPackage() {
    }
    /* tslint:disable:no-any */
    AtomLanguageClientPackage.prototype.activate = function (settings) {
        var _this = this;
        this._container = new Container_1.Container();
        this._disposable = new ts_disposables_1.CompositeDisposable();
        this._settings = settings instanceof AtomLanguageClientSettings_1.AtomLanguageClientSettings ? settings : new AtomLanguageClientSettings_1.AtomLanguageClientSettings(settings);
        this._atomLanguageProvider = new index_2.LanguageProvider(this._container);
        this._atomLanguageService = new index_2.LanguageService(this._container);
        this._atomAutocompleteProvider = new index_1.AutocompleteService();
        this._atomLinterProvider = new index_1.LinterService();
        this._atomStatusBarService = new index_1.StatusBarService();
        this._container.registerInstance(index_2.LanguageProvider, this._atomLanguageProvider);
        this._container.registerAlias(index_2.LanguageProvider, atom_languageservices_1.ILanguageProvider);
        this._container.registerInstance(index_2.LanguageService, this._atomLanguageService);
        this._container.registerAlias(index_2.LanguageService, atom_languageservices_1.ILanguageService);
        this._container.registerInstance(index_1.AutocompleteService, this._atomAutocompleteProvider);
        this._container.registerAlias(index_1.AutocompleteService, atom_languageservices_1.IAutocompleteService);
        this._container.registerInstance(index_1.LinterService, this._atomLinterProvider);
        this._container.registerAlias(index_1.LinterService, atom_languageservices_1.ILinterService);
        this._container.registerInstance(index_1.StatusBarService, this._atomStatusBarService);
        this._container.registerAlias(index_1.StatusBarService, atom_languageservices_1.IStatusBarService);
        this._container.registerInstance(atom_languageservices_1.IResolver, this._container);
        this._disposable.add(this._container, this._atomLanguageProvider, this._atomLanguageService);
        var activateServices = rxjs_1.Observable.merge(this._container.registerFolder(__dirname, 'atom'), this._container.registerFolder(__dirname, 'capabilities'), this._container.registerFolder(__dirname, 'services'), this._container.registerFolder(__dirname, 'ui'))
            .toPromise()
            .then(function () {
            _this._container.registerInterfaceSymbols();
        });
        this.activated = activateServices;
        /* We're going to pretend to load these packages, as if they were real */
        var pathToPlugins = path_1.resolve(__dirname, '../', 'plugins');
        this.activated.then(function () {
            return $readdir(pathToPlugins)
                .mergeMap(function (folders) {
                return rxjs_1.Observable.from(folders)
                    .mergeMap(function (folder) { return $readdir(path_1.join(pathToPlugins, folder))
                    .mergeMap(function (files) { return files; })
                    .filter(function (x) { return _.endsWith(x, 'Package.ts'); })
                    .map(function (x) { return path_1.join(pathToPlugins, folder, _.trimEnd(x, '.ts')); }); })
                    .map(function (path) { return require(path); })
                    .map(function (module) {
                    var cls = _.find(module, _.isFunction);
                    return new cls();
                })
                    .map(function (instance) {
                    if (instance['consume-atom-language-client']) {
                        instance['consume-atom-language-client'](_this._atomLanguageService);
                    }
                    if (instance['provide-atom-language']) {
                        _this['consume-atom-language'](instance['provide-atom-language']());
                    }
                });
            })
                .toPromise();
        });
        this.activated.then(function () {
            /* tslint:disable-next-line:no-require-imports */
            _this._container.resolveEach(_.values(require('./ui/UserInterface')));
        });
    };
    /* tslint:disable-next-line:function-name */
    AtomLanguageClientPackage.prototype['provide-atom-language-client'] = function () {
        return this._atomLanguageService;
    };
    /* tslint:disable-next-line:function-name */
    AtomLanguageClientPackage.prototype['provide-atom-autocomplete'] = function () {
        return [this._atomAutocompleteProvider];
    };
    /* tslint:disable-next-line:function-name */
    AtomLanguageClientPackage.prototype['consume-atom-language'] = function (services) {
        var _this = this;
        if (_.isArray(services)) {
            _.each(services, function (service) {
                _this._atomLanguageProvider.add(service);
                if (ts_disposables_1.isDisposable(service)) {
                    _this._disposable.add(service);
                }
            });
        }
        else {
            this._atomLanguageProvider.add(services);
            if (ts_disposables_1.isDisposable(services)) {
                this._disposable.add(services);
            }
        }
    };
    /* tslint:disable-next-line:function-name */
    AtomLanguageClientPackage.prototype['consume-atom-linter'] = function (service) {
        this._atomLinterProvider.registry = service;
    };
    /* tslint:disable-next-line:function-name */
    AtomLanguageClientPackage.prototype['consume-status-bar'] = function (service) {
        this._atomStatusBarService.api = service;
    };
    /* tslint:disable-next-line:no-any */
    AtomLanguageClientPackage.deserialize = function (state) {
        return new AtomLanguageClientSettings_1.AtomLanguageClientSettings(state);
    };
    AtomLanguageClientPackage.prototype.serialize = function () {
        return this._settings.serialize(AtomLanguageClientPackage);
    };
    AtomLanguageClientPackage.prototype.deactivate = function () {
        this._disposable.dispose();
    };
    Object.defineProperty(AtomLanguageClientPackage, "version", {
        get: function () { return 1; },
        enumerable: true,
        configurable: true
    });
    return AtomLanguageClientPackage;
}());
exports.AtomLanguageClientPackage = AtomLanguageClientPackage;
atom.deserializers.add(AtomLanguageClientPackage);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXRvbUxhbmd1YWdlQ2xpZW50UGFja2FnZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9BdG9tTGFuZ3VhZ2VDbGllbnRQYWNrYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztHQUlHO0FBQ0gsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFDNUIscUJBQTJCLE1BQU0sQ0FBQyxDQUFBO0FBQ2xDLHNDQUEySSx1QkFBdUIsQ0FBQyxDQUFBO0FBQ25LLG1CQUF3QixJQUFJLENBQUMsQ0FBQTtBQUM3QixxQkFBOEIsTUFBTSxDQUFDLENBQUE7QUFDckMsK0JBQWtELGdCQUFnQixDQUFDLENBQUE7QUFDbkUsc0JBQXFFLGNBQWMsQ0FBQyxDQUFBO0FBQ3BGLHNCQUFrRCxrQkFBa0IsQ0FBQyxDQUFBO0FBQ3JFLDJDQUF3RSw4QkFBOEIsQ0FBQyxDQUFBO0FBQ3ZHLDBCQUEwQixnQkFBZ0IsQ0FBQyxDQUFBO0FBRTNDLElBQU0sUUFBUSxHQUFHLGlCQUFVLENBQUMsZ0JBQWdCLENBQUMsWUFBTyxDQUFDLENBQUM7QUFFdEQ7SUFBQTtJQWtKQSxDQUFDO0lBdklHLDJCQUEyQjtJQUNwQiw0Q0FBUSxHQUFmLFVBQWdCLFFBQXFDO1FBQXJELGlCQWlGQztRQWhGRyxJQUFJLENBQUMsVUFBVSxHQUFHLElBQUkscUJBQVMsRUFBRSxDQUFDO1FBQ2xDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxvQ0FBbUIsRUFBRSxDQUFDO1FBQzdDLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxZQUFZLHVEQUEwQixHQUFHLFFBQVEsR0FBRyxJQUFJLHVEQUEwQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXRILElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLHdCQUFnQixDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuRSxJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSx1QkFBZSxDQUFDLElBQUksQ0FBQyxV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Q0FBQztJQUNMLENBQUM7SUFFRCw0Q0FBNEM7SUFDckMsb0NBQUMscUJBQXFCLENBQUMsR0FBOUIsVUFBK0IsT0FBNkI7UUFDeEQsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsR0FBRyxPQUFPLENBQUM7SUFDaEQsQ0FBQztJQUVELDRDQUE0QztJQUNyQyxvQ0FBQyxvQkFBb0IsQ0FBQyxHQUE3QixVQUE4QixPQUFzQjtRQUNoRCxJQUFJLENBQUMscUJBQXFCLENBQUMsR0FBRyxHQUFHLE9BQU8sQ0FBQztJQUM3QyxDQUFDO0lBRUQscUNBQXFDO0lBQ3ZCLHFDQUFXLEdBQXpCLFVBQTBCLEtBQWtDO1FBQ3hELE1BQU0sQ0FBQyxJQUFJLHVEQUEwQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFTSw2Q0FBUyxHQUFoQjtRQUNJLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFTSw4Q0FBVSxHQUFqQjtRQUNJLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDL0IsQ0FBQztJQUVELHNCQUFrQixvQ0FBTzthQUF6QixjQUE4QixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzs7O09BQUE7SUFDN0MsZ0NBQUM7QUFBRCxDQUFDLEFBbEpELElBa0pDO0FBbEpZLGlDQUF5Qiw0QkFrSnJDLENBQUE7QUFFRCxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqICBAbGljZW5zZSAgIE1JVFxyXG4gKiAgQGNvcHlyaWdodCBPbW5pU2hhcnAgVGVhbVxyXG4gKiAgQHN1bW1hcnkgICBBZGRzIHN1cHBvcnQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9NaWNyb3NvZnQvbGFuZ3VhZ2Utc2VydmVyLXByb3RvY29sIChhbmQgbW9yZSEpIHRvIGh0dHBzOi8vYXRvbS5pb1xyXG4gKi9cclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IElBdXRvY29tcGxldGVTZXJ2aWNlLCBJTGFuZ3VhZ2VQcm92aWRlciwgSUxhbmd1YWdlU2VydmljZSwgSUxpbnRlclNlcnZpY2UsIElSZXNvbHZlciwgSVN0YXR1c0JhclNlcnZpY2UsIExpbnRlciwgU3RhdHVzQmFyIH0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzJztcclxuaW1wb3J0IHsgcmVhZGRpciB9IGZyb20gJ2ZzJztcclxuaW1wb3J0IHsgam9pbiwgcmVzb2x2ZSB9IGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBDb21wb3NpdGVEaXNwb3NhYmxlLCBpc0Rpc3Bvc2FibGUgfSBmcm9tICd0cy1kaXNwb3NhYmxlcyc7XHJcbmltcG9ydCB7IEF1dG9jb21wbGV0ZVNlcnZpY2UsIExpbnRlclNlcnZpY2UsIFN0YXR1c0JhclNlcnZpY2UgfSBmcm9tICcuL2F0b20vaW5kZXgnO1xyXG5pbXBvcnQgeyBMYW5ndWFnZVByb3ZpZGVyLCBMYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuL2xhbmd1YWdlL2luZGV4JztcclxuaW1wb3J0IHsgQXRvbUxhbmd1YWdlQ2xpZW50U2V0dGluZ3MsIElBdG9tTGFuZ3VhZ2VDbGllbnRTZXR0aW5ncyB9IGZyb20gJy4vQXRvbUxhbmd1YWdlQ2xpZW50U2V0dGluZ3MnO1xyXG5pbXBvcnQgeyBDb250YWluZXIgfSBmcm9tICcuL2RpL0NvbnRhaW5lcic7XHJcblxyXG5jb25zdCAkcmVhZGRpciA9IE9ic2VydmFibGUuYmluZE5vZGVDYWxsYmFjayhyZWFkZGlyKTtcclxuXHJcbmV4cG9ydCBjbGFzcyBBdG9tTGFuZ3VhZ2VDbGllbnRQYWNrYWdlIGltcGxlbWVudHMgSUF0b21QYWNrYWdlPEF0b21MYW5ndWFnZUNsaWVudFNldHRpbmdzPiB7XHJcbiAgICBwcml2YXRlIF9jb250YWluZXI6IENvbnRhaW5lcjtcclxuICAgIHByaXZhdGUgX2Rpc3Bvc2FibGU6IENvbXBvc2l0ZURpc3Bvc2FibGU7XHJcbiAgICBwcml2YXRlIF9zZXR0aW5nczogQXRvbUxhbmd1YWdlQ2xpZW50U2V0dGluZ3M7XHJcbiAgICBwcml2YXRlIF9hdG9tTGFuZ3VhZ2VQcm92aWRlcjogTGFuZ3VhZ2VQcm92aWRlcjtcclxuICAgIHByaXZhdGUgX2F0b21MYW5ndWFnZVNlcnZpY2U6IExhbmd1YWdlU2VydmljZTtcclxuICAgIHByaXZhdGUgX2F0b21BdXRvY29tcGxldGVQcm92aWRlcjogQXV0b2NvbXBsZXRlU2VydmljZTtcclxuICAgIHByaXZhdGUgX2F0b21MaW50ZXJQcm92aWRlcjogTGludGVyU2VydmljZTtcclxuICAgIHByaXZhdGUgX2F0b21TdGF0dXNCYXJTZXJ2aWNlOiBTdGF0dXNCYXJTZXJ2aWNlO1xyXG4gICAgcHVibGljIGFjdGl2YXRlZDogUHJvbWlzZTx2b2lkPjtcclxuXHJcbiAgICAvKiB0c2xpbnQ6ZGlzYWJsZTpuby1hbnkgKi9cclxuICAgIHB1YmxpYyBhY3RpdmF0ZShzZXR0aW5nczogSUF0b21MYW5ndWFnZUNsaWVudFNldHRpbmdzKSB7XHJcbiAgICAgICAgdGhpcy5fY29udGFpbmVyID0gbmV3IENvbnRhaW5lcigpO1xyXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xyXG4gICAgICAgIHRoaXMuX3NldHRpbmdzID0gc2V0dGluZ3MgaW5zdGFuY2VvZiBBdG9tTGFuZ3VhZ2VDbGllbnRTZXR0aW5ncyA/IHNldHRpbmdzIDogbmV3IEF0b21MYW5ndWFnZUNsaWVudFNldHRpbmdzKHNldHRpbmdzKTtcclxuXHJcbiAgICAgICAgdGhpcy5fYXRvbUxhbmd1YWdlUHJvdmlkZXIgPSBuZXcgTGFuZ3VhZ2VQcm92aWRlcih0aGlzLl9jb250YWluZXIpO1xyXG4gICAgICAgIHRoaXMuX2F0b21MYW5ndWFnZVNlcnZpY2UgPSBuZXcgTGFuZ3VhZ2VTZXJ2aWNlKHRoaXMuX2NvbnRhaW5lcik7XHJcbiAgICAgICAgdGhpcy5fYXRvbUF1dG9jb21wbGV0ZVByb3ZpZGVyID0gbmV3IEF1dG9jb21wbGV0ZVNlcnZpY2UoKTtcclxuICAgICAgICB0aGlzLl9hdG9tTGludGVyUHJvdmlkZXIgPSBuZXcgTGludGVyU2VydmljZSgpO1xyXG4gICAgICAgIHRoaXMuX2F0b21TdGF0dXNCYXJTZXJ2aWNlID0gbmV3IFN0YXR1c0JhclNlcnZpY2UoKTtcclxuXHJcbiAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlZ2lzdGVySW5zdGFuY2UoTGFuZ3VhZ2VQcm92aWRlciwgdGhpcy5fYXRvbUxhbmd1YWdlUHJvdmlkZXIpO1xyXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3RlckFsaWFzKExhbmd1YWdlUHJvdmlkZXIsIElMYW5ndWFnZVByb3ZpZGVyKTtcclxuXHJcbiAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlZ2lzdGVySW5zdGFuY2UoTGFuZ3VhZ2VTZXJ2aWNlLCB0aGlzLl9hdG9tTGFuZ3VhZ2VTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIucmVnaXN0ZXJBbGlhcyhMYW5ndWFnZVNlcnZpY2UsIElMYW5ndWFnZVNlcnZpY2UpO1xyXG5cclxuICAgICAgICB0aGlzLl9jb250YWluZXIucmVnaXN0ZXJJbnN0YW5jZShBdXRvY29tcGxldGVTZXJ2aWNlLCB0aGlzLl9hdG9tQXV0b2NvbXBsZXRlUHJvdmlkZXIpO1xyXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3RlckFsaWFzKEF1dG9jb21wbGV0ZVNlcnZpY2UsIElBdXRvY29tcGxldGVTZXJ2aWNlKTtcclxuXHJcbiAgICAgICAgdGhpcy5fY29udGFpbmVyLnJlZ2lzdGVySW5zdGFuY2UoTGludGVyU2VydmljZSwgdGhpcy5fYXRvbUxpbnRlclByb3ZpZGVyKTtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIucmVnaXN0ZXJBbGlhcyhMaW50ZXJTZXJ2aWNlLCBJTGludGVyU2VydmljZSk7XHJcblxyXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3Rlckluc3RhbmNlKFN0YXR1c0JhclNlcnZpY2UsIHRoaXMuX2F0b21TdGF0dXNCYXJTZXJ2aWNlKTtcclxuICAgICAgICB0aGlzLl9jb250YWluZXIucmVnaXN0ZXJBbGlhcyhTdGF0dXNCYXJTZXJ2aWNlLCBJU3RhdHVzQmFyU2VydmljZSk7XHJcblxyXG4gICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3Rlckluc3RhbmNlKElSZXNvbHZlciwgdGhpcy5fY29udGFpbmVyKTtcclxuXHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lcixcclxuICAgICAgICAgICAgdGhpcy5fYXRvbUxhbmd1YWdlUHJvdmlkZXIsXHJcbiAgICAgICAgICAgIHRoaXMuX2F0b21MYW5ndWFnZVNlcnZpY2VcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICBjb25zdCBhY3RpdmF0ZVNlcnZpY2VzID1cclxuICAgICAgICAgICAgT2JzZXJ2YWJsZS5tZXJnZShcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3RlckZvbGRlcihfX2Rpcm5hbWUsICdhdG9tJyksXHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIucmVnaXN0ZXJGb2xkZXIoX19kaXJuYW1lLCAnY2FwYWJpbGl0aWVzJyksXHJcbiAgICAgICAgICAgICAgICB0aGlzLl9jb250YWluZXIucmVnaXN0ZXJGb2xkZXIoX19kaXJuYW1lLCAnc2VydmljZXMnKSxcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3RlckZvbGRlcihfX2Rpcm5hbWUsICd1aScpXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxyXG4gICAgICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZWdpc3RlckludGVyZmFjZVN5bWJvbHMoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmFjdGl2YXRlZCA9IGFjdGl2YXRlU2VydmljZXM7XHJcblxyXG4gICAgICAgIC8qIFdlJ3JlIGdvaW5nIHRvIHByZXRlbmQgdG8gbG9hZCB0aGVzZSBwYWNrYWdlcywgYXMgaWYgdGhleSB3ZXJlIHJlYWwgKi9cclxuICAgICAgICBjb25zdCBwYXRoVG9QbHVnaW5zID0gcmVzb2x2ZShfX2Rpcm5hbWUsICcuLi8nLCAncGx1Z2lucycpO1xyXG4gICAgICAgIHRoaXMuYWN0aXZhdGVkLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gJHJlYWRkaXIocGF0aFRvUGx1Z2lucylcclxuICAgICAgICAgICAgICAgIC5tZXJnZU1hcChmb2xkZXJzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5mcm9tKGZvbGRlcnMpXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tZXJnZU1hcChmb2xkZXIgPT4gJHJlYWRkaXIoam9pbihwYXRoVG9QbHVnaW5zLCBmb2xkZXIpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1lcmdlTWFwKGZpbGVzID0+IGZpbGVzKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLmZpbHRlcih4ID0+IF8uZW5kc1dpdGgoeCwgJ1BhY2thZ2UudHMnKSlcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoeCA9PiBqb2luKHBhdGhUb1BsdWdpbnMsIGZvbGRlciwgXy50cmltRW5kKHgsICcudHMnKSkpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tcmVxdWlyZS1pbXBvcnRzICovXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAocGF0aCA9PiByZXF1aXJlKHBhdGgpKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKG1vZHVsZSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjbHM6IHsgbmV3ICgpOiBhbnkgfSA9IF8uZmluZChtb2R1bGUsIF8uaXNGdW5jdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGNscygpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAubWFwKGluc3RhbmNlID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZVsnY29uc3VtZS1hdG9tLWxhbmd1YWdlLWNsaWVudCddKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGFuY2VbJ2NvbnN1bWUtYXRvbS1sYW5ndWFnZS1jbGllbnQnXSh0aGlzLl9hdG9tTGFuZ3VhZ2VTZXJ2aWNlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbnN0YW5jZVsncHJvdmlkZS1hdG9tLWxhbmd1YWdlJ10pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzWydjb25zdW1lLWF0b20tbGFuZ3VhZ2UnXShpbnN0YW5jZVsncHJvdmlkZS1hdG9tLWxhbmd1YWdlJ10oKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAudG9Qcm9taXNlKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuYWN0aXZhdGVkLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tcmVxdWlyZS1pbXBvcnRzICovXHJcbiAgICAgICAgICAgIHRoaXMuX2NvbnRhaW5lci5yZXNvbHZlRWFjaChfLnZhbHVlcyhyZXF1aXJlKCcuL3VpL1VzZXJJbnRlcmZhY2UnKSkpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpmdW5jdGlvbi1uYW1lICovXHJcbiAgICBwdWJsaWMgWydwcm92aWRlLWF0b20tbGFuZ3VhZ2UtY2xpZW50J10oKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX2F0b21MYW5ndWFnZVNlcnZpY2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZ1bmN0aW9uLW5hbWUgKi9cclxuICAgIHB1YmxpYyBbJ3Byb3ZpZGUtYXRvbS1hdXRvY29tcGxldGUnXSgpIHtcclxuICAgICAgICByZXR1cm4gW3RoaXMuX2F0b21BdXRvY29tcGxldGVQcm92aWRlcl07XHJcbiAgICB9XHJcblxyXG4gICAgLyogdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOmZ1bmN0aW9uLW5hbWUgKi9cclxuICAgIHB1YmxpYyBbJ2NvbnN1bWUtYXRvbS1sYW5ndWFnZSddKHNlcnZpY2VzOiBJTGFuZ3VhZ2VQcm92aWRlciB8IElMYW5ndWFnZVByb3ZpZGVyW10pIHtcclxuICAgICAgICBpZiAoXy5pc0FycmF5KHNlcnZpY2VzKSkge1xyXG4gICAgICAgICAgICBfLmVhY2goc2VydmljZXMsIHNlcnZpY2UgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fYXRvbUxhbmd1YWdlUHJvdmlkZXIuYWRkKHNlcnZpY2UpO1xyXG4gICAgICAgICAgICAgICAgaWYgKGlzRGlzcG9zYWJsZShzZXJ2aWNlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKHNlcnZpY2UpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICB0aGlzLl9hdG9tTGFuZ3VhZ2VQcm92aWRlci5hZGQoc2VydmljZXMpO1xyXG4gICAgICAgICAgICBpZiAoaXNEaXNwb3NhYmxlKHNlcnZpY2VzKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoc2VydmljZXMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpmdW5jdGlvbi1uYW1lICovXHJcbiAgICBwdWJsaWMgWydjb25zdW1lLWF0b20tbGludGVyJ10oc2VydmljZTogTGludGVyLkluZGllUmVnaXN0cnkpIHtcclxuICAgICAgICB0aGlzLl9hdG9tTGludGVyUHJvdmlkZXIucmVnaXN0cnkgPSBzZXJ2aWNlO1xyXG4gICAgfVxyXG5cclxuICAgIC8qIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpmdW5jdGlvbi1uYW1lICovXHJcbiAgICBwdWJsaWMgWydjb25zdW1lLXN0YXR1cy1iYXInXShzZXJ2aWNlOiBTdGF0dXNCYXIuQXBpKSB7XHJcbiAgICAgICAgdGhpcy5fYXRvbVN0YXR1c0JhclNlcnZpY2UuYXBpID0gc2VydmljZTtcclxuICAgIH1cclxuXHJcbiAgICAvKiB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tYW55ICovXHJcbiAgICBwdWJsaWMgc3RhdGljIGRlc2VyaWFsaXplKHN0YXRlOiBJQXRvbUxhbmd1YWdlQ2xpZW50U2V0dGluZ3MpIHtcclxuICAgICAgICByZXR1cm4gbmV3IEF0b21MYW5ndWFnZUNsaWVudFNldHRpbmdzKHN0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICBwdWJsaWMgc2VyaWFsaXplKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLl9zZXR0aW5ncy5zZXJpYWxpemUoQXRvbUxhbmd1YWdlQ2xpZW50UGFja2FnZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGRlYWN0aXZhdGUoKSB7XHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5kaXNwb3NlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIHN0YXRpYyBnZXQgdmVyc2lvbigpIHsgcmV0dXJuIDE7IH1cclxufVxyXG5cclxuYXRvbS5kZXNlcmlhbGl6ZXJzLmFkZChBdG9tTGFuZ3VhZ2VDbGllbnRQYWNrYWdlKTtcclxuIl19