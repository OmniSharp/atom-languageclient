"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
/**
 *  @license   MIT
 *  @copyright OmniSharp Team
 *  @summary   Adds support for https://github.com/Microsoft/language-server-protocol (and more!) to https://atom.io
 */
var _ = require('lodash');
var protocol_1 = require('atom-languageservices/protocol');
var types_1 = require('atom-languageservices/types');
var ts_disposables_1 = require('ts-disposables');
var constants_1 = require('../constants');
var convert_1 = require('./utils/convert');
var LanguageClientTextEditorChanges_1 = require('../omni/LanguageClientTextEditorChanges');
var TextEditorSyncProtocol = (function (_super) {
    __extends(TextEditorSyncProtocol, _super);
    function TextEditorSyncProtocol(client, syncExpression, documentDelayer, atomViewFinder, waitService, editor) {
        var _this = this;
        _super.call(this);
        this._version = 0;
        this._changes = new LanguageClientTextEditorChanges_1.LanguageClientTextEditorChanges();
        this._pausedEvents = [];
        this._client = client;
        this._fullText = this._client.capabilities.textDocumentSync === types_1.TextDocumentSyncKind.Full;
        this._waitService = waitService;
        this._editor = editor;
        this._atomViewFinder = atomViewFinder;
        this._syncExpression = syncExpression;
        this._documentDelayer = documentDelayer;
        this._disposable.add(waitService.waiting$.subscribe(function (paused) {
            if (!paused && _this._pausedEvents.length) {
                _.each(_this._pausedEvents, function (event) {
                    event();
                });
            }
        }));
        this._configure();
    }
    TextEditorSyncProtocol.prototype._configure = function () {
        var editor = this._editor;
        this._open();
        this._disposable.add(editor.onDidDestroy(_.bind(this._close, this)), editor.onDidSave(_.bind(this._save, this)));
        if (this._fullText) {
            this._disposable.add(editor.buffer.onDidChange(_.bind(this._fullTextChange, this)));
        }
        else {
            this._disposable.add(editor.buffer.onDidChange(_.bind(this._incrementalChange, this)));
        }
    };
    TextEditorSyncProtocol.prototype._fullTextChange = function () {
        var _this = this;
        this._version += 1;
        if (this._waitService.waiting) {
            this._pausedEvents.push(function () { return _this._fullTextChange(); });
            return;
        }
        this._documentDelayer.trigger(this._editor, function () {
            _this._client.sendNotification(protocol_1.DidChangeTextDocumentNotification.type, {
                textDocument: {
                    uri: convert_1.toUri(_this._editor),
                    version: _this._version
                },
                contentChanges: [{ text: _this._editor.getText() }]
            });
        });
    };
    TextEditorSyncProtocol.prototype._incrementalChange = function (change) {
        var _this = this;
        this._version += 1;
        if (change) {
            this._changes.push(change);
        }
        if (this._waitService.waiting) {
            this._pausedEvents.push(function () { return _this._incrementalChange(); });
            return;
        }
        this._documentDelayer.trigger(this._editor, function () {
            _this._client.sendNotification(protocol_1.DidChangeTextDocumentNotification.type, {
                textDocument: {
                    uri: convert_1.toUri(_this._editor),
                    version: _this._version
                },
                contentChanges: _.map(_this._changes.pop(), function (c) {
                    return {
                        range: convert_1.toRange(c.oldRange),
                        rangeLength: undefined,
                        text: c.newText
                    };
                })
            });
        });
    };
    TextEditorSyncProtocol.prototype._open = function () {
        var _this = this;
        if (this._waitService.waiting) {
            this._pausedEvents.push(function () { return _this._open(); });
            return;
        }
        var view = this._atomViewFinder.getView(this._editor);
        if (view && !view.classList.contains(constants_1.className)) {
            view.classList.add(constants_1.className);
        }
        this._client.sendNotification(protocol_1.DidOpenTextDocumentNotification.type, {
            textDocument: {
                uri: convert_1.toUri(this._editor),
                languageId: convert_1.getLanguageId(this._editor),
                version: this._version,
                text: this._editor.getText()
            }
        });
    };
    TextEditorSyncProtocol.prototype._close = function () {
        var _this = this;
        if (this._waitService.waiting) {
            this._pausedEvents.push(function () { return _this._close(); });
            return;
        }
        this._client.sendNotification(protocol_1.DidCloseTextDocumentNotification.type, {
            textDocument: convert_1.toTextDocumentIdentifier(this._editor)
        });
    };
    TextEditorSyncProtocol.prototype._save = function () {
        var _this = this;
        if (this._waitService.waiting) {
            this._pausedEvents.push(function () { return _this._save(); });
            return;
        }
        this._client.sendNotification(protocol_1.DidSaveTextDocumentNotification.type, {
            textDocument: convert_1.toTextDocumentIdentifier(this._editor)
        });
        this._fullTextChange();
    };
    return TextEditorSyncProtocol;
}(ts_disposables_1.DisposableBase));
exports.TextEditorSyncProtocol = TextEditorSyncProtocol;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGV4dEVkaXRvclN5bmNQcm90b2NvbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9jYXBhYmlsaXRpZXMvVGV4dEVkaXRvclN5bmNQcm90b2NvbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7OztHQUlHO0FBQ0gsSUFBWSxDQUFDLFdBQU0sUUFBUSxDQUFDLENBQUE7QUFHNUIseUJBQXNKLGdDQUFnQyxDQUFDLENBQUE7QUFDdkwsc0JBQXVILDZCQUE2QixDQUFDLENBQUE7QUFDckosK0JBQStCLGdCQUFnQixDQUFDLENBQUE7QUFDaEQsMEJBQTBCLGNBQWMsQ0FBQyxDQUFBO0FBQ3pDLHdCQUF3RSxpQkFBaUIsQ0FBQyxDQUFBO0FBQzFGLGdEQUFnRSx5Q0FBeUMsQ0FBQyxDQUFBO0FBRTFHO0lBQTRDLDBDQUFjO0lBWXRELGdDQUNJLE1BQStCLEVBQy9CLGNBQStCLEVBQy9CLGVBQWlDLEVBQ2pDLGNBQStCLEVBQy9CLFdBQXlCLEVBQ3pCLE1BQXVCO1FBbEIvQixpQkF3SkM7UUFySU8saUJBQU8sQ0FBQztRQWpCSixhQUFRLEdBQUcsQ0FBQyxDQUFDO1FBTWIsYUFBUSxHQUFHLElBQUksaUVBQStCLEVBQUUsQ0FBQztRQUVqRCxrQkFBYSxHQUFtQixFQUFFLENBQUM7UUFVdkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxnQkFBZ0IsS0FBSyw0QkFBb0IsQ0FBQyxJQUFJLENBQUM7UUFDMUYsSUFBSSxDQUFDLFlBQVksR0FBRyxXQUFXLENBQUM7UUFDaEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7UUFDdEIsSUFBSSxDQUFDLGVBQWUsR0FBRyxjQUFjLENBQUM7UUFDdEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxjQUFjLENBQUM7UUFDdEMsSUFBSSxDQUFDLGdCQUFnQixHQUFH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QUEsS0FBSSxDQUFDLEtBQUssRUFBRSxFQUFaLENBQVksQ0FBQyxDQUFDO1lBQzVDLE1BQU0sQ0FBQztRQUNYLENBQUM7UUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUE0QiwwQ0FBK0IsQ0FBQyxJQUFJLEVBQUU7WUFDM0YsWUFBWSxFQUFFLGtDQUF3QixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDdkQsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFDTCw2QkFBQztBQUFELENBQUMsQUF4SkQsQ0FBNEMsK0JBQWMsR0F3SnpEO0FBeEpZLDhCQUFzQix5QkF3SmxDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcclxuICogIEBsaWNlbnNlICAgTUlUXHJcbiAqICBAY29weXJpZ2h0IE9tbmlTaGFycCBUZWFtXHJcbiAqICBAc3VtbWFyeSAgIEFkZHMgc3VwcG9ydCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL01pY3Jvc29mdC9sYW5ndWFnZS1zZXJ2ZXItcHJvdG9jb2wgKGFuZCBtb3JlISkgdG8gaHR0cHM6Ly9hdG9tLmlvXHJcbiAqL1xyXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgSUF0b21WaWV3RmluZGVyLCBJRG9jdW1lbnREZWxheWVyLCBJTGFuZ3VhZ2VQcm90b2NvbENsaWVudCwgSVN5bmNFeHByZXNzaW9uLCBJV2FpdFNlcnZpY2UgfSBmcm9tICdhdG9tLWxhbmd1YWdlc2VydmljZXMnO1xyXG5pbXBvcnQgeyBEaWRDaGFuZ2VUZXh0RG9jdW1lbnROb3RpZmljYXRpb24sIERpZENsb3NlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLCBEaWRPcGVuVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLCBEaWRTYXZlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uIH0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzL3Byb3RvY29sJztcclxuaW1wb3J0IHsgRGlkQ2xvc2VUZXh0RG9jdW1lbnRQYXJhbXMsIERpZE9wZW5UZXh0RG9jdW1lbnRQYXJhbXMsIERpZFNhdmVUZXh0RG9jdW1lbnRQYXJhbXMsIFRleHREb2N1bWVudFN5bmNLaW5kIH0gZnJvbSAnYXRvbS1sYW5ndWFnZXNlcnZpY2VzL3R5cGVzJztcclxuaW1wb3J0IHsgRGlzcG9zYWJsZUJhc2UgfSBmcm9tICd0cy1kaXNwb3NhYmxlcyc7XHJcbmltcG9ydCB7IGNsYXNzTmFtZSB9IGZyb20gJy4uL2NvbnN0YW50cyc7XHJcbmltcG9ydCB7IGdldExhbmd1YWdlSWQsIHRvUmFuZ2UsIHRvVGV4dERvY3VtZW50SWRlbnRpZmllciwgdG9VcmkgfSBmcm9tICcuL3V0aWxzL2NvbnZlcnQnO1xyXG5pbXBvcnQgeyBBdG9tVGV4dENoYW5nZSwgTGFuZ3VhZ2VDbGllbnRUZXh0RWRpdG9yQ2hhbmdlcyB9IGZyb20gJy4uL29tbmkvTGFuZ3VhZ2VDbGllbnRUZXh0RWRpdG9yQ2hhbmdlcyc7XHJcblxyXG5leHBvcnQgY2xhc3MgVGV4dEVkaXRvclN5bmNQcm90b2NvbCBleHRlbmRzIERpc3Bvc2FibGVCYXNlIHtcclxuICAgIHByaXZhdGUgX2NsaWVudDogSUxhbmd1YWdlUHJvdG9jb2xDbGllbnQ7XHJcbiAgICBwcml2YXRlIF92ZXJzaW9uID0gMDtcclxuICAgIHByaXZhdGUgX2VkaXRvcjogQXRvbS5UZXh0RWRpdG9yO1xyXG4gICAgcHJpdmF0ZSBfc3luY0V4cHJlc3Npb246IElTeW5jRXhwcmVzc2lvbjtcclxuICAgIHByaXZhdGUgX2RvY3VtZW50RGVsYXllcjogSURvY3VtZW50RGVsYXllcjtcclxuICAgIHByaXZhdGUgX2F0b21WaWV3RmluZGVyOiBJQXRvbVZpZXdGaW5kZXI7XHJcbiAgICBwcml2YXRlIF93YWl0U2VydmljZTogSVdhaXRTZXJ2aWNlO1xyXG4gICAgcHJpdmF0ZSBfY2hhbmdlcyA9IG5ldyBMYW5ndWFnZUNsaWVudFRleHRFZGl0b3JDaGFuZ2VzKCk7XHJcbiAgICBwcml2YXRlIF9mdWxsVGV4dDogYm9vbGVhbjtcclxuICAgIHByaXZhdGUgX3BhdXNlZEV2ZW50czogKCgpID0+IHZvaWQpW10gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBjbGllbnQ6IElMYW5ndWFnZVByb3RvY29sQ2xpZW50LFxyXG4gICAgICAgIHN5bmNFeHByZXNzaW9uOiBJU3luY0V4cHJlc3Npb24sXHJcbiAgICAgICAgZG9jdW1lbnREZWxheWVyOiBJRG9jdW1lbnREZWxheWVyLFxyXG4gICAgICAgIGF0b21WaWV3RmluZGVyOiBJQXRvbVZpZXdGaW5kZXIsXHJcbiAgICAgICAgd2FpdFNlcnZpY2U6IElXYWl0U2VydmljZSxcclxuICAgICAgICBlZGl0b3I6IEF0b20uVGV4dEVkaXRvcikge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5fY2xpZW50ID0gY2xpZW50O1xyXG4gICAgICAgIHRoaXMuX2Z1bGxUZXh0ID0gdGhpcy5fY2xpZW50LmNhcGFiaWxpdGllcy50ZXh0RG9jdW1lbnRTeW5jID09PSBUZXh0RG9jdW1lbnRTeW5jS2luZC5GdWxsO1xyXG4gICAgICAgIHRoaXMuX3dhaXRTZXJ2aWNlID0gd2FpdFNlcnZpY2U7XHJcbiAgICAgICAgdGhpcy5fZWRpdG9yID0gZWRpdG9yO1xyXG4gICAgICAgIHRoaXMuX2F0b21WaWV3RmluZGVyID0gYXRvbVZpZXdGaW5kZXI7XHJcbiAgICAgICAgdGhpcy5fc3luY0V4cHJlc3Npb24gPSBzeW5jRXhwcmVzc2lvbjtcclxuICAgICAgICB0aGlzLl9kb2N1bWVudERlbGF5ZXIgPSBkb2N1bWVudERlbGF5ZXI7XHJcblxyXG4gICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKHdhaXRTZXJ2aWNlLndhaXRpbmckLnN1YnNjcmliZShwYXVzZWQgPT4ge1xyXG4gICAgICAgICAgICBpZiAoIXBhdXNlZCAmJiB0aGlzLl9wYXVzZWRFdmVudHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICBfLmVhY2godGhpcy5fcGF1c2VkRXZlbnRzLCBldmVudCA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQoKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSkpO1xyXG5cclxuICAgICAgICB0aGlzLl9jb25maWd1cmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jb25maWd1cmUoKSB7XHJcbiAgICAgICAgY29uc3QgZWRpdG9yID0gdGhpcy5fZWRpdG9yO1xyXG5cclxuICAgICAgICB0aGlzLl9vcGVuKCk7XHJcbiAgICAgICAgdGhpcy5fZGlzcG9zYWJsZS5hZGQoXHJcbiAgICAgICAgICAgIGVkaXRvci5vbkRpZERlc3Ryb3koXy5iaW5kKHRoaXMuX2Nsb3NlLCB0aGlzKSksXHJcbiAgICAgICAgICAgIGVkaXRvci5vbkRpZFNhdmUoXy5iaW5kKHRoaXMuX3NhdmUsIHRoaXMpKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgaWYgKHRoaXMuX2Z1bGxUZXh0KSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmJ1ZmZlci5vbkRpZENoYW5nZShfLmJpbmQodGhpcy5fZnVsbFRleHRDaGFuZ2UsIHRoaXMpKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2Rpc3Bvc2FibGUuYWRkKFxyXG4gICAgICAgICAgICAgICAgZWRpdG9yLmJ1ZmZlci5vbkRpZENoYW5nZShfLmJpbmQodGhpcy5faW5jcmVtZW50YWxDaGFuZ2UsIHRoaXMpKVxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9mdWxsVGV4dENoYW5nZSgpIHtcclxuICAgICAgICB0aGlzLl92ZXJzaW9uICs9IDE7XHJcbiAgICAgICAgaWYgKHRoaXMuX3dhaXRTZXJ2aWNlLndhaXRpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5fcGF1c2VkRXZlbnRzLnB1c2goKCkgPT4gdGhpcy5fZnVsbFRleHRDaGFuZ2UoKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2RvY3VtZW50RGVsYXllci50cmlnZ2VyKFxyXG4gICAgICAgICAgICB0aGlzLl9lZGl0b3IsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NsaWVudC5zZW5kTm90aWZpY2F0aW9uKERpZENoYW5nZVRleHREb2N1bWVudE5vdGlmaWNhdGlvbi50eXBlLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dERvY3VtZW50OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVyaTogdG9VcmkodGhpcy5fZWRpdG9yKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogdGhpcy5fdmVyc2lvblxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudENoYW5nZXM6IFt7IHRleHQ6IHRoaXMuX2VkaXRvci5nZXRUZXh0KCkgfV1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9pbmNyZW1lbnRhbENoYW5nZShjaGFuZ2U/OiBBdG9tVGV4dENoYW5nZSkge1xyXG4gICAgICAgIHRoaXMuX3ZlcnNpb24gKz0gMTtcclxuICAgICAgICBpZiAoY2hhbmdlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2NoYW5nZXMucHVzaChjaGFuZ2UpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRoaXMuX3dhaXRTZXJ2aWNlLndhaXRpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5fcGF1c2VkRXZlbnRzLnB1c2goKCkgPT4gdGhpcy5faW5jcmVtZW50YWxDaGFuZ2UoKSk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2RvY3VtZW50RGVsYXllci50cmlnZ2VyKFxyXG4gICAgICAgICAgICB0aGlzLl9lZGl0b3IsXHJcbiAgICAgICAgICAgICgpID0+IHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX2NsaWVudC5zZW5kTm90aWZpY2F0aW9uKERpZENoYW5nZVRleHREb2N1bWVudE5vdGlmaWNhdGlvbi50eXBlLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGV4dERvY3VtZW50OiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHVyaTogdG9VcmkodGhpcy5fZWRpdG9yKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgdmVyc2lvbjogdGhpcy5fdmVyc2lvblxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgY29udGVudENoYW5nZXM6IF8ubWFwKHRoaXMuX2NoYW5nZXMucG9wKCksIChjKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByYW5nZTogdG9SYW5nZShjLm9sZFJhbmdlKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJhbmdlTGVuZ3RoOiB1bmRlZmluZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBjLm5ld1RleHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX29wZW4oKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3dhaXRTZXJ2aWNlLndhaXRpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5fcGF1c2VkRXZlbnRzLnB1c2goKCkgPT4gdGhpcy5fb3BlbigpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdmlldyA9IHRoaXMuX2F0b21WaWV3RmluZGVyLmdldFZpZXcodGhpcy5fZWRpdG9yKTtcclxuICAgICAgICBpZiAodmlldyAmJiAhdmlldy5jbGFzc0xpc3QuY29udGFpbnMoY2xhc3NOYW1lKSkge1xyXG4gICAgICAgICAgICB2aWV3LmNsYXNzTGlzdC5hZGQoY2xhc3NOYW1lKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMuX2NsaWVudC5zZW5kTm90aWZpY2F0aW9uPERpZE9wZW5UZXh0RG9jdW1lbnRQYXJhbXM+KERpZE9wZW5UZXh0RG9jdW1lbnROb3RpZmljYXRpb24udHlwZSwge1xyXG4gICAgICAgICAgICB0ZXh0RG9jdW1lbnQ6IHtcclxuICAgICAgICAgICAgICAgIHVyaTogdG9VcmkodGhpcy5fZWRpdG9yKSxcclxuICAgICAgICAgICAgICAgIGxhbmd1YWdlSWQ6IGdldExhbmd1YWdlSWQodGhpcy5fZWRpdG9yKSxcclxuICAgICAgICAgICAgICAgIHZlcnNpb246IHRoaXMuX3ZlcnNpb24sXHJcbiAgICAgICAgICAgICAgICB0ZXh0OiB0aGlzLl9lZGl0b3IuZ2V0VGV4dCgpXHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIF9jbG9zZSgpIHtcclxuICAgICAgICBpZiAodGhpcy5fd2FpdFNlcnZpY2Uud2FpdGluZykge1xyXG4gICAgICAgICAgICB0aGlzLl9wYXVzZWRFdmVudHMucHVzaCgoKSA9PiB0aGlzLl9jbG9zZSgpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY2xpZW50LnNlbmROb3RpZmljYXRpb248RGlkQ2xvc2VUZXh0RG9jdW1lbnRQYXJhbXM+KERpZENsb3NlVGV4dERvY3VtZW50Tm90aWZpY2F0aW9uLnR5cGUsIHtcclxuICAgICAgICAgICAgdGV4dERvY3VtZW50OiB0b1RleHREb2N1bWVudElkZW50aWZpZXIodGhpcy5fZWRpdG9yKVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgX3NhdmUoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuX3dhaXRTZXJ2aWNlLndhaXRpbmcpIHtcclxuICAgICAgICAgICAgdGhpcy5fcGF1c2VkRXZlbnRzLnB1c2goKCkgPT4gdGhpcy5fc2F2ZSgpKTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5fY2xpZW50LnNlbmROb3RpZmljYXRpb248RGlkU2F2ZVRleHREb2N1bWVudFBhcmFtcz4oRGlkU2F2ZVRleHREb2N1bWVudE5vdGlmaWNhdGlvbi50eXBlLCB7XHJcbiAgICAgICAgICAgIHRleHREb2N1bWVudDogdG9UZXh0RG9jdW1lbnRJZGVudGlmaWVyKHRoaXMuX2VkaXRvcilcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5fZnVsbFRleHRDaGFuZ2UoKTtcclxuICAgIH1cclxufVxyXG4iXX0=