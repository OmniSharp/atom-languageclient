"use strict";
/**
 *  @license   MIT
 *  @copyright OmniSharp Team
 *  @summary   Adds support for https://github.com/Microsoft/language-server-protocol (and more!) to https://atom.io
 */
/* tslint:disable:no-for-in forin */
var _ = require('lodash');
var fs = require('fs');
var path = require('path');
var request_light_1 = require('request-light');
var URL = require('url');
var vscode_json_languageservice_1 = require('vscode-json-languageservice');
var vscode_languageserver_1 = require('vscode-languageserver');
var default_validations_1 = require('./default-validations');
var globPatternContribution_1 = require('./jsoncontributions/globPatternContribution');
var languageModelCache_1 = require('./languageModelCache');
var projectJSONContribution_1 = require('./jsoncontributions/projectJSONContribution');
var uri_1 = require('./utils/uri');
var SchemaAssociationNotification;
(function (SchemaAssociationNotification) {
    SchemaAssociationNotification.type = { get method() { return 'json/schemaAssociations'; } };
})(SchemaAssociationNotification || (SchemaAssociationNotification = {}));
// Create a connection for the server
var connection = vscode_languageserver_1.createConnection(new vscode_languageserver_1.IPCMessageReader(process), new vscode_languageserver_1.IPCMessageWriter(process));
console.log = connection.console.log.bind(connection.console);
console.error = connection.console.error.bind(connection.console);
// Create a simple text document manager. The text document manager
// supports full document sync only
var documents = new vscode_languageserver_1.TextDocuments();
// Make the text document manager listen on the connection
// for open, change and close text document events
documents.listen(connection);
// After the server has started the client sends an initilize request. The server receives
// in the passed params the rootPath of the workspace plus the client capabilites.
var workspaceRoot;
connection.onInitialize(function (params) {
    workspaceRoot = uri_1.default.parse(params.rootPath);
    return {
        capabilities: {
            // Tell the client that the server works in FULL text document sync mode
            textDocumentSync: documents.syncKind,
            completionProvider: { resolveProvider: true },
            hoverProvider: true,
            documentSymbolProvider: true,
            documentRangeFormattingProvider: true,
            documentFormattingProvider: true
        }
    };
});
var workspaceContext = {
    resolveRelativePath: function (relativePath, resource) {
        return URL.resolve(resource, relativePath);
    }
};
var schemaRequestService = function (uri) {
    if (_.startsWith(uri, 'file://')) {
        var fsPath_1 = uri_1.default.parse(uri).fsPath;
        return new Promise(function (c, e) {
            fs.readFile(fsPath_1, 'UTF-8', function (err, result) {
                err ? e('') : c(result.toString());
            });
        });
    }
    return request_light_1.xhr({ url: uri, followRedirects: 5 })
        .then(function (response) {
        return response.responseText;
    }, function (error) {
        return error.responseText || request_light_1.getErrorStatusDescription(error.status) || error.toString();
    });
};
// create the JSON language service
var languageService = vscode_json_languageservice_1.getLanguageService({
    schemaRequestService: schemaRequestService,
    workspaceContext: workspaceContext,
    contributions: [
        new projectJSONContribution_1.ProjectJSONContribution(),
        new globPatternContribution_1.GlobPatternContribution()
    ]
});
var jsonConfigurationSettings = void 0;
var schemaAssociations = void 0;
var defaultAssociations = void 0;
// The settings have changed. Is send on server activation as well.
connection.onDidChangeConfiguration(function (change) {
    var settings = change.settings;
    request_light_1.configure(settings.http && settings.http.proxy, settings.http && settings.http.proxyStrictSSL);
    jsonConfigurationSettings = settings.json && settings.json.schemas;
    updateConfiguration();
});
// The jsonValidation extension configuration has changed
connection.onNotification(SchemaAssociationNotification.type, function (associations) {
    schemaAssociations = associations;
    updateConfiguration();
});
function updateConfiguration() {
    var languageSettings = {
        validate: true,
        allowComments: true,
        schemas: []
    };
    if (schemaAssociations) {
        var _loop_1 = function(pattern) {
            var association = schemaAssociations[pattern];
            if (Array.isArray(association)) {
                association.forEach(function (uri) {
                    languageSettings.schemas.push({ uri: uri, fileMatch: [pattern] });
                });
            }
        };
        for (var pattern in schemaAssociations) {
            _loop_1(pattern);
        }
    }
    if (defaultAssociations) {
        var _loop_2 = function(pattern) {
            var association = defaultAssociations[pattern];
            if (Array.isArray(association)) {
                association.forEach(function (uri) {
                    languageSettings.schemas.push({ uri: uri, fileMatch: [pattern] });
                });
            }
        };
        for (var pattern in defaultAssociations) {
            _loop_2(pattern);
        }
    }
    if (jsonConfigurationSettings) {
        jsonConfigurationSettings.forEach(function (schema) {
            var uri = schema.url;
            if (!uri && schema.schema) {
                uri = schema.schema.id;
            }
            if (uri) {
                if (uri[0] === '.' && workspaceRoot) {
                    // workspace relative path
                    uri = uri_1.default.file(path.normalize(path.join(workspaceRoot.fsPath, uri))).toString();
                }
                languageSettings.schemas.push({ uri: uri, fileMatch: schema.fileMatch, schema: schema.schema });
            }
        });
    }
    languageService.configure(languageSettings);
    if (!defaultAssociations) {
        default_validations_1.getDefaults().then(function (associations) {
            defaultAssociations = associations;
            updateConfiguration();
        }, function () { });
    }
    connection.sendNotification({ method: "abc" }, languageSettings);
    // Revalidate any open text documents
    documents.all().forEach(triggerValidation);
}
// The content of a text document has changed. This event is emitted
// when the text document first opened or when its content has changed.
documents.onDidChangeContent(function (change) {
    triggerValidation(change.document);
});
// a document has closed: clear all diagnostics
documents.onDidClose(function (event) {
    cleanPendingValidation(event.document);
    connection.sendDiagnostics({ uri: event.document.uri, diagnostics: [] });
});
var pendingValidationRequests = {};
var validationDelayMs = 200;
function cleanPendingValidation(textDocument) {
    var request = pendingValidationRequests[textDocument.uri];
    if (request) {
        clearTimeout(request);
        delete pendingValidationRequests[textDocument.uri];
    }
}
function triggerValidation(textDocument) {
    cleanPendingValidation(textDocument);
    pendingValidationRequests[textDocument.uri] = setTimeout(function () {
        delete pendingValidationRequests[textDocument.uri];
        validateTextDocument(textDocument);
    }, validationDelayMs);
}
function validateTextDocument(textDocument) {
    if (textDocument.getText().length === 0) {
        // ignore empty documents
        connection.sendDiagnostics({ uri: textDocument.uri, diagnostics: [] });
        return;
    }
    var jsonDocument = getJSONDocument(textDocument);
    languageService.doValidation(textDocument, jsonDocument).then(function (diagnostics) {
        // Send the computed diagnostics to VSCode.
        connection.sendDiagnostics({ uri: textDocument.uri, diagnostics: diagnostics });
    });
}
connection.onDidChangeWatchedFiles(function (change) {
    // Monitored files have changed in VSCode
    var hasChanges = false;
    change.changes.forEach(function (c) {
        if (languageService.resetSchema(c.uri)) {
            hasChanges = true;
        }
    });
    if (hasChanges) {
        documents.all().forEach(validateTextDocument);
    }
});
var jsonDocuments = languageModelCache_1.getLanguageModelCache(10, 60, function (document) { return languageService.parseJSONDocument(document); });
function getJSONDocument(document) {
    return jsonDocuments.get(document);
}
connection.onCompletion(function (textDocumentPosition) {
    var document = documents.get(textDocumentPosition.textDocument.uri);
    var jsonDocument = getJSONDocument(document);
    return languageService.doComplete(document, textDocumentPosition.position, jsonDocument);
});
connection.onCompletionResolve(function (completionItem) {
    return languageService.doResolve(completionItem);
});
connection.onHover(function (textDocumentPositionParams) {
    var document = documents.get(textDocumentPositionParams.textDocument.uri);
    var jsonDocument = getJSONDocument(document);
    return languageService.doHover(document, textDocumentPositionParams.position, jsonDocument);
});
connection.onDocumentSymbol(function (documentSymbolParams) {
    var document = documents.get(documentSymbolParams.textDocument.uri);
    var jsonDocument = getJSONDocument(document);
    return languageService.findDocumentSymbols(document, jsonDocument);
});
connection.onDocumentFormatting(function (formatParams) {
    var document = documents.get(formatParams.textDocument.uri);
    return languageService.format(document, null, formatParams.options);
});
connection.onDocumentRangeFormatting(function (formatParams) {
    var document = documents.get(formatParams.textDocument.uri);
    return languageService.format(document, formatParams.range, formatParams.options);
});
// Listen on the connection
connection.listen();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcGx1Z2lucy9hdG9tLWxhbmd1YWdlLWpzb24vc2VydmVyL3NlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7R0FJRztBQUNILG9DQUFvQztBQUNwQyxJQUFZLENBQUMsV0FBTSxRQUFRLENBQUMsQ0FBQTtBQUM1QixJQUFZLEVBQUUsV0FBTSxJQUFJLENBQUMsQ0FBQTtBQUN6QixJQUFZLElBQUksV0FBTSxNQUFNLENBQUMsQ0FBQTtBQUM3Qiw4QkFBZ0csZUFBZSxDQUFDLENBQUE7QUFDaEgsSUFBWSxHQUFHLFdBQU0sS0FBSyxDQUFDLENBQUE7QUFDM0IsNENBQStFLDZCQUE2QixDQUFDLENBQUE7QUFDN0csc0NBQXFLLHVCQUF1QixDQUFDLENBQUE7QUFDN0wsb0NBQTRCLHVCQUF1QixDQUFDLENBQUE7QUFDcEQsd0NBQXdDLDZDQUE2QyxDQUFDLENBQUE7QUFDdEYsbUNBQXNDLHNCQUFzQixDQUFDLENBQUE7QUFDN0Qsd0NBQXdDLDZDQUE2QyxDQUFDLENBQUE7QUFDdEYsb0JBQWdCLGFBQWEsQ0FBQyxDQUFBO0FBRTlCLElBQVUsNkJBQTZCLENBRXRDO0FBRkQsV0FBVSw2QkFBNkIsRUFBQyxDQUFDO0lBQ3hCLGtDQUFJLEdBQThDLEVBQUUsSUFBSSxNQUFNLEtBQUssTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7QUFDMUgsQ0FBQyxFQUZTLDZCQUE2QixLQUE3Qiw2QkFBNkIsUUFFdEM7QUFFRCxxQ0FBcUM7QUFDckMsSUFBTSxVQUFVLEdBQWdCLHdDQUFnQixDQUFDLElBQUksd0NBQWdCLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSx3Q0FBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBRS9HLE9BQU8sQ0FBQyxHQUFHLEdBQUcsVUFBVSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUM5RCxPQUFPLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFbEUsbUVBQW1FO0FBQ25FLG1DQUFtQztBQUNuQyxJQUFNLFNBQVMsR0FBa0IsSUFBSSxxQ0FBYSxFQUFFLENBQUM7QUFDckQsMERBQTBEO0FBQzFELGtEQUFrRDtBQUNsRCxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBRTdCLDBGQUEwRjtBQUMxRixrRkFBa0Y7QUFDbEYsSUFBSSxhQUFrQixDQUFDO0FBQ3ZCLFVBQVUsQ0FBQyxZQUFZLENBQUMsVUFBQyxNQUF3QjtJQUM3QyxhQUFhLEdBQUcsYUFBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDM0MsTUFBTSxDQUFDO1FBQ0gsWUFBWSxFQUFFO1lBQ1Ysd0VBQXdFO1lBQ3hFLGdCQUFnQixFQUFFLFNBQVMsQ0FBQyxRQUFRO1lBQ3BDLGtCQUFrQixFQUFFLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRTtZQUM3QyxhQUFhLEVBQUUsSUFBSTtZQUNuQixzQkFBc0IsRUFBRSxJQUFJO1lBQzVCLCtCQUErQixFQUFFLElBQUk7WUFDckMsMEJBQTBCLEVBQUUsSUFBSTtTQUNuQztLQUNKLENBQUM7QUFDTixDQUFDLENBQUMsQ0FBQztBQUVILElBQU0sZ0JBQWdCLEdBQUc7SUFDckIsbUJBQW1CLEVBQUUsVUFBQyxZQUFvQixFQUFFLFFBQWdCO1FBQ3hELE1BQU0sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztJQUMvQyxDQUFDO0NBQ0osQ0FBQztBQUVGLElBQU0sb0JBQW9CLEdBQUcsVUFBQyxHQUFXO0lBQ3JDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUMsR0FBRyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixJQUFNLFFBQU0sR0FBRyxhQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNyQyxNQUFNLENBQUMsSUFBSSxPQUFPLENBQVMsVUFBQyxDQUFDLEVBQUUsQ0FBQztZQUM1QixFQUFFLENBQUMsUUFBUSxDQUFDLFFBQU0sRUFBRSxPQUFPLEVBQUUsVUFBQyxHQUFHLEVBQUUsTUFBTTtnQkFDckMsR0FBRyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7WUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFDRCxNQUFNLENBQUMsbUJBQUcsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsZUFBZSxFQUFFLENBQUMsRUFBRSxDQUFDO1NBQ3ZDLElBQUksQ0FDTCxVQUFBLFFBQVE7UUFDSixNQUFNLENBQUMsUUFBUSxDQUFDLFlBQVksQ0FBQztJQUNqQyxDQUFDLEVBQ0QsVUFBQyxLQUFrQjtRQUNmLE1BQU0sQ0FBQyxLQUFLLENBQUMsWUFBWSxJQUFJLHlDQUF5QixDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDN0YsQ0FBQyxDQUFDLENBQUM7QUFDWCxDQUFDLENBQUM7QUFFRixtQ0FBbUM7QUFDbkMsSUFBTSxlQUFlLEdBQUcsZ0RBQWtCLENBQUM7SUFDdkMsMENBQW9CO0lBQ3BCLGtDQUFnQjtJQUNoQixhQUFhLEVBQUU7UUFDWCxJQUFJLGlEQUF1QixFQUFFO1FBQzdCLElBQUksaURBQXVCLEVBQUU7S0FDaEM7Q0FDSixDQUFDLENBQUM7QUFtQkgsSUFBSSx5QkFBeUIsR0FBcUMsS0FBSyxDQUFDLENBQUM7QUFDekUsSUFBSSxrQkFBa0IsR0FBd0MsS0FBSyxDQUFDLENBQUM7QUFDckUsSUFBSSxtQkFBbUIsR0FBd0MsS0FBSyxDQUFDLENBQUM7QUFFdEUsbUVBQW1FO0FBQ25FLFVBQVUsQ0FBQyx3QkFBd0IsQ0FBQyxVQUFDLE1BQU07SUFDdkMsSUFBTSxRQUFRLEdBQWEsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUMzQyx5QkFBcUIsQ0FBQyxRQUFRLENBQUMsSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUUzRyx5QkFBeUIsR0FBRyxRQUFRLENBQUMsSUFBSSxJQUFJLFFBQVEsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ25FLG1CQUFtQixFQUFFLENBQUM7QUFDMUIsQ0FBQyxDQUFDLENBQUM7QUFFSCx5REFBeUQ7QUFDekQsVUFBVSxDQUFDLGNBQWMsQ0FBQyw2QkFBNkIsQ0FBQyxJQUFJLEVBQUUsVUFBQSxZQUFZO0lBQ3RFLGtCQUFrQixHQUFHLFlBQVksQ0FBQztJQUNsQyxtQkFBbUIsRUFBRSxDQUFDO0FBQzFCLENBQUMsQ0FBQyxDQUFDO0FBRUg7SUFDSSxJQUFNLGdCQUFnQixHQUFxQjtRQUN2QyxRQUFRLEVBQUUsSUFBSTtRQUNkLGFBQWEsRUFBRSxJQUFJO1FBQ25CLE9BQU8sRUFBRSxFQUFFO0tBQ2QsQ0FBQztJQUNGLEVBQUUsQ0FBQyxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQztRQUNyQjtZQUNJLElBQU0sV0FBVyxHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBQ2hELEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3QixXQUFXLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztvQkFDbkIsZ0JBQWdCLENBQUMsT0FBUSxDQUFDLElBQUksQ0FBQyxFQUFFLFFBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2xFLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQzs7UUFOTCxHQUFHLENBQUMsQ0FBQyxJQUFNLE9BQU8sSUFBSSxrQkFBa0IsQ0FBQzs7U0FPeEM7SUFDTCxDQUFDO0lBQ0QsRUFBRSxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1FBQ3RCO1lBQ0ksSUFBTSxXQUFXLEdBQUcsbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDakQsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzdCLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBQSxHQUFHO29CQUNuQixnQkFBZ0IsQ0FBQyxPQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBRyxFQUFFLFNBQVMsRUFBRSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDbEUsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDOztRQU5MLEdBQUcsQ0FBQyxDQUFDLElBQU0sT0FBTyxJQUFJLG1CQUFtQixDQUFDOztTQU96QztJQUNMLENBQUM7SUFDRCxFQUFFLENBQUMsQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDLENBQUM7UUFDNUIseUJBQXlCLENBQUMsT0FBTyxDQUFDLFVBQUEsTUFBTTtZQUNwQyxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO1lBQ3JCLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUN4QixHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7WUFDM0IsQ0FBQztZQUNELEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ04sRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDO29CQUNsQywwQkFBMEI7b0JBQzFCLEdBQUcsR0FBRyxhQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztnQkFDcEYsQ0FBQztnQkFDRCxnQkFBZ0IsQ0FBQyxPQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsUUFBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztZQUNoRyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0QsZUFBZSxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBRTVDLEVBQUUsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO1FBQ3ZCLGlDQUFXLEVBQUUsQ0FBQyxJQUFJLENBQ2QsVUFBQSxZQUFZO1lBQ1IsbUJBQW1CLEdBQUcsWUFBWSxDQUFDO1lBQ25DLG1CQUFtQixFQUFFLENBQUM7UUFDMUIsQ0FBQyxFQUNELGNBQWMsQ0FBQyxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVELFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFHLE1BQU0sRUFBRSxLQUFLLEVBQUUsRUFBRSxnQkFBZ0IsQ0FBQyxDQUFDO0lBRWxFLHFDQUFxQztJQUNyQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDL0MsQ0FBQztBQUVELG9FQUFvRTtBQUNwRSx1RUFBdUU7QUFDdkUsU0FBUyxDQUFDLGtCQUFrQixDQUFDLFVBQUMsTUFBTTtJQUNoQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDdkMsQ0FBQyxDQUFDLENBQUM7QUFFSCwrQ0FBK0M7QUFDL0MsU0FBUyxDQUFDLFVBQVUsQ0FBQyxVQUFBLEtBQUs7SUFDdEIsc0JBQXNCLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3ZDLFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsV0FBVyxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDN0UsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFNLHlCQUF5QixHQUFxQyxFQUFFLENBQUM7QUFDdkUsSUFBTSxpQkFBaUIsR0FBRyxHQUFHLENBQUM7QUFFOUIsZ0NBQWdDLFlBQTBCO0lBQ3RELElBQU0sT0FBTyxHQUFHLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUM1RCxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1FBQ1YsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3RCLE9BQU8seUJBQXlCLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7QUFDTCxDQUFDO0FBRUQsMkJBQTJCLFlBQTBCO0lBQ2pELHNCQUFzQixDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ3JDLHlCQUF5QixDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQ3BEO1FBQ0ksT0FBTyx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbkQsb0JBQW9CLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDdkMsQ0FBQyxFQUNELGlCQUFpQixDQUFDLENBQUM7QUFDM0IsQ0FBQztBQUVELDhCQUE4QixZQUEwQjtJQUNwRCxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdEMseUJBQXlCO1FBQ3pCLFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRSxHQUFHLEVBQUUsWUFBWSxDQUFDLEdBQUcsRUFBRSxXQUFXLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN2RSxNQUFNLENBQUM7SUFDWCxDQUFDO0lBRUQsSUFBTSxZQUFZLEdBQUcsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO0lBQ25ELGVBQWUsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFBLFdBQVc7UUFDckUsMkNBQTJDO1FBQzNDLFVBQVUsQ0FBQyxlQUFlLENBQUMsRUFBRSxHQUFHLEVBQUUsWUFBWSxDQUFDLEdBQUcsRUFBRSx3QkFBVyxFQUFFLENBQUMsQ0FBQztJQUN2RSxDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCxVQUFVLENBQUMsdUJBQXVCLENBQUMsVUFBQyxNQUFNO0lBQ3RDLHlDQUF5QztJQUN6QyxJQUFJLFVBQVUsR0FBRyxLQUFLLENBQUM7SUFDdkIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDO1FBQ3BCLEVBQUUsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3RCLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUNILEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7UUFDYixTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7SUFDbEQsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsSUFBTSxhQUFhLEdBQUcsMENBQXFCLENBQWUsRUFBRSxFQUFFLEVBQUUsRUFBRSxVQUFBLFFBQVEsSUFBSSxPQUFBLGVBQWUsQ0FBQyxpQkFBaUIsQ0FBQyxRQUFRLENBQUMsRUFBM0MsQ0FBMkMsQ0FBQyxDQUFDO0FBRTNILHlCQUF5QixRQUFzQjtJQUMzQyxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN2QyxDQUFDO0FBRUQsVUFBVSxDQUFDLFlBQVksQ0FBQyxVQUFBLG9CQUFvQjtJQUN4QyxJQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN0RSxJQUFNLFlBQVksR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDL0MsTUFBTSxDQUFNLGVBQWUsQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNsRyxDQUFDLENBQUMsQ0FBQztBQUVILFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxVQUFBLGNBQWM7SUFDekMsTUFBTSxDQUFNLGVBQWUsQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDMUQsQ0FBQyxDQUFDLENBQUM7QUFFSCxVQUFVLENBQUMsT0FBTyxDQUFDLFVBQUEsMEJBQTBCO0lBQ3pDLElBQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsMEJBQTBCLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzVFLElBQU0sWUFBWSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQyxNQUFNLENBQU0sZUFBZSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsMEJBQTBCLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxDQUFDO0FBQ3JHLENBQUMsQ0FBQyxDQUFDO0FBRUgsVUFBVSxDQUFDLGdCQUFnQixDQUFDLFVBQUEsb0JBQW9CO0lBQzVDLElBQU0sUUFBUSxHQUFHLFNBQVMsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RFLElBQU0sWUFBWSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQyxNQUFNLENBQUMsZUFBZSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUN2RSxDQUFDLENBQUMsQ0FBQztBQUVILFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxVQUFBLFlBQVk7SUFDeEMsSUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQzlELE1BQU0sQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxJQUFLLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3pFLENBQUMsQ0FBQyxDQUFDO0FBRUgsVUFBVSxDQUFDLHlCQUF5QixDQUFDLFVBQUEsWUFBWTtJQUM3QyxJQUFNLFFBQVEsR0FBRyxTQUFTLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDOUQsTUFBTSxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsUUFBUSxFQUFFLFlBQVksQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3RGLENBQUMsQ0FBQyxDQUFDO0FBRUgsMkJBQTJCO0FBQzNCLFVBQVUsQ0FBQyxNQUFNLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIEBsaWNlbnNlICAgTUlUXG4gKiAgQGNvcHlyaWdodCBPbW5pU2hhcnAgVGVhbVxuICogIEBzdW1tYXJ5ICAgQWRkcyBzdXBwb3J0IGZvciBodHRwczovL2dpdGh1Yi5jb20vTWljcm9zb2Z0L2xhbmd1YWdlLXNlcnZlci1wcm90b2NvbCAoYW5kIG1vcmUhKSB0byBodHRwczovL2F0b20uaW9cbiAqL1xuLyogdHNsaW50OmRpc2FibGU6bm8tZm9yLWluIGZvcmluICovXG5pbXBvcnQgKiBhcyBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgWEhSUmVzcG9uc2UsIGNvbmZpZ3VyZSBhcyBjb25maWd1cmVIdHRwUmVxdWVzdHMsIGdldEVycm9yU3RhdHVzRGVzY3JpcHRpb24sIHhociB9IGZyb20gJ3JlcXVlc3QtbGlnaHQnO1xuaW1wb3J0ICogYXMgVVJMIGZyb20gJ3VybCc7XG5pbXBvcnQgeyBKU09ORG9jdW1lbnQsIEpTT05TY2hlbWEsIExhbmd1YWdlU2V0dGluZ3MsIGdldExhbmd1YWdlU2VydmljZSB9IGZyb20gJ3ZzY29kZS1qc29uLWxhbmd1YWdlc2VydmljZSc7XG5pbXBvcnQgeyBJQ29ubmVjdGlvbiwgSVBDTWVzc2FnZVJlYWRlciwgSVBDTWVzc2FnZVdyaXRlciwgSW5pdGlhbGl6ZVBhcmFtcywgSW5pdGlhbGl6ZVJlc3VsdCwgTm90aWZpY2F0aW9uVHlwZSwgVGV4dERvY3VtZW50LCBUZXh0RG9jdW1lbnRzLCBjcmVhdGVDb25uZWN0aW9uIH0gZnJvbSAndnNjb2RlLWxhbmd1YWdlc2VydmVyJztcbmltcG9ydCB7IGdldERlZmF1bHRzIH0gZnJvbSAnLi9kZWZhdWx0LXZhbGlkYXRpb25zJztcbmltcG9ydCB7IEdsb2JQYXR0ZXJuQ29udHJpYnV0aW9uIH0gZnJvbSAnLi9qc29uY29udHJpYnV0aW9ucy9nbG9iUGF0dGVybkNvbnRyaWJ1dGlvbic7XG5pbXBvcnQgeyBnZXRMYW5ndWFnZU1vZGVsQ2FjaGUgfSBmcm9tICcuL2xhbmd1YWdlTW9kZWxDYWNoZSc7XG5pbXBvcnQgeyBQcm9qZWN0SlNPTkNvbnRyaWJ1dGlvbiB9IGZyb20gJy4vanNvbmNvbnRyaWJ1dGlvbnMvcHJvamVjdEpTT05Db250cmlidXRpb24nO1xuaW1wb3J0IFVSSSBmcm9tICcuL3V0aWxzL3VyaSc7XG5cbm5hbWVzcGFjZSBTY2hlbWFBc3NvY2lhdGlvbk5vdGlmaWNhdGlvbiB7XG4gICAgZXhwb3J0IGNvbnN0IHR5cGU6IE5vdGlmaWNhdGlvblR5cGU8SnNvbi5TY2hlbWFBc3NvY2lhdGlvbnM+ID0geyBnZXQgbWV0aG9kKCkgeyByZXR1cm4gJ2pzb24vc2NoZW1hQXNzb2NpYXRpb25zJzsgfSB9O1xufVxuXG4vLyBDcmVhdGUgYSBjb25uZWN0aW9uIGZvciB0aGUgc2VydmVyXG5jb25zdCBjb25uZWN0aW9uOiBJQ29ubmVjdGlvbiA9IGNyZWF0ZUNvbm5lY3Rpb24obmV3IElQQ01lc3NhZ2VSZWFkZXIocHJvY2VzcyksIG5ldyBJUENNZXNzYWdlV3JpdGVyKHByb2Nlc3MpKTtcblxuY29uc29sZS5sb2cgPSBjb25uZWN0aW9uLmNvbnNvbGUubG9nLmJpbmQoY29ubmVjdGlvbi5jb25zb2xlKTtcbmNvbnNvbGUuZXJyb3IgPSBjb25uZWN0aW9uLmNvbnNvbGUuZXJyb3IuYmluZChjb25uZWN0aW9uLmNvbnNvbGUpO1xuXG4vLyBDcmVhdGUgYSBzaW1wbGUgdGV4dCBkb2N1bWVudCBtYW5hZ2VyLiBUaGUgdGV4dCBkb2N1bWVudCBtYW5hZ2VyXG4vLyBzdXBwb3J0cyBmdWxsIGRvY3VtZW50IHN5bmMgb25seVxuY29uc3QgZG9jdW1lbnRzOiBUZXh0RG9jdW1lbnRzID0gbmV3IFRleHREb2N1bWVudHMoKTtcbi8vIE1ha2UgdGhlIHRleHQgZG9jdW1lbnQgbWFuYWdlciBsaXN0ZW4gb24gdGhlIGNvbm5lY3Rpb25cbi8vIGZvciBvcGVuLCBjaGFuZ2UgYW5kIGNsb3NlIHRleHQgZG9jdW1lbnQgZXZlbnRzXG5kb2N1bWVudHMubGlzdGVuKGNvbm5lY3Rpb24pO1xuXG4vLyBBZnRlciB0aGUgc2VydmVyIGhhcyBzdGFydGVkIHRoZSBjbGllbnQgc2VuZHMgYW4gaW5pdGlsaXplIHJlcXVlc3QuIFRoZSBzZXJ2ZXIgcmVjZWl2ZXNcbi8vIGluIHRoZSBwYXNzZWQgcGFyYW1zIHRoZSByb290UGF0aCBvZiB0aGUgd29ya3NwYWNlIHBsdXMgdGhlIGNsaWVudCBjYXBhYmlsaXRlcy5cbmxldCB3b3Jrc3BhY2VSb290OiBVUkk7XG5jb25uZWN0aW9uLm9uSW5pdGlhbGl6ZSgocGFyYW1zOiBJbml0aWFsaXplUGFyYW1zKTogSW5pdGlhbGl6ZVJlc3VsdCA9PiB7XG4gICAgd29ya3NwYWNlUm9vdCA9IFVSSS5wYXJzZShwYXJhbXMucm9vdFBhdGgpO1xuICAgIHJldHVybiB7XG4gICAgICAgIGNhcGFiaWxpdGllczoge1xuICAgICAgICAgICAgLy8gVGVsbCB0aGUgY2xpZW50IHRoYXQgdGhlIHNlcnZlciB3b3JrcyBpbiBGVUxMIHRleHQgZG9jdW1lbnQgc3luYyBtb2RlXG4gICAgICAgICAgICB0ZXh0RG9jdW1lbnRTeW5jOiBkb2N1bWVudHMuc3luY0tpbmQsXG4gICAgICAgICAgICBjb21wbGV0aW9uUHJvdmlkZXI6IHsgcmVzb2x2ZVByb3ZpZGVyOiB0cnVlIH0sXG4gICAgICAgICAgICBob3ZlclByb3ZpZGVyOiB0cnVlLFxuICAgICAgICAgICAgZG9jdW1lbnRTeW1ib2xQcm92aWRlcjogdHJ1ZSxcbiAgICAgICAgICAgIGRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nUHJvdmlkZXI6IHRydWUsXG4gICAgICAgICAgICBkb2N1bWVudEZvcm1hdHRpbmdQcm92aWRlcjogdHJ1ZVxuICAgICAgICB9XG4gICAgfTtcbn0pO1xuXG5jb25zdCB3b3Jrc3BhY2VDb250ZXh0ID0ge1xuICAgIHJlc29sdmVSZWxhdGl2ZVBhdGg6IChyZWxhdGl2ZVBhdGg6IHN0cmluZywgcmVzb3VyY2U6IHN0cmluZykgPT4ge1xuICAgICAgICByZXR1cm4gVVJMLnJlc29sdmUocmVzb3VyY2UsIHJlbGF0aXZlUGF0aCk7XG4gICAgfVxufTtcblxuY29uc3Qgc2NoZW1hUmVxdWVzdFNlcnZpY2UgPSAodXJpOiBzdHJpbmcpOiBUaGVuYWJsZTxzdHJpbmc+ID0+IHtcbiAgICBpZiAoXy5zdGFydHNXaXRoKHVyaSwgJ2ZpbGU6Ly8nKSkge1xuICAgICAgICBjb25zdCBmc1BhdGggPSBVUkkucGFyc2UodXJpKS5mc1BhdGg7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxzdHJpbmc+KChjLCBlKSA9PiB7XG4gICAgICAgICAgICBmcy5yZWFkRmlsZShmc1BhdGgsICdVVEYtOCcsIChlcnIsIHJlc3VsdCkgPT4ge1xuICAgICAgICAgICAgICAgIGVyciA/IGUoJycpIDogYyhyZXN1bHQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiB4aHIoeyB1cmw6IHVyaSwgZm9sbG93UmVkaXJlY3RzOiA1IH0pXG4gICAgICAgIC50aGVuKFxuICAgICAgICByZXNwb25zZSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVzcG9uc2VUZXh0O1xuICAgICAgICB9LFxuICAgICAgICAoZXJyb3I6IFhIUlJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gZXJyb3IucmVzcG9uc2VUZXh0IHx8IGdldEVycm9yU3RhdHVzRGVzY3JpcHRpb24oZXJyb3Iuc3RhdHVzKSB8fCBlcnJvci50b1N0cmluZygpO1xuICAgICAgICB9KTtcbn07XG5cbi8vIGNyZWF0ZSB0aGUgSlNPTiBsYW5ndWFnZSBzZXJ2aWNlXG5jb25zdCBsYW5ndWFnZVNlcnZpY2UgPSBnZXRMYW5ndWFnZVNlcnZpY2Uoe1xuICAgIHNjaGVtYVJlcXVlc3RTZXJ2aWNlLFxuICAgIHdvcmtzcGFjZUNvbnRleHQsXG4gICAgY29udHJpYnV0aW9uczogW1xuICAgICAgICBuZXcgUHJvamVjdEpTT05Db250cmlidXRpb24oKSxcbiAgICAgICAgbmV3IEdsb2JQYXR0ZXJuQ29udHJpYnV0aW9uKClcbiAgICBdXG59KTtcblxuLy8gVGhlIHNldHRpbmdzIGludGVyZmFjZSBkZXNjcmliZXMgdGhlIHNlcnZlciByZWxldmFudCBzZXR0aW5ncyBwYXJ0XG5pbnRlcmZhY2UgU2V0dGluZ3Mge1xuICAgIGpzb246IHtcbiAgICAgICAgc2NoZW1hczogSlNPTlNjaGVtYVNldHRpbmdzW107XG4gICAgfTtcbiAgICBodHRwOiB7XG4gICAgICAgIHByb3h5OiBzdHJpbmc7XG4gICAgICAgIHByb3h5U3RyaWN0U1NMOiBib29sZWFuO1xuICAgIH07XG59XG5cbmludGVyZmFjZSBKU09OU2NoZW1hU2V0dGluZ3Mge1xuICAgIGZpbGVNYXRjaD86IHN0cmluZ1tdO1xuICAgIHVybD86IHN0cmluZztcbiAgICBzY2hlbWE/OiBKU09OU2NoZW1hO1xufVxuXG5sZXQganNvbkNvbmZpZ3VyYXRpb25TZXR0aW5nczogSlNPTlNjaGVtYVNldHRpbmdzW10gfCB1bmRlZmluZWQgPSB2b2lkIDA7XG5sZXQgc2NoZW1hQXNzb2NpYXRpb25zOiBKc29uLlNjaGVtYUFzc29jaWF0aW9ucyB8IHVuZGVmaW5lZCA9IHZvaWQgMDtcbmxldCBkZWZhdWx0QXNzb2NpYXRpb25zOiBKc29uLlNjaGVtYUFzc29jaWF0aW9ucyB8IHVuZGVmaW5lZCA9IHZvaWQgMDtcblxuLy8gVGhlIHNldHRpbmdzIGhhdmUgY2hhbmdlZC4gSXMgc2VuZCBvbiBzZXJ2ZXIgYWN0aXZhdGlvbiBhcyB3ZWxsLlxuY29ubmVjdGlvbi5vbkRpZENoYW5nZUNvbmZpZ3VyYXRpb24oKGNoYW5nZSkgPT4ge1xuICAgIGNvbnN0IHNldHRpbmdzID0gPFNldHRpbmdzPmNoYW5nZS5zZXR0aW5ncztcbiAgICBjb25maWd1cmVIdHRwUmVxdWVzdHMoc2V0dGluZ3MuaHR0cCAmJiBzZXR0aW5ncy5odHRwLnByb3h5LCBzZXR0aW5ncy5odHRwICYmIHNldHRpbmdzLmh0dHAucHJveHlTdHJpY3RTU0wpO1xuXG4gICAganNvbkNvbmZpZ3VyYXRpb25TZXR0aW5ncyA9IHNldHRpbmdzLmpzb24gJiYgc2V0dGluZ3MuanNvbi5zY2hlbWFzO1xuICAgIHVwZGF0ZUNvbmZpZ3VyYXRpb24oKTtcbn0pO1xuXG4vLyBUaGUganNvblZhbGlkYXRpb24gZXh0ZW5zaW9uIGNvbmZpZ3VyYXRpb24gaGFzIGNoYW5nZWRcbmNvbm5lY3Rpb24ub25Ob3RpZmljYXRpb24oU2NoZW1hQXNzb2NpYXRpb25Ob3RpZmljYXRpb24udHlwZSwgYXNzb2NpYXRpb25zID0+IHtcbiAgICBzY2hlbWFBc3NvY2lhdGlvbnMgPSBhc3NvY2lhdGlvbnM7XG4gICAgdXBkYXRlQ29uZmlndXJhdGlvbigpO1xufSk7XG5cbmZ1bmN0aW9uIHVwZGF0ZUNvbmZpZ3VyYXRpb24oKSB7XG4gICAgY29uc3QgbGFuZ3VhZ2VTZXR0aW5nczogTGFuZ3VhZ2VTZXR0aW5ncyA9IHtcbiAgICAgICAgdmFsaWRhdGU6IHRydWUsXG4gICAgICAgIGFsbG93Q29tbWVudHM6IHRydWUsXG4gICAgICAgIHNjaGVtYXM6IFtdXG4gICAgfTtcbiAgICBpZiAoc2NoZW1hQXNzb2NpYXRpb25zKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGF0dGVybiBpbiBzY2hlbWFBc3NvY2lhdGlvbnMpIHtcbiAgICAgICAgICAgIGNvbnN0IGFzc29jaWF0aW9uID0gc2NoZW1hQXNzb2NpYXRpb25zW3BhdHRlcm5dO1xuICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoYXNzb2NpYXRpb24pKSB7XG4gICAgICAgICAgICAgICAgYXNzb2NpYXRpb24uZm9yRWFjaCh1cmkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBsYW5ndWFnZVNldHRpbmdzLnNjaGVtYXMhLnB1c2goeyB1cmksIGZpbGVNYXRjaDogW3BhdHRlcm5dIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIGlmIChkZWZhdWx0QXNzb2NpYXRpb25zKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGF0dGVybiBpbiBkZWZhdWx0QXNzb2NpYXRpb25zKSB7XG4gICAgICAgICAgICBjb25zdCBhc3NvY2lhdGlvbiA9IGRlZmF1bHRBc3NvY2lhdGlvbnNbcGF0dGVybl07XG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShhc3NvY2lhdGlvbikpIHtcbiAgICAgICAgICAgICAgICBhc3NvY2lhdGlvbi5mb3JFYWNoKHVyaSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxhbmd1YWdlU2V0dGluZ3Muc2NoZW1hcyEucHVzaCh7IHVyaSwgZmlsZU1hdGNoOiBbcGF0dGVybl0gfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgaWYgKGpzb25Db25maWd1cmF0aW9uU2V0dGluZ3MpIHtcbiAgICAgICAganNvbkNvbmZpZ3VyYXRpb25TZXR0aW5ncy5mb3JFYWNoKHNjaGVtYSA9PiB7XG4gICAgICAgICAgICBsZXQgdXJpID0gc2NoZW1hLnVybDtcbiAgICAgICAgICAgIGlmICghdXJpICYmIHNjaGVtYS5zY2hlbWEpIHtcbiAgICAgICAgICAgICAgICB1cmkgPSBzY2hlbWEuc2NoZW1hLmlkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHVyaSkge1xuICAgICAgICAgICAgICAgIGlmICh1cmlbMF0gPT09ICcuJyAmJiB3b3Jrc3BhY2VSb290KSB7XG4gICAgICAgICAgICAgICAgICAgIC8vIHdvcmtzcGFjZSByZWxhdGl2ZSBwYXRoXG4gICAgICAgICAgICAgICAgICAgIHVyaSA9IFVSSS5maWxlKHBhdGgubm9ybWFsaXplKHBhdGguam9pbih3b3Jrc3BhY2VSb290LmZzUGF0aCwgdXJpKSkpLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGxhbmd1YWdlU2V0dGluZ3Muc2NoZW1hcyEucHVzaCh7IHVyaSwgZmlsZU1hdGNoOiBzY2hlbWEuZmlsZU1hdGNoLCBzY2hlbWE6IHNjaGVtYS5zY2hlbWEgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBsYW5ndWFnZVNlcnZpY2UuY29uZmlndXJlKGxhbmd1YWdlU2V0dGluZ3MpO1xuXG4gICAgaWYgKCFkZWZhdWx0QXNzb2NpYXRpb25zKSB7XG4gICAgICAgIGdldERlZmF1bHRzKCkudGhlbihcbiAgICAgICAgICAgIGFzc29jaWF0aW9ucyA9PiB7XG4gICAgICAgICAgICAgICAgZGVmYXVsdEFzc29jaWF0aW9ucyA9IGFzc29jaWF0aW9ucztcbiAgICAgICAgICAgICAgICB1cGRhdGVDb25maWd1cmF0aW9uKCk7XG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgKCkgPT4geyAvKiAqLyB9KTtcbiAgICB9XG5cbiAgICBjb25uZWN0aW9uLnNlbmROb3RpZmljYXRpb24oeyAgbWV0aG9kOiBcImFiY1wiIH0sIGxhbmd1YWdlU2V0dGluZ3MpO1xuXG4gICAgLy8gUmV2YWxpZGF0ZSBhbnkgb3BlbiB0ZXh0IGRvY3VtZW50c1xuICAgIGRvY3VtZW50cy5hbGwoKS5mb3JFYWNoKHRyaWdnZXJWYWxpZGF0aW9uKTtcbn1cblxuLy8gVGhlIGNvbnRlbnQgb2YgYSB0ZXh0IGRvY3VtZW50IGhhcyBjaGFuZ2VkLiBUaGlzIGV2ZW50IGlzIGVtaXR0ZWRcbi8vIHdoZW4gdGhlIHRleHQgZG9jdW1lbnQgZmlyc3Qgb3BlbmVkIG9yIHdoZW4gaXRzIGNvbnRlbnQgaGFzIGNoYW5nZWQuXG5kb2N1bWVudHMub25EaWRDaGFuZ2VDb250ZW50KChjaGFuZ2UpID0+IHtcbiAgICB0cmlnZ2VyVmFsaWRhdGlvbihjaGFuZ2UuZG9jdW1lbnQpO1xufSk7XG5cbi8vIGEgZG9jdW1lbnQgaGFzIGNsb3NlZDogY2xlYXIgYWxsIGRpYWdub3N0aWNzXG5kb2N1bWVudHMub25EaWRDbG9zZShldmVudCA9PiB7XG4gICAgY2xlYW5QZW5kaW5nVmFsaWRhdGlvbihldmVudC5kb2N1bWVudCk7XG4gICAgY29ubmVjdGlvbi5zZW5kRGlhZ25vc3RpY3MoeyB1cmk6IGV2ZW50LmRvY3VtZW50LnVyaSwgZGlhZ25vc3RpY3M6IFtdIH0pO1xufSk7XG5cbmNvbnN0IHBlbmRpbmdWYWxpZGF0aW9uUmVxdWVzdHM6IHsgW3VyaTogc3RyaW5nXTogTm9kZUpTLlRpbWVyOyB9ID0ge307XG5jb25zdCB2YWxpZGF0aW9uRGVsYXlNcyA9IDIwMDtcblxuZnVuY3Rpb24gY2xlYW5QZW5kaW5nVmFsaWRhdGlvbih0ZXh0RG9jdW1lbnQ6IFRleHREb2N1bWVudCk6IHZvaWQge1xuICAgIGNvbnN0IHJlcXVlc3QgPSBwZW5kaW5nVmFsaWRhdGlvblJlcXVlc3RzW3RleHREb2N1bWVudC51cmldO1xuICAgIGlmIChyZXF1ZXN0KSB7XG4gICAgICAgIGNsZWFyVGltZW91dChyZXF1ZXN0KTtcbiAgICAgICAgZGVsZXRlIHBlbmRpbmdWYWxpZGF0aW9uUmVxdWVzdHNbdGV4dERvY3VtZW50LnVyaV07XG4gICAgfVxufVxuXG5mdW5jdGlvbiB0cmlnZ2VyVmFsaWRhdGlvbih0ZXh0RG9jdW1lbnQ6IFRleHREb2N1bWVudCk6IHZvaWQge1xuICAgIGNsZWFuUGVuZGluZ1ZhbGlkYXRpb24odGV4dERvY3VtZW50KTtcbiAgICBwZW5kaW5nVmFsaWRhdGlvblJlcXVlc3RzW3RleHREb2N1bWVudC51cmldID0gc2V0VGltZW91dChcbiAgICAgICAgKCkgPT4ge1xuICAgICAgICAgICAgZGVsZXRlIHBlbmRpbmdWYWxpZGF0aW9uUmVxdWVzdHNbdGV4dERvY3VtZW50LnVyaV07XG4gICAgICAgICAgICB2YWxpZGF0ZVRleHREb2N1bWVudCh0ZXh0RG9jdW1lbnQpO1xuICAgICAgICB9LFxuICAgICAgICB2YWxpZGF0aW9uRGVsYXlNcyk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlVGV4dERvY3VtZW50KHRleHREb2N1bWVudDogVGV4dERvY3VtZW50KTogdm9pZCB7XG4gICAgaWYgKHRleHREb2N1bWVudC5nZXRUZXh0KCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIC8vIGlnbm9yZSBlbXB0eSBkb2N1bWVudHNcbiAgICAgICAgY29ubmVjdGlvbi5zZW5kRGlhZ25vc3RpY3MoeyB1cmk6IHRleHREb2N1bWVudC51cmksIGRpYWdub3N0aWNzOiBbXSB9KTtcbiAgICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGpzb25Eb2N1bWVudCA9IGdldEpTT05Eb2N1bWVudCh0ZXh0RG9jdW1lbnQpO1xuICAgIGxhbmd1YWdlU2VydmljZS5kb1ZhbGlkYXRpb24odGV4dERvY3VtZW50LCBqc29uRG9jdW1lbnQpLnRoZW4oZGlhZ25vc3RpY3MgPT4ge1xuICAgICAgICAvLyBTZW5kIHRoZSBjb21wdXRlZCBkaWFnbm9zdGljcyB0byBWU0NvZGUuXG4gICAgICAgIGNvbm5lY3Rpb24uc2VuZERpYWdub3N0aWNzKHsgdXJpOiB0ZXh0RG9jdW1lbnQudXJpLCBkaWFnbm9zdGljcyB9KTtcbiAgICB9KTtcbn1cblxuY29ubmVjdGlvbi5vbkRpZENoYW5nZVdhdGNoZWRGaWxlcygoY2hhbmdlKSA9PiB7XG4gICAgLy8gTW9uaXRvcmVkIGZpbGVzIGhhdmUgY2hhbmdlZCBpbiBWU0NvZGVcbiAgICBsZXQgaGFzQ2hhbmdlcyA9IGZhbHNlO1xuICAgIGNoYW5nZS5jaGFuZ2VzLmZvckVhY2goYyA9PiB7XG4gICAgICAgIGlmIChsYW5ndWFnZVNlcnZpY2UucmVzZXRTY2hlbWEoYy51cmkpKSB7XG4gICAgICAgICAgICBoYXNDaGFuZ2VzID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChoYXNDaGFuZ2VzKSB7XG4gICAgICAgIGRvY3VtZW50cy5hbGwoKS5mb3JFYWNoKHZhbGlkYXRlVGV4dERvY3VtZW50KTtcbiAgICB9XG59KTtcblxuY29uc3QganNvbkRvY3VtZW50cyA9IGdldExhbmd1YWdlTW9kZWxDYWNoZTxKU09ORG9jdW1lbnQ+KDEwLCA2MCwgZG9jdW1lbnQgPT4gbGFuZ3VhZ2VTZXJ2aWNlLnBhcnNlSlNPTkRvY3VtZW50KGRvY3VtZW50KSk7XG5cbmZ1bmN0aW9uIGdldEpTT05Eb2N1bWVudChkb2N1bWVudDogVGV4dERvY3VtZW50KTogSlNPTkRvY3VtZW50IHtcbiAgICByZXR1cm4ganNvbkRvY3VtZW50cy5nZXQoZG9jdW1lbnQpO1xufVxuXG5jb25uZWN0aW9uLm9uQ29tcGxldGlvbih0ZXh0RG9jdW1lbnRQb3NpdGlvbiA9PiB7XG4gICAgY29uc3QgZG9jdW1lbnQgPSBkb2N1bWVudHMuZ2V0KHRleHREb2N1bWVudFBvc2l0aW9uLnRleHREb2N1bWVudC51cmkpO1xuICAgIGNvbnN0IGpzb25Eb2N1bWVudCA9IGdldEpTT05Eb2N1bWVudChkb2N1bWVudCk7XG4gICAgcmV0dXJuIDxhbnk+bGFuZ3VhZ2VTZXJ2aWNlLmRvQ29tcGxldGUoZG9jdW1lbnQsIHRleHREb2N1bWVudFBvc2l0aW9uLnBvc2l0aW9uLCBqc29uRG9jdW1lbnQpO1xufSk7XG5cbmNvbm5lY3Rpb24ub25Db21wbGV0aW9uUmVzb2x2ZShjb21wbGV0aW9uSXRlbSA9PiB7XG4gICAgcmV0dXJuIDxhbnk+bGFuZ3VhZ2VTZXJ2aWNlLmRvUmVzb2x2ZShjb21wbGV0aW9uSXRlbSk7XG59KTtcblxuY29ubmVjdGlvbi5vbkhvdmVyKHRleHREb2N1bWVudFBvc2l0aW9uUGFyYW1zID0+IHtcbiAgICBjb25zdCBkb2N1bWVudCA9IGRvY3VtZW50cy5nZXQodGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMudGV4dERvY3VtZW50LnVyaSk7XG4gICAgY29uc3QganNvbkRvY3VtZW50ID0gZ2V0SlNPTkRvY3VtZW50KGRvY3VtZW50KTtcbiAgICByZXR1cm4gPGFueT5sYW5ndWFnZVNlcnZpY2UuZG9Ib3Zlcihkb2N1bWVudCwgdGV4dERvY3VtZW50UG9zaXRpb25QYXJhbXMucG9zaXRpb24sIGpzb25Eb2N1bWVudCk7XG59KTtcblxuY29ubmVjdGlvbi5vbkRvY3VtZW50U3ltYm9sKGRvY3VtZW50U3ltYm9sUGFyYW1zID0+IHtcbiAgICBjb25zdCBkb2N1bWVudCA9IGRvY3VtZW50cy5nZXQoZG9jdW1lbnRTeW1ib2xQYXJhbXMudGV4dERvY3VtZW50LnVyaSk7XG4gICAgY29uc3QganNvbkRvY3VtZW50ID0gZ2V0SlNPTkRvY3VtZW50KGRvY3VtZW50KTtcbiAgICByZXR1cm4gbGFuZ3VhZ2VTZXJ2aWNlLmZpbmREb2N1bWVudFN5bWJvbHMoZG9jdW1lbnQsIGpzb25Eb2N1bWVudCk7XG59KTtcblxuY29ubmVjdGlvbi5vbkRvY3VtZW50Rm9ybWF0dGluZyhmb3JtYXRQYXJhbXMgPT4ge1xuICAgIGNvbnN0IGRvY3VtZW50ID0gZG9jdW1lbnRzLmdldChmb3JtYXRQYXJhbXMudGV4dERvY3VtZW50LnVyaSk7XG4gICAgcmV0dXJuIGxhbmd1YWdlU2VydmljZS5mb3JtYXQoZG9jdW1lbnQsIG51bGwhLCBmb3JtYXRQYXJhbXMub3B0aW9ucyk7XG59KTtcblxuY29ubmVjdGlvbi5vbkRvY3VtZW50UmFuZ2VGb3JtYXR0aW5nKGZvcm1hdFBhcmFtcyA9PiB7XG4gICAgY29uc3QgZG9jdW1lbnQgPSBkb2N1bWVudHMuZ2V0KGZvcm1hdFBhcmFtcy50ZXh0RG9jdW1lbnQudXJpKTtcbiAgICByZXR1cm4gbGFuZ3VhZ2VTZXJ2aWNlLmZvcm1hdChkb2N1bWVudCwgZm9ybWF0UGFyYW1zLnJhbmdlLCBmb3JtYXRQYXJhbXMub3B0aW9ucyk7XG59KTtcblxuLy8gTGlzdGVuIG9uIHRoZSBjb25uZWN0aW9uXG5jb25uZWN0aW9uLmxpc3RlbigpO1xuIl19